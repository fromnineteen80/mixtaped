<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Mixtaped">
    <meta name="theme-color" id="meta-theme" content="#F5F5F4">
    <title>Mixtaped</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,200..500,0,0&icon_names=add,album,check,check_circle,close,content_copy,dashboard_customize,delete,dining,directions_car,directions_run,drag_indicator,edit_square,first_page,format_image_left,format_paint,grid_view,headphones,heart_check,keyboard_arrow_down,keyboard_arrow_up,local_cafe,lock,mail,menu,mindfulness,music_note,music_note_2,page_info,person,person_heart,phone_iphone,play_arrow,podcasts,radio,save,star,thumbnail_bar,tooltip_2">
    
    <style>
        /* ============================================
           MIXTAPED - Spotify Playlists Shared
           Â© 2025 fromnineteen80. All rights reserved.
           ============================================ */

        /* --------------------------------------------
           RESET & ROOT VARIABLES
           -------------------------------------------- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            /* Safe areas */
            --safe-t: env(safe-area-inset-top, 0px);
            --safe-b: env(safe-area-inset-bottom, 0px);
            --safe-l: env(safe-area-inset-left, 0px);
            --safe-r: env(safe-area-inset-right, 0px);
        }

        /* --------------------------------------------
           THEME: LIGHT (Default)
           -------------------------------------------- */
        body {
            --bg: #F5F5F4;
            --card: #FEFEFE;
            --input: #F0F0EF;
            --text: #1DB954;
            --text2: #6B6B6B;
            --text3: #A3A3A3;
            --accent: #1DB954;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --placeholder-bg: var(--card);
            --sidebar-bg: #ECECEB;
            
            /* Spacing */
            --gap: 16px;
            --padding: 20px;
            
            /* Typography - Mobile first */
            --font-body: 16px;
            --font-card: 13px;
            --font-small: 13px;
            --font-input: 13px;
            --font-heading: 18px;
            --font-menu: 13px;
            --font-button: 15px;
            --font-sidebar: 13px;
            --line-height: 1.5;
            
            /* Radius */
            --radius-lg: 14px;
            --radius-md: 12px;
            --radius-sm: 10px;
            --radius-xs: 8px;
            
            /* Layout - Universal widths */
            --min-width: 320px;
            --max-width: 600px;
        }

        /* --------------------------------------------
           THEME: DARK
           -------------------------------------------- */
        body[data-theme="dark"] {
            --bg: #1E1E1E;
            --card: #222222;
            --input: #2E2E2E;
            --text: #E8E8E8;
            --text2: #8C8C8C;
            --text3: #737373;
            --accent: #E8E8E8;
            --shadow: 0 4px 16px rgba(0,0,0,0.25);
            --placeholder-bg: var(--card);
            --sidebar-bg: #1C1C1C;
        }

        /* THEME: LIGHT (Explicit) */
        body[data-theme="light"] {
            --bg: #F5F5F4;
            --card: #FEFEFE;
            --input: #F0F0EF;
            --text: #1DB954;
            --text2: #6B6B6B;
            --text3: #A3A3A3;
            --accent: #1DB954;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --placeholder-bg: var(--card);
            --sidebar-bg: #ECECEB;
        }

        /* THEME: SPOTIFY (Green sidebar) */
        body[data-theme="spotify"] {
            --bg: #ECECEB;
            --card: #FEFEFE;
            --input: #F0F0EF;
            --text: #1DB954;
            --text2: #6B6B6B;
            --text3: #A3A3A3;
            --accent: #1DB954;
            --shadow: 0 2px 12px rgba(0,0,0,0.06);
            --placeholder-bg: var(--card);
            --sidebar-bg: #1DB954;
        }

        /* Typography - Desktop overrides */
        @media (min-width: 768px) {
            :root {
                --font-body: 16px;
                --font-card: 13px;
                --font-small: 11px;
                --font-input: 13px;
                --font-heading: 16px;
                --font-button: 14px;
                --font-sidebar: 13px;
            }
        }

        /* --------------------------------------------
           BASE STYLES
           -------------------------------------------- */
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: fixed;
            width: 100%;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .material-symbols-outlined {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-weight: 300;
        }

        /* App container - handles safe areas */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--gap);
            padding-top: calc(var(--safe-t) + var(--gap));
            padding-bottom: calc(var(--safe-b) + var(--gap));
            padding-left: calc(var(--safe-l) + var(--gap));
            padding-right: calc(var(--safe-r) + var(--gap));
        }

        /* --------------------------------------------
           LAYOUT: WRAPPER & HEADER
           -------------------------------------------- */
        .wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header - matches grid width, centered */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 44px;
            margin-bottom: var(--gap);
            flex-shrink: 0;
            width: var(--grid-width, 100%);
            margin-left: auto;
            margin-right: auto;
        }

        .title {
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--text2);
            cursor: pointer;
        }

        /* --------------------------------------------
           MOBILE MENU (Dropdown)
           -------------------------------------------- */
        .dropdown {
            position: relative;
        }
        
        /* Hamburger menu button */
        .menu-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--text2);
            display: flex;
            align-items: center;
        }
        .menu-btn .material-symbols-outlined {
            font-size: 20px;
        }
        .menu-btn:active { opacity: 0.5; }
        
        /* Dropdown content */
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow), 0 4px 20px rgba(0,0,0,0.15);
            padding: 4px 0;
            min-width: 140px;
            max-width: 220px;
            z-index: 100;
        }
        .dropdown-content.open { display: block; }
        
        .menu-item {
            display: block;
            width: 100%;
            padding: 6px 16px;
            text-align: left;
            font-size: var(--font-menu);
            font-family: inherit;
            color: var(--text2);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        .menu-item:hover { background: #F0F0EF; }
        .menu-item:active { background: #E6E6E5; }
        [data-theme="dark"] .menu-item:hover { background: #2C2C2C; }
        [data-theme="dark"] .menu-item:active { background: #333333; }
        
        .menu-divider {
            height: 1px;
            background: var(--input);
            margin: 4px 0;
        }
        
        .menu-label {
            padding: 6px 16px;
            font-size: var(--font-menu);
            color: var(--text2);
        }
        
        .menu-collapse {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        
        .menu-collapse:active {
            background: var(--input);
        }
        
        .menu-collapse-arrow {
            transition: transform 0.2s ease;
        }
        
        .menu-collapse.open .menu-collapse-arrow {
            transform: rotate(180deg);
        }
        
        .mixtapes-list {
            display: none;
        }
        
        .mixtapes-list.open {
            display: block;
        }
        
        .menu-footer {
            display: flex;
            gap: 8px;
            padding: 6px 16px 8px;
        }
        
        .menu-footer-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--input);
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text2);
            text-decoration: none;
            cursor: pointer;
        }
        
        .menu-footer-btn .material-symbols-outlined {
            font-size: 18px;
        }
        
        .menu-footer-btn:active {
            opacity: 0.5;
        }
        
        .dropdown-content .themes {
            justify-content: center;
            padding: 10px 16px 6px;
        }
        
        .dropdown-content .menu-footer {
            justify-content: center;
            padding: 6px 16px 10px;
        }
        
        /* Menu profile section (dropdown) */
        .menu-profile-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px 16px;
        }
        
        .menu-profile-clickable {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .menu-profile-clickable:hover {
            opacity: 0.8;
        }
        
        .menu-profile-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #161616;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .menu-profile-avatar .material-symbols-outlined {
            font-size: 16px;
            color: #F5F5F4;
        }
        
        .menu-profile-avatar .avatar-letter {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #F5F5F4;
        }
        
        /* Dark theme menu avatar */
        [data-theme="dark"] .menu-profile-avatar {
            background: #F0F0EF;
        }
        
        [data-theme="dark"] .menu-profile-avatar .material-symbols-outlined {
            color: #4A4A4A;
        }
        
        [data-theme="dark"] .menu-profile-avatar .avatar-letter {
            color: #4A4A4A;
        }
        
        .menu-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .menu-profile-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }
        
        .menu-profile-text {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }
        
        .menu-profile-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--text2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .menu-profile-username {
            font-size: 11px;
            font-style: italic;
            color: var(--text2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .menu-profile-links {
            display: flex;
            gap: 8px;
            padding-left: 38px;
        }
        
        .menu-profile-link {
            color: var(--text2);
            text-decoration: none;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-profile-link .material-symbols-outlined {
            font-size: 16px;
        }
        
        .menu-profile-link:hover {
            color: var(--text);
        }
        
        /* Mobile profile section (more menu) */
        .mobile-profile-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
        }
        
        .mobile-profile-section:active {
            opacity: 0.6;
        }
        
        .mobile-profile-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--input);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .mobile-profile-avatar .material-symbols-outlined {
            font-size: 16px;
        }
        
        .mobile-profile-avatar .avatar-letter {
            font-size: 12px;
            font-weight: 700;
            color: var(--text);
            text-transform: uppercase;
        }
        
        .mobile-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mobile-profile-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
        }
        
        .mobile-profile-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mobile-profile-username {
            font-size: 12px;
            font-style: italic;
            color: var(--text2);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Theme buttons */
        .themes {
            display: flex;
            gap: 8px;
        }

        .theme-btn {
            width: 24px !important;
            height: 24px !important;
            min-width: 24px;
            min-height: 24px;
            max-width: 24px;
            max-height: 24px;
            border-radius: 6px;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-sizing: border-box;
        }
        
        .theme-btn .material-symbols-outlined {
            font-size: 18px;
            line-height: 1;
        }

        .theme-btn:active { opacity: 0.6; }
        .theme-btn.on { border-color: #1DB954; }
        .theme-btn[data-t="dark"] { background: #161616; }
        .theme-btn[data-t="dark"] .material-symbols-outlined { color: #BFBFBF; }
        .theme-btn[data-t="light"] { background: #F5F5F4; box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1); }
        .theme-btn[data-t="light"] .material-symbols-outlined { color: #4A4A4A; }
        .theme-btn[data-t="spotify"] { background: #1DB954; }
        .theme-btn[data-t="spotify"] .material-symbols-outlined { color: #ECECEB; }
        
        /* Profile page theme picker - rebuilt from scratch */
        .profile-theme-picker {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 24px auto 48px;
            width: 100%;
        }
        
        .profile-theme-picker-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1.5px solid transparent;
            cursor: pointer;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .profile-theme-picker-btn .material-symbols-outlined {
            font-size: 16px;
            line-height: 1;
        }
        
        /* Light button - always green border */
        .profile-theme-picker-btn[data-theme="light"] {
            background-color: #F5F5F4;
            border-color: #1DB954;
        }
        .profile-theme-picker-btn[data-theme="light"] .material-symbols-outlined {
            color: #4A4A4A;
        }
        
        /* Dark button - always light color border */
        .profile-theme-picker-btn[data-theme="dark"] {
            background-color: #161616;
            border-color: #F5F5F4;
        }
        .profile-theme-picker-btn[data-theme="dark"] .material-symbols-outlined {
            color: #BFBFBF;
        }
        
        /* Spotify button - always green border */
        .profile-theme-picker-btn[data-theme="spotify"] {
            background-color: #1DB954;
            border-color: #1DB954;
        }
        .profile-theme-picker-btn[data-theme="spotify"] .material-symbols-outlined {
            color: #ECECEB;
        }
        
        /* Dark theme: all button outlines and dark/spotify icons use appropriate grays */
        [data-theme="dark"] .theme-btn.on { border-color: #8C8C8C; }
        [data-theme="dark"] .theme-btn[data-t="dark"] .material-symbols-outlined { color: #8C8C8C; }
        [data-theme="dark"] .theme-btn[data-t="spotify"] .material-symbols-outlined { color: #E8E8E8; }

        /* --------------------------------------------
           CONTENT AREA & VIEWS
           -------------------------------------------- */
        .content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .content::-webkit-scrollbar {
            display: none;
        }

        .view { display: none; }
        .view.on { display: block; }

        /* --------------------------------------------
           GRID VIEW (Main)
           -------------------------------------------- */
        .grid {
            display: grid;
            gap: var(--gap);
            width: 100%;
            margin-top: 8px;
        }

        /* Tiles */
        .tile {
            cursor: pointer;
            user-select: none;
            transition: transform 0.15s ease, opacity 0.15s ease;
            min-width: 0;
        }
        .tile:active { 
            opacity: 0.8;
            transform: scale(0.97);
        }

        .tile-img {
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow);
        }

        .tile-img > img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .tile-ph {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
        }
        
        .tile-ph .material-symbols-outlined {
            font-size: 48px;
        }

        .tile-title {
            margin-top: 8px;
            font-size: var(--font-card);
            font-weight: 600;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text2);
        }

        .tile-desc {
            font-size: var(--font-small);
            color: var(--text2);
            margin-top: 2px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Edit mode for tiles */
        .tile.edit-mode {
            position: relative;
        }
        
        .tile-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .tile.edit-mode .tile-delete {
            opacity: 1;
        }
        
        .tile-delete .material-symbols-outlined {
            font-size: 16px;
            color: white;
        }
        
        .tile-delete:active {
            transform: scale(0.9);
        }
        
        /* Edit mode for dive items */
        .dive-item.edit-mode {
            position: relative;
        }
        
        .dive-item.edit-mode .dive-img {
            position: relative;
        }
        
        .dive-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        
        .dive-item.edit-mode .dive-delete {
            opacity: 1;
        }
        
        .dive-delete .material-symbols-outlined {
            font-size: 18px;
            color: white;
        }
        
        .dive-delete:active {
            transform: scale(0.9);
        }

        /* --------------------------------------------
           DEEP DIVE VIEW
           -------------------------------------------- */
        .dive-list {
            display: flex;
            flex-direction: column;
            gap: var(--gap);
            width: var(--grid-width, 100%);
            max-width: 700px;
            margin: 0;
        }
        
        .dive-item {
            display: flex;
            gap: var(--gap);
            align-items: flex-start;
            cursor: pointer;
            width: 100%;
        }
        .dive-item:active { opacity: 0.8; }
        
        .dive-img {
            width: 40%;
            aspect-ratio: 1;
            flex-shrink: 0;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: var(--card);
            box-shadow: var(--shadow);
        }
        
        .dive-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .dive-ph {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
        }
        
        .dive-ph .material-symbols-outlined {
            font-size: 48px;
        }
        
        .dive-info {
            flex: 1;
            min-width: 0;
            padding-top: 4px;
        }
        
        .dive-title {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.3;
            color: var(--text2);
            margin-bottom: 8px;
        }
        
        .dive-desc {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
        }
        
        .dive-back {
            padding: var(--gap) 0;
            text-align: center;
        }

        /* --------------------------------------------
           EDIT VIEW
           -------------------------------------------- */
        .edit-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .edit-header {
            margin-bottom: 16px;
        }
        
        .edit-header-row {
            display: flex;
            gap: 12px;
        }
        
        .edit-header-col {
            display: flex;
            flex-direction: column;
        }
        
        .edit-header-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .edit-header .pl-input {
            margin-bottom: 0;
        }
        
        .edit-occasion-select {
            width: 100%;
        }
        
        .edit-occasion-select .custom-select-btn {
            width: 100%;
            padding: 10px;
            background: var(--input);
            border-radius: var(--radius-sm);
            box-shadow: none;
        }
        
        .edit-occasion-select .custom-select-options {
            width: 100%;
            left: 0;
        }
        
        .section-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .toolbar-title {
            font-size: var(--font-title);
            font-weight: 700;
            color: var(--text);
        }
        
        .main-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 600px) {
            .main-toolbar {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                gap: 8px;
            }
            
            .main-toolbar .mixtape-title-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
                min-width: 0;
                flex: 1;
            }
            
            .main-toolbar .mixtape-title {
                font-size: 12px;
            }
            
            .main-toolbar .edit-actions {
                flex-shrink: 0;
            }
        }
        
        .main-toolbar .edit-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        
        .main-toolbar .action-btn,
        .mixtape-header .action-btn,
        .card .action-btn,
        .profile-card-edit .action-btn,
        .modal .action-btn,
        .edit-toolbar .action-btn {
            padding: 6px 10px;
            font-size: var(--font-sidebar);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
        }
        
        [data-theme="dark"] .main-toolbar .action-btn,
        [data-theme="dark"] .mixtape-header .action-btn,
        [data-theme="dark"] .card .action-btn,
        [data-theme="dark"] .profile-card-edit .action-btn,
        [data-theme="dark"] .modal .action-btn,
        [data-theme="dark"] .edit-toolbar .action-btn {
            background: var(--input);
        }
        
        .edit-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .action-btn {
            font-size: var(--font-input);
            font-family: inherit;
            color: var(--text2);
            background: var(--card);
            border: none;
            border-radius: var(--radius-xs);
            padding: 8px 16px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: transform 0.1s ease, opacity 0.1s ease, box-shadow 0.1s ease;
            -webkit-tap-highlight-color: transparent;
            white-space: nowrap;
        }
        
        /* Mobile action buttons and inputs - must match height and font size */
        @media (max-width: 600px) {
            .action-btn {
                font-size: 13px;
                padding: 8px 12px;
            }
            .pl-input {
                font-size: 14px;
                padding: 8px;
            }
            .edit-actions {
                gap: 6px;
            }
        }
        .action-btn:active { 
            opacity: 0.7; 
            transform: scale(0.95);
            box-shadow: none;
        }
        .action-btn.completed {
            opacity: 0.7;
            transform: scale(0.95);
            box-shadow: none;
        }
        .action-btn.square {
            width: 28px;
            height: 28px;
            padding: 0;
            font-size: 16px;
            font-weight: 400;
        }
        
        /* Buttons inside cards need more defined shadow */
        .txt-btn {
            font-size: var(--font-button);
            color: var(--text2);
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
            cursor: pointer;
        }
        .txt-btn:active { opacity: 0.5; }

        .section { margin-bottom: var(--gap); }
        .section-hd {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .section-desc {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
            margin: 8px 0 12px;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .card.has-dropdown {
            overflow: visible;
        }
        
        .card-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 16px 0;
        }
        
        .card-hint {
            font-size: 11px;
            color: var(--text3);
            margin: 0;
            line-height: 1.4;
        }
        
        .card-hint:empty {
            display: none;
        }
        
        /* --------------------------------------------
           HELP PAGE
           -------------------------------------------- */
        .help-section {
            margin-bottom: 32px;
        }
        /* --------------------------------------------
           SHARED PAGE STYLES (About, Help, Share, Profile, Widget)
           -------------------------------------------- */
        #about,
        #help,
        #share,
        #profile,
        #widget {
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            padding-top: 8px;
            padding-bottom: 24px;
        }
        
        #about .section,
        #help .section,
        #share .section,
        #profile .section,
        #widget .section {
            max-width: none;
        }
        
        #about .share-back,
        #help .share-back,
        #share .share-back,
        #profile .share-back,
        #widget .share-back {
            padding-top: 32px;
            padding-bottom: 8px;
        }
        
        /* --------------------------------------------
           HELP PAGE
           -------------------------------------------- */
        #help .about-hero img {
            object-position: center top;
        }
        
        .help-section {
            margin-bottom: 32px;
        }
        .help-title {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--text);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--input);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .help-q {
            font-size: var(--font-card);
            font-weight: 600;
            color: var(--text2);
            margin-top: 16px;
            margin-bottom: 6px;
        }
        .help-a {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
            margin: 0;
        }
        
        /* --------------------------------------------
           WIDGET PAGE
           -------------------------------------------- */
        .widget-generate-card {
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .widget-generate-card .pl-item {
            display: flex !important;
            flex-direction: row !important;
            flex-wrap: wrap !important;
            gap: 16px;
            align-items: center;
            justify-content: space-evenly;
        }
        
        .widget-generate-card .widget-select-group {
            flex: 0 0 auto;
        }
        
        .widget-generate-card .action-btn {
            flex: 0 0 100%;
            margin-top: 4px;
        }
        
        @media (max-width: 767px) {
            .widget-generate-card .pl-item {
                display: grid !important;
                grid-template-columns: auto auto;
                gap: 16px;
                justify-content: space-evenly;
            }
            
            .widget-generate-card .widget-select-group {
                width: auto;
            }
            
            .widget-generate-card .action-btn {
                grid-column: 1 / -1;
                width: 100%;
            }
        }
        
        #widget .widget-info {
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
        
        .widget-select-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .widget-select-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .widget-info {
            padding: 12px 16px;
            background: var(--input);
            border-radius: var(--radius-sm);
            margin-top: 12px;
        }
        
        .widget-qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: var(--card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            margin-top: 16px;
        }
        
        .widget-qr-code {
            background: #fff;
            padding: 16px;
            border-radius: var(--radius-sm);
        }
        
        .widget-qr-code canvas {
            display: block;
        }
        
        .widget-download-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .widget-success {
            margin-top: 16px;
            text-align: center;
        }
        
        .widget-success .widget-qr-code {
            display: inline-block;
            padding: 12px;
            background: #fff;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }
        
        .widget-success .action-btn.full {
            display: block;
            width: 100%;
            text-align: center;
            text-decoration: none;
        }
        
        .widget-sizes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }
        
        .widget-size-card {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .widget-size-preview {
            background: var(--input);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 12px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .widget-size-preview.small-preview {
            aspect-ratio: auto;
            width: 65%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .widget-size-preview.small-preview .preview-grid {
            width: 100%;
            height: auto;
        }
        
        .widget-size-preview.small-preview .preview-grid span {
            aspect-ratio: 1;
        }
        
        .widget-size-preview.medium-preview {
            aspect-ratio: auto;
            padding: 12px;
        }
        
        .medium-preview .preview-grid {
            height: auto;
        }
        
        .medium-preview .preview-grid span {
            aspect-ratio: 1;
        }
        
        .widget-size-preview.large-preview {
            aspect-ratio: 1;
        }
        
        .preview-grid {
            display: grid;
            gap: 4px;
            width: 100%;
            height: 100%;
        }
        
        .preview-grid span {
            background: var(--text3);
            opacity: 0.4;
            border-radius: 4px;
        }
        
        .widget-size-name {
            font-size: var(--font-card);
            font-weight: 600;
            color: var(--text2);
        }
        
        .widget-size-desc {
            font-size: var(--font-small);
            color: var(--text3);
            margin-top: 2px;
        }
        
        /* --------------------------------------------
           ABOUT PAGE
           -------------------------------------------- */
        .about-hero {
            position: relative;
            width: 100%;
            height: 385px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 48px;
            transform: translateZ(0);
        }
        .about-hero img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 75%;
        }
        @media (max-width: 700px) {
            .about-hero {
                height: 280px;
            }
            .about-hero-title {
                font-size: 24px;
            }
        }
        @media (max-width: 500px) {
            .about-hero {
                height: 200px;
            }
            .about-hero-title {
                font-size: 18px;
            }
        }
        .about-hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%);
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            padding: 24px;
        }
        .about-hero-title {
            font-size: 28px;
            font-weight: 400;
            color: #fff;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .about-hero-title span {
            font-weight: 700;
            letter-spacing: 0.3em;
        }
        
        .brand {
            text-transform: uppercase;
        }
        .brand-header {
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }
        
        .about-intro {
            margin-bottom: 24px;
        }
        .about-intro p {
            font-size: var(--font-body);
            line-height: var(--line-height);
            color: var(--text2);
            margin: 0;
        }
        
        .about-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        @media (max-width: 500px) {
            .about-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .about-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            transform: translateZ(0);
        }
        .about-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--text);
        }
        .about-card-icon .material-symbols-outlined {
            font-size: 22px;
        }
        .about-card-title {
            font-size: var(--font-card);
            font-weight: 600;
            color: var(--text2);
            margin-bottom: 8px;
        }
        .about-card-desc {
            font-size: var(--font-card);
            line-height: var(--line-height);
            color: var(--text2);
            margin: 0;
        }
        
        .about-footer {
            text-align: center;
            padding: 8px 0 0;
        }
        .about-footer p {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
            margin: 0 0 2px;
        }
        .about-footer p:last-child {
            margin-bottom: 0;
        }
        .about-footer a {
            color: var(--text);
            text-decoration: none;
        }
        .about-footer a:active {
            opacity: 0.6;
        }
        
        .about-divider {
            width: 30%;
            height: 1px;
            background: var(--text3);
            opacity: 0.3;
            margin: 32px auto;
        }
        
        /* --------------------------------------------
           PROFILE PAGE
           -------------------------------------------- */
        /* Edit mode card */
        .profile-card-edit {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            gap: 12px;
            align-items: flex-end;
            box-shadow: var(--shadow);
        }
        
        .profile-card-avatar-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .profile-field-col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .profile-field-col .profile-field-label {
            margin-bottom: 6px;
        }
        
        .profile-field-col .pl-input {
            margin-bottom: 0;
        }
        
        .profile-field-col .profile-field-meta {
            margin-top: 4px;
        }
        
        .profile-btn-col {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 19px;
        }
        
        .profile-card-photo {
            flex-shrink: 0;
        }
        
        .profile-card-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .profile-card-avatar .material-symbols-outlined {
            font-size: 28px;
        }
        
        .profile-card-avatar .avatar-letter {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Profile card avatar letter colors by theme */
        [data-theme="light"] .profile-card-avatar .avatar-letter,
        [data-theme="spotify"] .profile-card-avatar .avatar-letter {
            color: #161616;
        }
        
        [data-theme="dark"] .profile-card-avatar .avatar-letter {
            color: #F5F5F4;
        }
        
        .profile-card-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-field-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .profile-field-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .profile-field-label .required {
            color: var(--accent);
        }
        
        .profile-card-fields .pl-input {
            flex: 1;
            margin-bottom: 0;
        }
        
        .profile-field-meta {
            font-size: 11px;
            color: var(--text3);
            margin-top: 4px;
        }
        
        #profile-photo-btn {
            cursor: pointer;
        }
        
        #profile-photo-btn:hover {
            color: var(--text2);
        }
        
        .profile-card-fields > .action-btn {
            align-self: flex-end;
            height: auto;
        }
        
        /* Display mode card */
        .profile-card-display {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            box-shadow: var(--shadow);
        }
        
        .profile-card-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .profile-card-avatar-wrap {
            position: relative;
            flex-shrink: 0;
        }
        
        .profile-card-avatar-large {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text3);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .profile-card-avatar-large .material-symbols-outlined {
            font-size: 28px;
        }
        
        .profile-card-avatar-large .avatar-letter {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Profile card avatar large letter colors by theme */
        [data-theme="light"] .profile-card-avatar-large .avatar-letter,
        [data-theme="spotify"] .profile-card-avatar-large .avatar-letter {
            color: #161616;
        }
        
        [data-theme="dark"] .profile-card-avatar-large .avatar-letter {
            color: #F5F5F4;
        }
        
        .profile-card-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Profile card photo wrapper with delete button */
        .profile-card-photo {
            position: relative;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .profile-avatar-delete-btn {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--text2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--card);
            padding: 0;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        
        .profile-avatar-delete-btn:hover {
            background: var(--text);
        }
        
        .profile-photo-text {
            background: none;
            border: none;
            padding: 0;
            font-size: 11px;
            color: var(--text2);
            cursor: pointer;
            font-family: inherit;
        }
        
        .profile-photo-text:hover {
            color: var(--text);
        }
        
        .profile-card-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .profile-card-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
        }
        
        .profile-card-username {
            font-size: 13px;
            font-style: italic;
            color: var(--text2);
        }
        
        .profile-card-edit-btn {
            background: none;
            border: none;
            padding: 0;
            margin-top: 4px;
            font-size: 12px;
            color: var(--text2);
            cursor: pointer;
            text-align: left;
            font-family: inherit;
        }
        
        .profile-card-edit-btn:hover {
            color: var(--text);
        }
        
        .profile-card-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .profile-stat {
            font-size: 12px;
            color: var(--text2);
        }
        
        .profile-stat span {
            font-weight: 600;
            color: var(--text);
        }
        
        /* Vestaboard display */
        .vestaboard-key-display {
            font-size: 13px;
            color: var(--accent);
            font-weight: 500;
            word-break: break-all;
        }
        
        @media (max-width: 500px) {
            .profile-card-edit {
                flex-direction: column;
                align-items: stretch;
            }
            
            .profile-card-photo {
                display: flex;
                justify-content: center;
            }
            
            .profile-card-fields {
                flex-direction: column;
            }
            
            .profile-card-display {
                flex-direction: row;
                align-items: flex-start;
            }
            
            .profile-card-right {
                align-items: flex-end;
            }
            
            .profile-stat {
                font-size: 11px;
            }
        }
        
        .about-story {
            padding: 0 0 24px;
        }
        .about-story p {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
            margin: 0 0 16px;
        }
        .about-story p:last-child {
            margin-bottom: 0;
        }
        
        .about-section-title {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        .use-case-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        @media (max-width: 500px) {
            .use-case-grid {
                grid-template-columns: 1fr;
            }
        }
        .use-case-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
            transition: box-shadow 0.2s ease;
        }
        .use-case-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 10px;
            border-radius: 0 0 50% 50% / 0 0 100% 100%;
            box-shadow: 0 0 0 rgba(0,0,0,0);
            transition: box-shadow 0.2s ease;
        }
        .use-case-card:hover::after {
            box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        }
        [data-theme="dark"] .use-case-card:hover::after {
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        .use-case-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            color: var(--text);
        }
        .use-case-icon .material-symbols-outlined {
            font-size: 22px;
        }
        .use-case-title {
            font-size: var(--font-card);
            font-weight: 600;
            color: var(--text2);
            margin-bottom: 6px;
        }
        .use-case-desc {
            font-size: var(--font-card);
            color: var(--text2);
            line-height: var(--line-height);
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px var(--padding);
            min-height: 44px;
            font-size: var(--font-card);
        }

        /* Segmented control */
        .seg {
            display: flex;
            background: var(--input);
            border-radius: var(--radius-xs);
            padding: 2px;
        }

        .seg-btn {
            padding: 6px 16px;
            font-size: var(--font-button);
            font-weight: 500;
            color: var(--text);
            background: transparent;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            cursor: pointer;
        }
        .seg-btn.on { background: var(--card); }
        [data-theme="spotify"] .seg-btn.on { background: var(--card); }
        [data-theme="spotify"] .sidebar { color: #fff; }
        [data-theme="spotify"] .sidebar-title { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-toggle { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-item { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-item .material-symbols-outlined { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .sidebar-item:active { background: rgba(255,255,255,0.15); }
        [data-theme="spotify"] .sidebar-item.active { color: #fff; background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .sidebar.collapsed .sidebar-item .material-symbols-outlined { color: #1DB954; }
        [data-theme="spotify"] .sidebar.collapsed .sidebar-toggle { color: #1DB954; }
        [data-theme="spotify"] .sidebar.collapsed .sidebar-divider { background: #1DB954; opacity: 0.35; }
        [data-theme="spotify"] .sidebar.collapsed .sidebar-footer::before { background: #1DB954 !important; opacity: 0.35 !important; }
        [data-theme="spotify"] .sidebar-label { color: rgba(255,255,255,0.6); }
        [data-theme="spotify"] .sidebar-divider { background: rgba(255,255,255,0.35); opacity: 1; }
        [data-theme="spotify"] .sidebar-footer::before { background: rgba(255,255,255,0.35) !important; opacity: 1 !important; }
        [data-theme="spotify"] .sidebar-mixtapes-label { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-mixtape-item { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .no-mixtapes { color: rgba(255,255,255,0.6); }
        [data-theme="spotify"] .sidebar-themes .theme-btn { border-color: rgba(255,255,255,0.3); }
        [data-theme="spotify"] .sidebar-profile-name { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-username { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-avatar { background: rgba(255,255,255,0.2); }
        [data-theme="spotify"] .sidebar-profile-avatar .material-symbols-outlined { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-avatar .avatar-letter { color: #F5F5F4; }
        [data-theme="spotify"] .sidebar-profile-link { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-link:hover { color: #fff; }
        [data-theme="spotify"] .sidebar-dropdown-arrow { color: rgba(255,255,255,0.6); }
        [data-theme="spotify"] .sidebar-dropdown-content { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-dropdown-arrow { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-profile-name { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-profile-username { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-profile-avatar { background: rgba(255,255,255,0.2); }
        [data-theme="spotify"] .menu-profile-avatar .material-symbols-outlined { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-profile-avatar .avatar-letter { color: #F5F5F4; }
        [data-theme="spotify"] .menu-profile-link { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-profile-link:hover { color: #fff; }
        [data-theme="spotify"] .menu-collapse-arrow { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .mixtapes-list { color: rgba(255,255,255,0.85); }
        
        /* Spotify theme: dropdown menu green background */
        [data-theme="spotify"] .dropdown-content { 
            background: #1DB954; 
        }
        [data-theme="spotify"] .menu-item { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .menu-item:hover { background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .menu-item:active { background: rgba(255,255,255,0.15); }
        [data-theme="spotify"] .menu-profile-section:hover { background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .menu-profile-section:active { background: rgba(255,255,255,0.15); }
        [data-theme="spotify"] .menu-divider { background: rgba(255,255,255,0.2); }
        [data-theme="spotify"] .menu-label { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .mixtape-item { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .mixtape-item .material-symbols-outlined { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .mixtape-item:hover { background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .mixtape-item:active { background: rgba(255,255,255,0.15); }
        [data-theme="spotify"] .no-mixtapes { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-link { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .sidebar-profile-link:hover { color: #fff; }
        [data-theme="spotify"] .sidebar-profile-username { color: rgba(255,255,255,0.85); }
        
        /* Spotify theme: mobile more menu green background */
        [data-theme="spotify"] .mobile-more-menu {
            background: #1DB954;
        }
        [data-theme="spotify"] .mobile-more-item { color: rgba(255,255,255,0.85); }
        [data-theme="spotify"] .mobile-more-item:hover { background: rgba(255,255,255,0.1); }
        [data-theme="spotify"] .mobile-more-item:active { background: rgba(255,255,255,0.15); }
        [data-theme="spotify"] .mobile-more-divider { background: rgba(255,255,255,0.2); }
        
        /* Spotify theme: light theme button needs green border */
        [data-theme="spotify"] .profile-theme-picker-btn[data-theme="light"] {
            border-color: #1DB954;
        }

        /* --------------------------------------------
           PLAYLIST FORM (Edit View)
           -------------------------------------------- */
        .pl-item { 
            padding: var(--padding);
            border-bottom: 1px solid var(--input);
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }
        .pl-item:last-child {
            border-bottom: none;
        }
        .pl-item.dragging {
            opacity: 0.5;
        }
        
        .pl-preview-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .pl-preview {
            width: 80px;
            height: 80px;
            min-width: 80px;
            border-radius: var(--radius-sm);
            overflow: hidden;
            background: var(--input);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pl-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pl-preview.empty {
            color: var(--text3);
        }
        .pl-preview .material-symbols-outlined {
            font-size: 32px;
        }
        
        .pl-delete {
            font-size: var(--font-small);
            font-family: inherit;
            color: var(--text3);
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }
        .pl-delete:active {
            opacity: 0.5;
        }
        
        .pl-fields {
            flex: 1;
            min-width: 0;
        }
        
        .pl-url-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        .pl-input {
            width: 100%;
            padding: 10px;
            font-size: var(--font-input);
            font-family: inherit;
            background: var(--input);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text2);
            margin-bottom: 10px;
            transition: background 0.2s ease;
        }
        
        textarea.pl-input {
            resize: none;
            min-height: 38px;
            line-height: 1.4;
            overflow: hidden;
        }
        
        .pl-url-row .pl-input {
            margin-bottom: 0;
            flex: 1;
        }
        .pl-input.url {
            color: var(--accent);
        }
        .pl-input::placeholder { color: var(--text2); }
        .pl-input:focus { outline: none; }
        
        .pl-reorder {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-shrink: 0;
        }
        .pl-move-up, .pl-move-down {
            width: 28px;
            height: 22px;
            background: var(--input);
            border: none;
            border-radius: 4px;
            color: var(--text3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .pl-move-up .material-symbols-outlined, 
        .pl-move-down .material-symbols-outlined {
            font-size: 18px;
        }
        .pl-move-up:active, .pl-move-down:active {
            background: var(--text3);
            color: var(--card);
        }
        
        .pl-title {
            width: 100%;
            padding: 10px;
            font-size: 13px;
            font-family: inherit;
            background: var(--input);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text3);
            margin-bottom: 10px;
        }

        .pl-meta {
            font-size: var(--font-small);
            color: var(--text2);
        }

        /* Footer */
        .footer {
            margin-top: var(--gap);
            text-align: center;
            flex-shrink: 0;
        }
        .footer-txt {
            font-size: var(--font-small);
            color: var(--text3);
        }
        
        /* Add button */
        .add-btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin-top: var(--gap);
            font-size: 24px;
            font-weight: 300;
            color: var(--text3);
            background: var(--card);
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        .add-btn:active { opacity: 0.6; }
        .add-btn:disabled { opacity: 0.3; cursor: default; }

        /* --------------------------------------------
           SHARE VIEW
           -------------------------------------------- */
        .action-btn.full {
            width: 100%;
            margin-top: 8px;
        }
        
        .share-output {
            margin-top: var(--gap);
        }
        
        .share-success {
            font-size: var(--font-card);
            font-weight: 600;
            color: var(--accent);
            text-align: center;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .share-label {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .share-string {
            background: var(--card);
            border-radius: var(--radius-md);
            padding: var(--padding);
            word-break: break-all;
            font-size: var(--font-small);
            color: var(--text2);
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }
        
        .share-code {
            word-break: break-all;
            font-size: var(--font-small);
            color: var(--text2);
            padding: 8px 0;
            line-height: 1.4;
        }
        
        .share-back {
            padding: var(--gap) 0;
            text-align: center;
        }
        
        /* Filter controls */
        .filter-controls {
            display: flex;
            gap: 8px;
        }
        
        .custom-select {
            position: relative;
        }
        
        .custom-select-btn {
            font-size: var(--font-input);
            font-family: inherit;
            color: var(--text2);
            background: var(--card);
            border: none;
            border-radius: var(--radius-xs);
            padding: 8px 16px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .custom-select-btn:active { opacity: 0.7; }
        .custom-select-btn svg { flex-shrink: 0; }
        
        .custom-select-options {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--card);
            border-radius: var(--radius-xs);
            box-shadow: var(--shadow);
            overflow: hidden;
            z-index: 100;
            min-width: 100%;
        }
        .custom-select-options.open { display: block; }
        
        .custom-select-option {
            font-size: var(--font-card);
            color: var(--text2);
            padding: 10px 16px;
            cursor: pointer;
            white-space: nowrap;
        }
        .custom-select-option:active { background: var(--input); }
        .custom-select-option.selected { font-weight: 600; }
        
        /* Inline select - matches header text style */
        .custom-select.inline .custom-select-btn {
            background: none;
            box-shadow: none;
            padding: 0;
            font-size: var(--font-small);
            color: var(--text3);
            gap: 4px;
        }
        .custom-select.inline .custom-select-btn:active { opacity: 0.5; }
        .custom-select.inline .custom-select-btn svg {
            width: 10px;
            height: 10px;
        }
        
        /* Collected mixtapes */
        .view-toggle {
            display: flex;
            gap: 4px;
        }
        .view-toggle-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .view-toggle-btn .material-symbols-outlined {
            font-size: 20px;
        }
        .view-toggle-btn.active {
            color: var(--text2);
        }
        .toggle-label {
            font-size: var(--font-small);
            color: var(--text3);
            line-height: 1;
        }
        .copy-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--text3);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.15s ease;
        }
        .copy-btn .material-symbols-outlined {
            font-size: 20px;
        }
        .copy-btn:active {
            transform: scale(0.9);
            opacity: 0.7;
        }
        .copy-btn.copied {
            background: var(--input);
            color: var(--text2);
            padding: 4px;
        }
        .collected-list {
            margin-top: 12px;
        }
        .collected-list.grid-view {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .collected-list.grid-view .collected-item {
            flex-direction: column;
            align-items: stretch;
            padding: 12px;
            margin-bottom: 0;
        }
        .collected-list.grid-view .collected-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .collected-list.grid-view .collected-info {
            text-align: center;
        }
        .collected-list.grid-view .collected-title {
            margin-bottom: 4px;
        }
        
        .collected-empty {
            font-size: var(--font-card);
            color: var(--text3);
            text-align: center;
            padding: 24px;
            margin-bottom: 80px;
        }
        
        .collected-item {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--card);
            border-radius: var(--radius-md);
            padding: 14px var(--padding);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }
        
        .collected-star {
            color: var(--text3);
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        .collected-star .material-symbols-outlined {
            font-size: 20px;
        }
        .collected-star.starred {
            color: var(--accent);
        }
        
        .collected-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }
        
        .collected-title {
            font-size: var(--font-card);
            font-weight: 500;
            color: var(--text2);
        }
        
        .collected-delete {
            color: var(--text3);
            cursor: pointer;
            padding: 10px;
            line-height: 1;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }
        .collected-delete .material-symbols-outlined {
            font-size: 18px;
        }
        .collected-delete:active {
            color: var(--text2);
        }
        
        .collected-meta {
            font-size: var(--font-small);
            color: var(--text3);
            margin-top: 2px;
        }
        
        /* Mixtapes list in menu */
        .mixtapes-list {
            padding: 0 16px 8px;
        }
        
        .mixtape-item {
            display: block;
            width: 100%;
            padding: 6px 0;
            text-align: left;
            font-size: var(--font-menu);
            color: var(--text2);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }
        .mixtape-item:active { opacity: 0.6; }
        
        .no-mixtapes {
            font-size: var(--font-small);
            color: var(--text3);
            font-style: italic;
        }
        
        .dropdown-content .no-mixtapes {
            font-size: 11px;
            padding: 4px 16px;
        }
        
        .dropdown-content .mixtapes-list {
            padding: 0;
        }
        
        .dropdown-content .mixtape-item {
            padding: 4px 16px 4px 24px;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Friend view */
        .friend-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 44px;
            margin-bottom: var(--gap);
        }
        
        .share-toolbar {
            margin-bottom: 24px;
            display: block;
            width: 100%;
        }
        .share-toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            line-height: 1.4;
        }
        .share-toolbar-btns {
            display: flex;
            gap: 8px;
        }
        .share-toolbar-input {
            width: 100%;
            font-size: var(--font-small);
            font-family: inherit;
            color: var(--text2);
            background: transparent;
            border: none;
            outline: none;
            padding: 0;
            line-height: 1.4;
        }
        .share-toolbar-input::placeholder {
            color: var(--text3);
        }
        
        /* Mixtape View Header */
        .mixtape-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .mixtape-header .edit-actions {
            gap: 6px;
        }
        
        .mixtape-title-info {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            line-height: 1;
        }
        
        .mixtape-title {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            word-break: normal;
            overflow-wrap: break-word;
            line-height: 1.3;
        }
        
        .mixtape-occasion {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-small);
            color: var(--text3);
            font-weight: 400;
            flex-shrink: 0;
            line-height: 1;
        }
        
        .mixtape-occasion .material-symbols-outlined {
            font-size: 16px;
        }
        
        [data-theme="spotify"] .mixtape-title {
            color: #1DB954;
        }
        
        .collab-header {
            margin-bottom: 16px;
        }
        
        .friend-grid {
            display: grid;
            gap: var(--gap);
            width: 100%;
        }
        
        .collab-instructions {
            margin-bottom: var(--gap);
        }
        .collab-text {
            font-size: var(--font-small);
            color: var(--text3);
            line-height: var(--line-height);
        }
        
        .collab-add-form {
            margin-bottom: var(--gap);
        }
        .collab-add-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }

        /* Responsive */
        @media (min-width: 600px) {
            .section { max-width: 560px; margin-left: auto; margin-right: auto; }
        }
        
        /* Embed Player Section */
        .embed-section {
            margin-top: 0;
        }
        
        .embed-divider {
            width: 100%;
            height: 1px;
            background: var(--text3);
            opacity: 0.3;
            margin: 48px auto 48px;
        }
        
        .embed-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            min-height: 500px;
            background: var(--bg);
        }
        
        .embed-playlist-list {
            width: 160px;
            flex-shrink: 0;
            background: var(--bg);
            overflow-y: auto;
            padding: 8px 0;
            max-height: 500px;
        }
        
        .embed-player {
            flex: 1;
            min-height: 500px;
        }
        
        .embed-spacer {
            width: 160px;
            flex-shrink: 0;
            background: var(--bg);
        }
        
        .embed-section {
            container-type: inline-size;
        }
        
        @container (max-width: 800px) {
            .embed-spacer {
                display: none;
            }
        }
        
        .embed-playlist-item {
            display: block;
            width: 100%;
            padding: 10px 12px;
            text-align: left;
            font-size: var(--font-small);
            font-family: inherit;
            color: var(--text2);
            background: none;
            border: none;
            cursor: pointer;
            line-height: 1.3;
            word-wrap: break-word;
            transition: background 0.15s ease;
        }
        
        .embed-playlist-item:hover {
            background: var(--sidebar-bg);
        }
        
        .embed-playlist-item:active {
            background: var(--sidebar-bg);
        }
        
        .embed-playlist-item.active {
            background: var(--sidebar-bg);
            font-weight: 600;
        }
        
        [data-theme="spotify"] .embed-playlist-item:hover,
        [data-theme="spotify"] .embed-playlist-item:active,
        [data-theme="spotify"] .embed-playlist-item.active {
            background: #1DB954;
            color: #fff;
        }
        
        .embed-player iframe {
            width: 100%;
            height: 100%;
            min-height: 500px;
            border: none;
        }
        
        /* Hide embed section on mobile - only show on tablet+ */
        @media (max-width: 767px) {
            .embed-section {
                display: none;
            }
        }
        
        /* Safari recommendation banner */
        .safari-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card);
            color: var(--text2);
            font-size: var(--font-small);
            padding: 12px 16px;
            padding-top: calc(12px + var(--safe-t));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            box-shadow: var(--shadow);
            z-index: 1000;
        }
        .safari-close {
            background: none;
            border: none;
            color: var(--text3);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
        }
        
        /* --------------------------------------------
           SIDEBAR (Desktop/Tablet - 768px+)
           -------------------------------------------- */
        @media (min-width: 768px) {
            .app {
                display: flex;
                flex-direction: row;
            }
            
            .sidebar {
                display: flex;
                flex-direction: column;
                width: 260px;
                min-width: 260px;
                height: 100vh;
                background: var(--sidebar-bg);
                position: fixed;
                left: 0;
                top: 0;
                z-index: 100;
                transition: width 0.2s ease, min-width 0.2s ease;
            }
            
            .sidebar.collapsed {
                width: 48px;
                min-width: 48px;
                background: var(--bg);
                border-right: 1px solid #E6E6E5;
            }
            
            [data-theme="dark"] .sidebar.collapsed {
                border-right: 1px solid rgba(115, 115, 115, 0.3);
            }
            
            [data-theme="spotify"] .sidebar.collapsed {
                border-right-color: #E6E6E5;
            }
            
            .sidebar .icon-collapsed {
                display: none;
            }
            
            .sidebar.collapsed .icon-expanded {
                display: none;
            }
            
            .sidebar.collapsed .icon-collapsed {
                display: block;
            }
            
            .sidebar.collapsed .sidebar-title,
            .sidebar.collapsed .sidebar-text,
            .sidebar.collapsed .sidebar-dropdown-content,
            .sidebar.collapsed .sidebar-dropdown-arrow,
            .sidebar.collapsed .sidebar-label {
                display: none !important;
            }
            
            .sidebar.collapsed .sidebar-header {
                justify-content: center;
                padding: 0;
            }
            
            .sidebar.collapsed .sidebar-toggle {
                position: relative;
            }
            
            .sidebar.collapsed .sidebar-toggle::after {
                content: attr(data-tooltip);
                position: absolute;
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 8px;
                padding: 4px 8px;
                background: #161616;
                color: #F5F5F4;
                font-size: 11px;
                font-family: inherit;
                font-weight: 400;
                border-radius: 4px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.15s ease, visibility 0.15s ease;
                pointer-events: none;
                z-index: 300;
            }
            
            .sidebar.collapsed .sidebar-toggle:hover::after {
                opacity: 1;
                visibility: visible;
            }
            
            .sidebar.collapsed .sidebar-item {
                justify-content: center;
                padding: 7px 0;
                margin: 0 6px;
                width: calc(100% - 12px);
                border-radius: 6px;
                position: relative;
            }
            
            .sidebar.collapsed .sidebar-nav {
                overflow: visible;
            }
            
            .sidebar.collapsed .sidebar-item::after {
                content: attr(data-tooltip);
                position: absolute;
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 8px;
                padding: 4px 8px;
                background: #161616;
                color: #F5F5F4;
                font-size: 11px;
                font-family: inherit;
                font-weight: 400;
                border-radius: 4px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.15s ease, visibility 0.15s ease;
                pointer-events: none;
                z-index: 300;
            }
            
            .sidebar.collapsed .sidebar-item:hover::after {
                opacity: 1;
                visibility: visible;
            }
            
            .sidebar.collapsed .sidebar-dropdown-toggle {
                justify-content: center;
                padding: 7px 0;
                margin: 0 6px;
                width: calc(100% - 12px);
                border-radius: 6px;
                cursor: pointer;
                position: relative;
            }
            
            .sidebar.collapsed .sidebar-dropdown-toggle::after {
                content: attr(data-tooltip);
                position: absolute;
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 8px;
                padding: 4px 8px;
                background: #161616;
                color: #F5F5F4;
                font-size: 11px;
                font-family: inherit;
                font-weight: 400;
                border-radius: 4px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.15s ease, visibility 0.15s ease;
                pointer-events: none;
                z-index: 300;
            }
            
            .sidebar.collapsed .sidebar-dropdown-toggle:hover::after {
                opacity: 1;
                visibility: visible;
            }
            
            .sidebar.collapsed .sidebar-dropdown-toggle:active {
                background: var(--input);
            }
            
            .sidebar.collapsed .sidebar-footer {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 16px 0;
            }
            
            .sidebar.collapsed .sidebar-profile-section {
                margin-bottom: 0;
            }
            
            .sidebar.collapsed .sidebar-profile-info {
                display: none;
            }
            
            .sidebar.collapsed .sidebar-profile-text {
                display: none;
            }
            
            .sidebar.collapsed .sidebar-profile-links {
                display: none !important;
            }
            
            .sidebar.collapsed .sidebar-footer-buttons {
                display: none;
            }
            
            .sidebar.collapsed .sidebar-divider {
                margin: 16px 10px;
            }
            
            .sidebar-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                height: 44px;
                padding: 0 20px;
                margin-top: calc(var(--gap) + 1px);
                flex-shrink: 0;
            }
            
            .sidebar-title {
                font-size: 15px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.3em;
                color: var(--text2);
                cursor: pointer;
            }
            
            .sidebar-toggle {
                background: none;
                border: none;
                padding: 0;
                cursor: pointer;
                color: var(--text2);
                display: flex;
                align-items: center;
            }
            .sidebar-toggle .material-symbols-outlined {
                font-size: 18px;
            }
            .sidebar-toggle:active { opacity: 0.5; }
            
            .sidebar-nav {
                flex: 1;
                overflow-y: auto;
                padding: 8px 0;
                -webkit-overflow-scrolling: touch;
            }
            .sidebar-nav::-webkit-scrollbar { display: none; }
            
            .sidebar-item {
                display: flex;
                align-items: center;
                gap: 12px;
                width: 100%;
                padding: 7px 20px;
                text-align: left;
                font-size: var(--font-sidebar);
                font-family: inherit;
                color: var(--text2);
                background: none;
                border: none;
                cursor: pointer;
                text-decoration: none;
            }
            .sidebar-item .material-symbols-outlined {
                font-size: 18px;
            }
            .sidebar-item:hover { background: #E6E6E5; }
            .sidebar-item:active { background: #E2E2E1; }
            .sidebar-item.active { font-weight: 600; background: #E6E6E5; }
            [data-theme="dark"] .sidebar-item:hover { background: #222222; }
            [data-theme="dark"] .sidebar-item:active { background: #252525; }
            [data-theme="dark"] .sidebar-item.active { background: #222222; }
            
            .sidebar-divider {
                height: 1px;
                background: var(--text3);
                opacity: 0.3;
                margin: 16px 20px;
            }
            
            .sidebar-label {
                padding: 12px 20px 6px;
                font-size: 11px;
                color: var(--text2);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .sidebar-mixtapes-label {
                cursor: default;
            }
            .sidebar-mixtapes-label:active {
                background: none;
            }
            
            .sidebar-dropdown {
                width: 100%;
            }
            
            .sidebar-dropdown-toggle {
                justify-content: flex-start;
                position: relative;
            }
            
            .sidebar-dropdown-arrow {
                position: absolute;
                right: 20px;
                color: var(--text3);
                transition: transform 0.2s ease;
            }
            
            .sidebar-dropdown-toggle.open .sidebar-dropdown-arrow {
                transform: rotate(180deg);
            }
            
            .sidebar-dropdown-content {
                display: none;
                padding: 0;
            }
            
            .sidebar-dropdown-content.open {
                display: block;
            }
            
            .no-mixtapes {
                font-size: var(--font-sidebar);
                color: var(--text3);
                font-style: italic;
                padding: 7px 20px 7px 50px;
                cursor: default;
            }
            .no-mixtapes:hover {
                background: var(--input);
            }
            
            .sidebar-mixtape-item {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
                padding: 6px 20px 6px 46px;
                text-align: left;
                font-size: 12px;
                color: var(--text2);
                background: none;
                border: none;
                cursor: pointer;
                font-family: inherit;
            }
            .sidebar-mixtape-item .material-symbols-outlined {
                font-size: 16px;
            }
            .sidebar-mixtape-item:hover { background: #E6E6E5; }
            .sidebar-mixtape-item:active { background: #E2E2E1; }
            .sidebar-mixtape-item.active { font-weight: 600; background: #E6E6E5; }
            [data-theme="dark"] .sidebar-mixtape-item:hover { background: #222222; }
            [data-theme="dark"] .sidebar-mixtape-item:active { background: #252525; }
            [data-theme="dark"] .sidebar-mixtape-item.active { background: #222222; }
            
            /* Disable tooltips in dark theme */
            [data-theme="dark"] [data-tooltip]::after {
                display: none !important;
            }
            
            .sidebar-footer {
                padding: 16px 20px;
                flex-shrink: 0;
                position: relative;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }
            
            .sidebar-footer::before {
                content: '';
                position: absolute;
                top: 0;
                left: 20px;
                right: 20px;
                height: 1px;
                background: var(--text3);
                opacity: 0.3;
            }
            
            .sidebar-profile-section {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            
            .sidebar-profile-clickable {
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
            }
            
            .sidebar-profile-clickable:hover {
                opacity: 0.8;
            }
            
            .sidebar-profile-avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: #161616;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                overflow: hidden;
                flex-shrink: 0;
            }
            
            .sidebar-profile-avatar .material-symbols-outlined {
                font-size: 18px;
                color: #F5F5F4;
            }
            
            .sidebar-profile-avatar .avatar-letter {
                font-size: 14px;
                font-weight: 700;
                text-transform: uppercase;
                color: #F5F5F4;
            }
            
            /* Dark theme sidebar avatar */
            [data-theme="dark"] .sidebar-profile-avatar {
                background: #F0F0EF;
            }
            
            [data-theme="dark"] .sidebar-profile-avatar .material-symbols-outlined {
                color: #4A4A4A;
            }
            
            [data-theme="dark"] .sidebar-profile-avatar .avatar-letter {
                color: #4A4A4A;
            }
            
            .sidebar-profile-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            
            .sidebar-profile-text {
                display: flex;
                flex-direction: column;
                gap: 1px;
                min-width: 0;
            }
            
            .sidebar-profile-info {
                display: flex;
                flex-direction: column;
                gap: 1px;
                min-width: 0;
            }
            
            .sidebar-profile-name {
                font-size: 12px;
                font-weight: 700;
                color: var(--text2);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.3;
            }
            
            .sidebar-profile-username {
                font-size: 11px;
                font-style: italic;
                color: var(--text2);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1.3;
            }
            
            .sidebar-profile-links {
                display: flex;
                gap: 8px;
                padding-left: 46px;
            }
            
            .sidebar-profile-link {
                color: var(--text2);
                text-decoration: none;
                background: none;
                border: none;
                padding: 0;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .sidebar-profile-link .material-symbols-outlined {
                font-size: 16px;
            }
            
            .sidebar-profile-link:hover {
                color: var(--text);
            }
            
            /* Collapsed sidebar - smaller avatar */
            .sidebar.collapsed .sidebar-profile-avatar {
                width: 24px;
                height: 24px;
            }
            
            .sidebar.collapsed .sidebar-profile-avatar .material-symbols-outlined {
                font-size: 14px;
            }
            
            .sidebar.collapsed .sidebar-profile-avatar .avatar-letter {
                font-size: 11px;
            }
            
            .sidebar-footer-buttons {
                display: flex;
                gap: 6px;
            }
            
            .sidebar-footer-btn {
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: transparent;
                border: none;
                border-radius: 4px;
                color: var(--text3);
                text-decoration: none;
                cursor: pointer;
                position: relative;
            }
            
            .sidebar-footer-btn .material-symbols-outlined {
                font-size: 14px;
            }
            
            .sidebar-footer-btn:hover {
                color: var(--text2);
            }
            
            /* Profile themes in profile page */
            .profile-themes {
                display: flex;
                gap: 12px;
                justify-content: center;
                margin-top: 24px;
            }
            
            .sidebar-footer-icon {
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--input);
                border: 1px solid transparent;
                border-radius: 6px;
                color: var(--text2);
                text-decoration: none;
                position: relative;
                cursor: pointer;
            }
            
            .sidebar-footer-icon .material-symbols-outlined {
                font-size: 18px;
            }
            
            .sidebar-footer-icon:hover {
                opacity: 0.8;
            }
            
            .sidebar-footer-icon::after {
                content: attr(data-tooltip);
                position: absolute;
                bottom: 100%;
                right: 0;
                margin-bottom: 6px;
                padding: 4px 8px;
                background: var(--bg);
                color: var(--text2);
                font-size: 11px;
                font-family: inherit;
                border-radius: 4px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.15s ease, visibility 0.15s ease;
            }
            
            .sidebar-footer-icon:hover::after {
                opacity: 1;
                visibility: visible;
            }
            
            /* Footer icons when sidebar collapsed - show with right-side tooltips */
            .sidebar.collapsed .sidebar-footer-icon {
                display: flex;
                background: var(--input);
                color: var(--text2);
            }
            
            .sidebar.collapsed .sidebar-footer-icon::after {
                top: 50%;
                bottom: auto;
                left: 100%;
                right: auto;
                transform: translateY(-50%);
                margin-top: 0;
                margin-left: 8px;
                background: #161616;
                color: #F5F5F4;
            }
            
            /* Light theme button needs white background when collapsed */
            .sidebar.collapsed .theme-btn[data-t="light"] {
                background: #F5F5F4;
                box-shadow: inset 0 0 0 0.5px rgba(0,0,0,0.1);
            }
            
            /* Theme buttons collapsed tooltips */
            .sidebar.collapsed .theme-btn {
                position: relative;
            }
            
            .sidebar.collapsed .theme-btn::after {
                content: attr(data-tooltip);
                position: absolute;
                left: 100%;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 8px;
                padding: 4px 8px;
                background: #161616;
                color: #F5F5F4;
                font-size: 11px;
                font-family: inherit;
                font-weight: 400;
                border-radius: 4px;
                white-space: nowrap;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.15s ease, visibility 0.15s ease;
                pointer-events: none;
                z-index: 300;
            }
            
            .sidebar.collapsed .theme-btn:hover::after {
                opacity: 1;
                visibility: visible;
            }
            
            /* Spotify theme adjustments for footer icons */
            [data-theme="spotify"] .sidebar-footer-icon {
                background: rgba(255,255,255,0.15);
                border-color: rgba(255,255,255,0.15);
                color: rgba(255,255,255,0.85);
            }
            
            [data-theme="spotify"] .sidebar-footer-icon::after {
                background: rgba(255,255,255,0.15);
                color: rgba(255,255,255,0.85);
            }
            
            /* Hide mobile header on large screens when sidebar expanded */
            .header {
                display: none;
            }
            
            /* Allow normal scrolling on large screens */
            html, body {
                height: auto;
                overflow: auto;
                position: static;
            }
            
            /* Reset app container for sidebar layout */
            .app {
                height: auto;
                min-height: 100vh;
                display: block;
                padding: 0;
            }
            
            /* Adjust wrapper for sidebar - normal block layout */
            .wrapper {
                display: block;
                margin-left: 260px;
                width: calc(100% - 260px);
                max-width: none;
                padding: calc(var(--gap) + 1px + 14px) 40px var(--gap);
                transition: margin-left 0.3s ease, width 0.3s ease;
                height: auto;
            }
            
            .wrapper .content {
                overflow: visible;
            }
            
            /* When sidebar is collapsed */
            .sidebar.collapsed + .wrapper {
                margin-left: 48px;
                width: calc(100% - 48px);
                padding-left: 40px;
            }
            
            /* Floating toggle no longer needed - icons always visible */
            .sidebar-open-btn {
                display: none !important;
            }
            
            /* Hide back buttons on large screens */
            .share-back,
            .dive-back {
                display: none;
            }
            
            /* Align friend toolbar with sidebar title */
            .friend-toolbar {
                margin-top: -14px;
            }
        }
        
        /* Hide sidebar on mobile */
        @media (max-width: 767px) {
            .sidebar {
                display: none;
            }
            .sidebar-open-btn {
                display: none !important;
            }
        }
        
        /* --------------------------------------------
           CUSTOM MODAL
           -------------------------------------------- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.open {
            display: flex;
        }
        
        .modal {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 24px;
            max-width: 320px;
            width: 100%;
            text-align: center;
        }
        
        .modal-content {
            font-size: var(--font-small);
            color: var(--text2);
            line-height: var(--line-height);
            margin-bottom: 20px;
        }
        
        .modal-confirm-btns {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }
        
        .modal-link {
            display: inline-block;
            margin-top: 12px;
            font-size: var(--font-small);
            color: var(--text);
            text-decoration: none;
        }
        
        /* Save & Share Modal */
        .save-share-modal-content {
            text-align: left;
            max-width: 420px;
        }
        
        .modal-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .modal-desc {
            font-size: var(--font-small);
            color: var(--text2);
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .save-share-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .save-share-col {
            display: flex;
            flex-direction: column;
        }
        
        .save-share-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .save-share-modal-content .pl-input {
            width: 100%;
            margin-bottom: 0;
        }
        
        .save-share-select {
            width: 100%;
        }
        
        .save-share-select .custom-select-btn {
            width: 100%;
            padding: 10px;
            background: var(--input);
            border-radius: var(--radius-sm);
            box-shadow: none;
        }
        
        .save-share-select .custom-select-options {
            width: 100%;
            left: 0;
        }
        
        .save-share-actions {
            display: flex;
            gap: 8px;
        }
        
        .save-share-actions .action-btn {
            flex: 1;
        }
        
        .modal-feedback {
            margin-top: 16px;
            font-size: var(--font-small);
            color: var(--accent);
            text-align: center;
            min-height: 20px;
        }
        
        .modal-feedback.success {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .modal-feedback .material-symbols-outlined {
            font-size: 18px;
        }
        
        .modal-field {
            margin-bottom: 16px;
        }
        
        .modal-field .pl-input {
            width: 100%;
            margin-bottom: 0;
        }
        
        .modal-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .modal-row .pl-input {
            margin-bottom: 0;
        }
        
        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .modal-link:active {
            opacity: 0.6;
        }
        
        /* Welcome Popup */
        .welcome-overlay {
            display: none;
            position: fixed;
            inset: 0;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background: rgba(0,0,0,0.3);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .welcome-overlay.open {
            display: flex;
        }
        
        .welcome-popup {
            background: var(--card);
            border-radius: var(--radius-lg);
            box-shadow: 0 12px 40px rgba(0,0,0,0.25), 0 4px 12px rgba(0,0,0,0.15);
            padding: 28px 24px;
            max-width: 320px;
            width: 100%;
            text-align: left;
        }
        
        .welcome-title {
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            color: var(--text);
            margin-bottom: 16px;
            text-align: center;
        }
        
        .welcome-intro {
            font-size: 13px;
            color: var(--text2);
            line-height: var(--line-height);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-features {
            margin-bottom: 24px;
        }
        
        .welcome-feature {
            display: flex;
            gap: 12px;
            margin-bottom: 14px;
        }
        
        .welcome-feature:last-child {
            margin-bottom: 0;
        }
        
        .welcome-feature-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            background: var(--input);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }
        
        .welcome-feature-icon .material-symbols-outlined {
            font-size: 20px;
        }
        
        .welcome-feature-text {
            flex: 1;
        }
        
        .welcome-feature-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text2);
            margin-bottom: 2px;
        }
        
        .welcome-feature-desc {
            font-size: 14px;
            color: var(--text3);
            line-height: 1.4;
        }
        
        /* Desktop: smaller welcome popup text */
        @media (min-width: 768px) {
            .welcome-title {
                font-size: 13px;
            }
            .welcome-feature-icon {
                width: 32px;
                height: 32px;
                min-width: 32px;
            }
            .welcome-feature-icon .material-symbols-outlined {
                font-size: 18px;
            }
            .welcome-feature-title {
                font-size: 13px;
            }
            .welcome-feature-desc {
                font-size: 12px;
            }
        }
        
        .welcome-profile {
            margin-bottom: 20px;
        }
        
        .welcome-profile-label {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .welcome-profile .pl-input {
            margin-bottom: 0;
        }
        
        .welcome-btn {
            display: block;
            width: 100%;
            font-size: var(--font-button);
            font-family: inherit;
            font-weight: 600;
            color: #fff;
            background: var(--text);
            border: none;
            border-radius: var(--radius-sm);
            padding: 14px 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        
        [data-theme="dark"] .welcome-btn {
            background: var(--input);
            color: var(--text);
        }
        
        .welcome-btn:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        /* --------------------------------------------
           MOBILE PHONE LAYOUT
           -------------------------------------------- */
        /* Hide mobile elements by default */
        .mobile-header,
        .mobile-top-tray,
        .mobile-bottom-tray,
        .mobile-more-menu {
            display: none !important;
        }
        
        /* Show mobile elements only on mobile phones */
        body.mobile-phone .mobile-top-tray,
        body.mobile-phone .mobile-bottom-tray {
            display: flex !important;
        }
        
        /* Hide mobile header - music note icon serves as logo */
        body.mobile-phone .mobile-header {
            display: none !important;
        }
        
        body.mobile-phone .mobile-more-menu.open {
            display: block !important;
        }
        
        /* Hide desktop header on mobile phones */
        body.mobile-phone .header {
            display: none;
        }
        
        /* Hide embed section on mobile phones */
        body.mobile-phone .embed-section {
            display: none !important;
        }
        
        /* Mobile Top Tray - positioned below dynamic island */
        body.mobile-phone .mobile-top-tray {
            position: fixed;
            top: var(--safe-t);
            left: 0;
            right: 0;
            height: 48px;
            background: var(--card);
            z-index: 200;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            /* Extend background slightly to cover any subpixel gaps in Safari */
            border-bottom: 1px solid var(--card);
        }
        
        body.mobile-phone[data-theme="dark"] .mobile-top-tray {
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .mobile-top-scroll {
            display: flex;
            align-items: center;
            width: 100%;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-left: calc(var(--safe-l) + 12px);
            padding-right: calc(var(--safe-r) + 12px);
            background: var(--card);
        }
        .mobile-top-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .mobile-top-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text3);
            cursor: pointer;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .mobile-top-icon .material-symbols-outlined {
            font-size: 22px;
        }
        .mobile-top-icon:active {
            opacity: 0.5;
        }
        .mobile-top-icon.active {
            color: var(--text);
        }
        
        .mobile-top-divider {
            width: 1px;
            height: 24px;
            background: var(--text3);
            opacity: 0.3;
            margin: 0 12px;
            flex-shrink: 0;
        }
        
        .mobile-top-content {
            display: flex;
            align-items: center;
        }
        
        .mobile-top-placeholder {
            font-size: var(--font-small);
            color: var(--text3);
            font-style: italic;
        }
        
        .mobile-top-paste {
            font-size: var(--font-small);
            font-family: inherit;
            font-style: italic;
            color: var(--text2);
            background: transparent;
            border: none;
            outline: none;
            min-width: 200px;
        }
        
        .mobile-top-paste::placeholder {
            color: var(--text3);
            font-style: italic;
        }
        
        .mobile-top-item {
            display: inline-block;
            padding: 8px 6px;
            font-size: 12px;
            color: var(--text2);
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
        }
        .mobile-top-item:active {
            opacity: 0.5;
        }
        .mobile-top-item.active {
            color: var(--text);
            font-weight: 600;
        }
        
        /* Mobile Bottom Tray */
        body.mobile-phone .mobile-bottom-tray {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            display: flex !important;
            align-items: center;
            justify-content: space-evenly;
            height: 48px;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 200;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.12);
            box-sizing: content-box;
        }
        
        body.mobile-phone .mobile-bottom-tray-inner {
            display: contents;
        }
        
        body.mobile-phone .mobile-bottom-tray-safe {
            display: none;
        }
        
        /* Safari standalone PWA */
        body.mobile-phone.pwa-standalone .mobile-bottom-tray {
            padding-bottom: 16px;
        }
        
        body.mobile-phone[data-theme="dark"] .mobile-bottom-tray {
            box-shadow: 0 -1px 3px rgba(0,0,0,0.25);
        }
        
        .mobile-bottom-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: none;
            border: none;
            color: var(--text3);
            cursor: pointer;
            font-family: inherit;
        }
        .mobile-bottom-item .material-symbols-outlined {
            font-size: 22px;
        }
        .mobile-bottom-item:active {
            opacity: 0.5;
        }
        .mobile-bottom-item.active {
            color: var(--text);
        }
        
        .mobile-bottom-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .mobile-bottom-avatar .material-symbols-outlined {
            font-size: 22px;
            color: var(--text2);
        }
        .mobile-bottom-avatar .avatar-letter {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text2);
        }
        .mobile-bottom-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* When has photo, show circle background */
        .mobile-bottom-avatar.has-photo {
            background: #161616;
        }
        [data-theme="dark"] .mobile-bottom-avatar.has-photo {
            background: #F0F0EF;
        }
        
        .mobile-bottom-label {
            display: none;
        }
        
        /* Mobile More Menu */
        .mobile-more-menu {
            position: fixed;
            bottom: calc(56px + var(--safe-b));
            right: 8px;
            background: var(--card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow), 0 4px 20px rgba(0,0,0,0.15);
            padding: 4px 0;
            min-width: 140px;
            z-index: 250;
        }
        .mobile-more-menu.open {
            display: block;
        }
        
        .mobile-more-item {
            display: block;
            width: 100%;
            padding: 6px 16px;
            text-align: left;
            font-size: var(--font-menu);
            font-family: inherit;
            color: var(--text2);
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        .mobile-more-item:hover {
            background: #F0F0EF;
        }
        .mobile-more-item:active {
            background: #E6E6E5;
        }
        [data-theme="dark"] .mobile-more-item:hover {
            background: #2C2C2C;
        }
        [data-theme="dark"] .mobile-more-item:active {
            background: #333333;
        }
        
        .mobile-more-themes {
            padding: 10px 16px;
            display: flex;
            justify-content: center;
        }
        
        .mobile-more-label {
            font-size: var(--font-small);
            color: var(--text3);
            margin-bottom: 8px;
        }
        
        .mobile-themes {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .mobile-more-divider {
            height: 1px;
            background: var(--input);
            margin: 4px 0;
        }
        
        /* Adjust app layout for mobile phone */
        body.mobile-phone .app {
            padding-top: calc(48px + var(--safe-t)) !important;
            padding-bottom: 48px !important;
        }
        
        body.mobile-phone .wrapper {
            height: 100%;
        }
        
        /* Add spacing on mobile content - this scrolls with content */
        body.mobile-phone #main,
        body.mobile-phone #dive,
        body.mobile-phone #edit,
        body.mobile-phone #share,
        body.mobile-phone #profile,
        body.mobile-phone #about,
        body.mobile-phone #help,
        body.mobile-phone #widget,
        body.mobile-phone #friend {
            padding-top: 16px;
            padding-bottom: 16px;
        }
        
        /* Mobile font sizes for back links and footer */
        body.mobile-phone .txt-btn {
            font-size: 11px;
        }
        
        body.mobile-phone .footer-txt,
        body.mobile-phone .footer {
            font-size: 11px;
        }
        
        /* Weight 500 for tray icons on mobile */
        body.mobile-phone .mobile-top-icon .material-symbols-outlined,
        body.mobile-phone .mobile-bottom-item .material-symbols-outlined {
            font-weight: 500;
        }
        
        /* Ensure bottom tray is always visible and fixed */
        body.mobile-phone .mobile-bottom-tray {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <!-- Welcome Popup (first visit only) -->
    <div class="welcome-overlay" id="welcome-overlay">
        <div class="welcome-popup">
            <div class="welcome-title">MIXTAPED</div>
            <p class="welcome-intro">You build playlists in Spotify. We curate and share a master mixtape of your favorites.</p>
            <div class="welcome-features">
                <div class="welcome-feature">
                    <div class="welcome-feature-icon"><span class="material-symbols-outlined">grid_view</span></div>
                    <div class="welcome-feature-text">
                        <div class="welcome-feature-title">Quick Access</div>
                        <div class="welcome-feature-desc">Your favorite Spotify playlists, one tap away.</div>
                    </div>
                </div>
                <div class="welcome-feature">
                    <div class="welcome-feature-icon"><span class="material-symbols-outlined">heart_check</span></div>
                    <div class="welcome-feature-text">
                        <div class="welcome-feature-title">Curate</div>
                        <div class="welcome-feature-desc">Send your entire collection with a single code.</div>
                    </div>
                </div>
                <div class="welcome-feature">
                    <div class="welcome-feature-icon"><span class="material-symbols-outlined">person_heart</span></div>
                    <div class="welcome-feature-text">
                        <div class="welcome-feature-title">Collaborate</div>
                        <div class="welcome-feature-desc">Build mixtapes with friends.</div>
                    </div>
                </div>
            </div>
            <button class="welcome-btn" id="welcome-btn">Get Started</button>
        </div>
    </div>
    
    <!-- Custom Modal -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-content" id="modal-content"></div>
            <button class="action-btn" id="modal-btn">OK</button>
        </div>
    </div>
    
    <!-- Save & Share Modal -->
    <div class="modal-overlay" id="save-share-modal">
        <div class="modal save-share-modal-content">
            <div class="modal-header">Save & Share</div>
            <p class="modal-desc">Save your mixtape to your collection and share it with friends.</p>
            
            <div class="save-share-grid">
                <div class="save-share-col">
                    <label class="save-share-label">Title</label>
                    <input class="pl-input" type="text" id="save-share-title" placeholder="Give it a name">
                </div>
                <div class="save-share-col">
                    <label class="save-share-label">Occasion</label>
                    <div class="custom-select save-share-select" id="save-share-template-wrap">
                        <div class="custom-select-btn" id="save-share-template-btn">
                            <span id="save-share-template-label">Select</span>
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <div class="custom-select-options" id="save-share-template-options">
                            <div class="custom-select-option" data-value="favorites" data-icon="album">Favorites</div>
                            <div class="custom-select-option" data-value="roadtrip" data-icon="directions_car">Road Trip</div>
                            <div class="custom-select-option" data-value="dinner" data-icon="dining">Dinner Party</div>
                            <div class="custom-select-option" data-value="workout" data-icon="directions_run">Workout</div>
                            <div class="custom-select-option" data-value="podcast" data-icon="podcasts">Podcast</div>
                            <div class="custom-select-option" data-value="focus" data-icon="mindfulness">Focus</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="save-share-actions">
                <button class="action-btn" id="save-share-cancel">Cancel</button>
                <button class="action-btn" id="save-share-confirm">Save & Copy Link</button>
            </div>
            <div class="modal-feedback" id="save-share-feedback"></div>
        </div>
    </div>
    
    <!-- Playlist Edit Modal -->
    <div class="modal-overlay" id="playlist-edit-modal">
        <div class="modal save-share-modal-content" style="max-width: 400px;">
            <div class="modal-header">Edit Playlist</div>
            <div class="pl-item" style="border: none; padding: 0; align-items: flex-start;">
                <div class="pl-preview-wrap" id="playlist-edit-preview-wrap">
                    <div class="pl-preview" id="playlist-edit-preview">
                        <span class="material-symbols-outlined">music_note_2</span>
                    </div>
                    <button class="pl-delete" id="playlist-edit-delete">Delete</button>
                </div>
                <div class="pl-fields" style="flex: 1;">
                    <input class="pl-input url" type="url" id="playlist-edit-url" placeholder="Add Spotify playlist URL" autocapitalize="off" autocorrect="off" style="margin-bottom: 8px;">
                    <div class="pl-title" id="playlist-edit-title">Name will fill when you add playlist URL above</div>
                    <textarea class="pl-input pl-desc" id="playlist-edit-desc" placeholder="Add description" rows="3" style="margin-top: 8px; min-height: 60px;"></textarea>
                    <div class="playlist-edit-actions" style="display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end;">
                        <button class="action-btn" id="playlist-edit-cancel">Cancel</button>
                        <button class="action-btn" id="playlist-edit-save">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app">
        <!-- Mobile Header -->
        <div class="mobile-header" id="mobile-header">
            <span class="mobile-header-title">MIXTAPED</span>
        </div>
        
        <!-- Mobile Top Tray -->
        <div class="mobile-top-tray" id="mobile-top-tray">
            <div class="mobile-top-scroll" id="mobile-top-scroll">
                <button class="mobile-top-icon" id="mobile-mixtapes-btn"><span class="material-symbols-outlined">headphones</span></button>
                <button class="mobile-top-icon" id="mobile-collab-btn"><span class="material-symbols-outlined">person_heart</span></button>
                <button class="mobile-top-icon" id="mobile-add-btn"><span class="material-symbols-outlined">add</span></button>
                <div class="mobile-top-divider"></div>
                <span class="mobile-top-content" id="mobile-top-content"></span>
            </div>
        </div>
        
        <!-- Mobile Bottom Tray -->
        <div class="mobile-bottom-tray" id="mobile-bottom-tray">
            <div class="mobile-bottom-tray-inner">
                <button class="mobile-bottom-item active" id="mobile-grid-btn">
                    <span class="material-symbols-outlined">dashboard_customize</span>
                    <span class="mobile-bottom-label">Grid</span>
                </button>
                <button class="mobile-bottom-item" id="mobile-edit-btn">
                    <span class="material-symbols-outlined">edit_square</span>
                    <span class="mobile-bottom-label">Edit</span>
                </button>
                <button class="mobile-bottom-item" id="mobile-share-btn">
                    <span class="material-symbols-outlined">heart_check</span>
                    <span class="mobile-bottom-label">Curate</span>
                </button>
                <button class="mobile-bottom-item" id="mobile-profile-btn">
                    <span class="mobile-bottom-avatar" id="mobile-bottom-avatar">
                        <span class="material-symbols-outlined">person</span>
                    </span>
                    <span class="mobile-bottom-label">Profile</span>
                </button>
                <button class="mobile-bottom-item" id="mobile-more-btn">
                    <span class="material-symbols-outlined">menu</span>
                    <span class="mobile-bottom-label">More</span>
                </button>
            </div>
            <div class="mobile-bottom-tray-safe"></div>
        </div>
        
        <!-- Mobile More Menu -->
        <div class="mobile-more-menu" id="mobile-more-menu">
            <button class="mobile-more-item" id="mobile-dive-btn">Deep Dive</button>
            <button class="mobile-more-item" id="mobile-about-btn">About</button>
            <button class="mobile-more-item" id="mobile-widget-btn">iOS Widget</button>
            <button class="mobile-more-item" id="mobile-help-btn">Help</button>
            <a class="mobile-more-item" href="/cdn-cgi/l/email-protection#036e6a7b776273666743646e626a6f2d606c6e">Email</a>
            <a class="mobile-more-item" href="https://buymeacoffee.com/fromnineteen80" target="_blank">Donate</a>
        </div>
        
        <!-- Sidebar for larger screens -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title" id="sidebar-title">MIXTAPED</div>
                <button class="sidebar-toggle" id="sidebar-toggle" data-tooltip="Expand">
                    <span class="material-symbols-outlined icon-expanded">first_page</span>
                    <span class="material-symbols-outlined icon-collapsed">thumbnail_bar</span>
                </button>
            </div>
            <nav class="sidebar-nav">
                <button class="sidebar-item active" id="sidebar-grid-btn" data-tooltip="Grid Layout"><span class="material-symbols-outlined">dashboard_customize</span><span class="sidebar-text">Grid Layout</span></button>
                <button class="sidebar-item" id="sidebar-dive-btn" data-tooltip="Deep Dive"><span class="material-symbols-outlined">format_image_left</span><span class="sidebar-text">Deep Dive</span></button>
                <div class="sidebar-divider"></div>
                <button class="sidebar-item" id="sidebar-edit-btn" data-tooltip="Edit"><span class="material-symbols-outlined">edit_square</span><span class="sidebar-text">Edit</span></button>
                <button class="sidebar-item" id="sidebar-share-btn" data-tooltip="Curate"><span class="material-symbols-outlined">heart_check</span><span class="sidebar-text">Curate</span></button>
                <button class="sidebar-item" id="sidebar-about-btn" data-tooltip="About"><span class="material-symbols-outlined">page_info</span><span class="sidebar-text">About</span></button>
                <button class="sidebar-item" id="sidebar-widget-btn" data-tooltip="iOS Widget"><span class="material-symbols-outlined">phone_iphone</span><span class="sidebar-text">iOS Widget</span></button>
                <div class="sidebar-divider"></div>
                <div class="sidebar-dropdown">
                    <button class="sidebar-item sidebar-dropdown-toggle" id="sidebar-mixtapes-toggle" data-tooltip="Mixtapes">
                        <span class="material-symbols-outlined">headphones</span>
                        <span class="sidebar-text">Mixtapes</span>
                        <svg class="sidebar-dropdown-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div class="sidebar-dropdown-content" id="sidebar-mixtapes"></div>
                </div>
                <div class="sidebar-dropdown">
                    <button class="sidebar-item sidebar-dropdown-toggle" id="sidebar-collaborate-toggle" data-tooltip="Collaborate">
                        <span class="material-symbols-outlined">person_heart</span>
                        <span class="sidebar-text">Collaborate</span>
                        <svg class="sidebar-dropdown-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div class="sidebar-dropdown-content" id="sidebar-collaborate">
                        <div class="no-mixtapes">Ask a friend</div>
                    </div>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-profile-section">
                    <div class="sidebar-profile-clickable" id="sidebar-profile-section">
                        <button class="sidebar-profile-avatar" id="sidebar-profile-avatar">
                            <span class="material-symbols-outlined">person</span>
                        </button>
                        <div class="sidebar-profile-text">
                            <span class="sidebar-profile-name" id="sidebar-profile-name"></span>
                            <span class="sidebar-profile-username" id="sidebar-profile-username"></span>
                        </div>
                    </div>
                    <div class="sidebar-profile-links" id="sidebar-profile-links" style="display: none;">
                        <button class="sidebar-profile-link" id="sidebar-help-btn"><span class="material-symbols-outlined">tooltip_2</span></button>
                        <a class="sidebar-profile-link" href="/cdn-cgi/l/email-protection#91fcf8e9e5f0e1f4f5d1f6fcf0f8fdbff2fefc"><span class="material-symbols-outlined">mail</span></a>
                        <a class="sidebar-profile-link" href="https://buymeacoffee.com/fromnineteen80" target="_blank"><span class="material-symbols-outlined">local_cafe</span></a>
                    </div>
                </div>
            </div>
        </aside>
        <div class="wrapper">
            <!-- Floating button to open sidebar when collapsed -->
            <button class="sidebar-open-btn" id="sidebar-open-btn">
                <span class="material-symbols-outlined">thumbnail_bar</span>
            </button>
            <!-- Universal Header -->
            <header class="header">
                <span class="title" id="title-btn">MIXTAPED</span>
                <div class="dropdown">
                    <button class="menu-btn" id="menu-btn"><span class="material-symbols-outlined">menu</span></button>
                    <div class="dropdown-content" id="menu">
                        <button class="menu-item" id="grid-btn">Grid Layout</button>
                        <button class="menu-item" id="dive-btn">Deep Dive</button>
                        <div class="menu-divider"></div>
                        <button class="menu-item" id="edit-btn">Edit</button>
                        <button class="menu-item" id="share-btn">Curate</button>
                        <button class="menu-item" id="about-btn">About</button>
                        <button class="menu-item" id="widget-btn">iOS Widget</button>
                        <div class="menu-divider"></div>
                        <button class="menu-label menu-collapse" id="menu-mixtapes-toggle">Mixtapes<svg class="menu-collapse-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button>
                        <div class="mixtapes-list" id="mixtapes-list"></div>
                        <button class="menu-label menu-collapse" id="menu-collab-toggle">Collaborate<svg class="menu-collapse-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button>
                        <div class="mixtapes-list" id="collab-list"></div>
                        <div class="menu-divider"></div>
                        <div class="menu-profile-section">
                            <div class="menu-profile-clickable" id="menu-profile-section">
                                <button class="menu-profile-avatar" id="menu-profile-avatar">
                                    <span class="material-symbols-outlined">person</span>
                                </button>
                                <div class="menu-profile-text">
                                    <span class="menu-profile-name" id="menu-profile-name"></span>
                                    <span class="menu-profile-username" id="menu-profile-username"></span>
                                </div>
                            </div>
                            <div class="menu-profile-links" id="menu-profile-links" style="display: none;">
                                <button class="menu-profile-link" id="menu-help-btn"><span class="material-symbols-outlined">tooltip_2</span></button>
                                <a class="menu-profile-link" href="/cdn-cgi/l/email-protection#83eeeafbf7e2f3e6e7c3e4eee2eaefade0ecee"><span class="material-symbols-outlined">mail</span></a>
                                <a class="menu-profile-link" href="https://buymeacoffee.com/fromnineteen80" target="_blank"><span class="material-symbols-outlined">local_cafe</span></a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content">
                <!-- Main View -->
                <div class="view on" id="main">
                    <div class="main-toolbar" id="main-toolbar" style="display: none;">
                        <div class="mixtape-title-info">
                            <span class="mixtape-title" id="main-title"></span>
                            <span class="mixtape-occasion" id="main-occasion" style="display: none;">
                                <span class="material-symbols-outlined" id="main-occasion-icon"></span>
                                <span id="main-occasion-label"></span>
                            </span>
                        </div>
                        <div class="edit-actions">
                            <button class="action-btn" id="main-edit-btn">Edit</button>
                            <button class="action-btn" id="main-copy-btn">Copy</button>
                            <button class="action-btn" id="main-save-btn">Save</button>
                            <button class="action-btn" id="main-new-btn">New</button>
                        </div>
                    </div>
                    <div class="grid" id="grid"></div>
                    <div class="embed-section" id="main-embed-section" style="display: none;">
                        <div class="embed-divider"></div>
                        <div class="embed-container">
                            <div class="embed-playlist-list" id="main-embed-list"></div>
                            <div class="embed-player" id="main-embed-player"></div>
                            <div class="embed-spacer"></div>
                        </div>
                    </div>
                </div>

                <!-- Deep Dive View -->
                <div class="view" id="dive">
                    <div class="main-toolbar" id="dive-toolbar" style="display: none;">
                        <div class="mixtape-title-info">
                            <span class="mixtape-title" id="dive-title"></span>
                            <span class="mixtape-occasion" id="dive-occasion" style="display: none;">
                                <span class="material-symbols-outlined" id="dive-occasion-icon"></span>
                                <span id="dive-occasion-label"></span>
                            </span>
                        </div>
                        <div class="edit-actions">
                            <button class="action-btn" id="dive-edit-btn">Edit</button>
                            <button class="action-btn" id="dive-copy-btn">Copy</button>
                            <button class="action-btn" id="dive-save-btn">Save</button>
                            <button class="action-btn" id="dive-new-btn">New</button>
                        </div>
                    </div>
                    <div class="dive-list" id="dive-list"></div>
                </div>

                <!-- Share View -->
                <div class="view" id="share">
                    <div class="about-hero">
                        <img src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?q=80&w=1200&auto=format&fit=crop" alt="Concert crowd">
                        <div class="about-hero-overlay">
                            <h1 class="about-hero-title">Curate Your <span>MIXTAPED</span></h1>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="edit-toolbar">
                            <div class="section-hd">Generate Code</div>
                        </div>
                        <p class="section-desc">Remember making mixtapes for your friends? Here we are in the future sharing Spotify playlists. But the vibe is so much more than one playlist. It can be a season, a theme, your favorite genres. Whatever you want it to be or say about you. Generate a code and share your favorite playlists with someone who needs to hear what you've been listening to. They will see your mixtape in the Deep Dive format so adding descriptions to each of your playlists will add helpful context.</p>
                        <p class="section-desc" style="margin-top: 12px;"><span style="font-weight: 600;">Tip:</span> To backup everything including your collected and collaborated mixtapes, go to Recover and generate a full backup code.</p>
                        <div class="card">
                            <div class="pl-item" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <input class="pl-input" type="text" id="share-name" placeholder="Your name" style="flex: 1; min-width: 100px; margin-bottom: 0;">
                                <input class="pl-input" type="text" id="share-title" placeholder="Mixtape title" style="flex: 1; min-width: 100px; margin-bottom: 0;">
                                <button class="action-btn" id="generate-btn">Generate</button>
                            </div>
                        </div>
                        <div class="share-output" id="share-output"></div>
                    </div>
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Add a Friend's <span class="brand">Mixtape</span></div>
                        </div>
                        <p class="section-desc">Got the hookup from a friend? Paste it here and start listening to their favorite tunes. Perfect for road trips, parties, or when you just need someone else to be the DJ. The latest five mixtapes you save, along with your favorites, will be available in your menu. And every mixtape you collect is available below.</p>
                        <div class="card">
                            <div class="pl-item" style="display: flex; gap: 8px; align-items: center;">
                                <input class="pl-input" type="text" id="import-string" placeholder="Paste code here" style="flex: 1; margin-bottom: 0;">
                                <button class="action-btn" id="import-btn">Add</button>
                            </div>
                        </div>
                    </div>
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Curate Your Own <span class="brand">Mixtapes</span></div>
                        </div>
                        <p class="section-desc">Save the mixtapes you created for quick access. Pick a template that matches the vibe, paste your share code, and it'll appear in your Mixtapes with the right icon. Perfect for road trips, focus sessions, or any collection you want at your fingertips.</p>
                        <div class="card has-dropdown">
                            <div class="pl-item" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <div class="custom-select inline" id="template-select-wrap">
                                    <div class="custom-select-btn" id="template-select-btn">
                                        <span id="template-select-label">Select</span>
                                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                    </div>
                                    <div class="custom-select-options" id="template-select-options">
                                        <div class="custom-select-option" data-value="favorites" data-icon="album">Favorites</div>
                                        <div class="custom-select-option" data-value="roadtrip" data-icon="directions_car">Road Trip</div>
                                        <div class="custom-select-option" data-value="dinner" data-icon="dining">Dinner Party</div>
                                        <div class="custom-select-option" data-value="workout" data-icon="directions_run">Workout</div>
                                        <div class="custom-select-option" data-value="podcast" data-icon="podcasts">Podcast</div>
                                        <div class="custom-select-option" data-value="focus" data-icon="mindfulness">Focus</div>
                                    </div>
                                </div>
                                <input class="pl-input" type="text" id="curate-string" placeholder="Paste your code here" style="flex: 1; min-width: 120px; margin-bottom: 0;">
                                <button class="action-btn" id="curate-btn">Save</button>
                            </div>
                        </div>
                    </div>
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Collected <span class="brand">Mixtapes</span></div>
                            <div class="custom-select inline" id="mixtape-filter-wrap">
                                <div class="custom-select-btn" id="mixtape-filter-btn">
                                    <span id="mixtape-filter-label">Newest</span>
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                </div>
                                <div class="custom-select-options" id="mixtape-filter-options">
                                    <div class="custom-select-option selected" data-value="newest">Newest</div>
                                    <div class="custom-select-option" data-value="oldest">Oldest</div>
                                    <div class="custom-select-option" data-value="friend">Friend A-Z</div>
                                </div>
                            </div>
                        </div>
                        <div class="collected-list" id="collected-list"></div>
                    </div>
                    <div class="share-back">
                        <button class="txt-btn" id="share-back-btn">Back</button>
                    </div>
                </div>

                <!-- Profile View -->
                <div class="view" id="profile">
                    
                    <!-- Profile Card - Edit Mode (no data) -->
                    <div class="profile-card-edit" id="profile-card-edit">
                        <div class="profile-card-avatar-col">
                            <div class="profile-card-avatar" id="profile-card-avatar">
                                <span class="material-symbols-outlined">person</span>
                            </div>
                            <button class="profile-avatar-delete-btn" id="profile-avatar-delete-edit" style="display: none;">×</button>
                            <span class="profile-field-meta" id="profile-photo-btn">Update</span>
                        </div>
                        <div class="profile-field-col">
                            <label class="profile-field-label">Spotify Username</label>
                            <input class="pl-input" type="text" id="profile-spotify-username" placeholder="@username">
                            <span class="profile-field-meta">Fills photo</span>
                        </div>
                        <div class="profile-field-col">
                            <label class="profile-field-label">Your Name <span class="required">*</span></label>
                            <input class="pl-input" type="text" id="profile-name" placeholder="Your name">
                            <span class="profile-field-meta">Required</span>
                        </div>
                        <div class="profile-btn-col">
                            <button class="action-btn" id="profile-save-btn">Save</button>
                        </div>
                        <input type="file" id="profile-photo-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <!-- Profile Card - Display Mode (has data) -->
                    <div class="profile-card-display" id="profile-card-display" style="display: none;">
                        <div class="profile-card-left">
                            <div class="profile-card-avatar-wrap">
                                <div class="profile-card-avatar-large" id="profile-card-avatar-large">
                                    <span class="material-symbols-outlined">person</span>
                                </div>
                            </div>
                            <div class="profile-card-info">
                                <div class="profile-card-name" id="profile-card-name"></div>
                                <div class="profile-card-username" id="profile-card-username"></div>
                                <button class="profile-card-edit-btn" id="profile-card-edit-btn">Edit</button>
                            </div>
                        </div>
                        <div class="profile-card-right">
                            <div class="profile-stat">You saved <span id="profile-stat-saved">0</span> mixtapes</div>
                            <div class="profile-stat">Collaborated on <span id="profile-stat-collab">0</span> mixtapes</div>
                            <div class="profile-stat">Your friends shared <span id="profile-stat-friends">0</span> mixtapes</div>
                        </div>
                    </div>
                    
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Vestaboard</div>
                        </div>
                        <p class="section-desc">Get notified on your Vestaboard when friends listen to mixtapes you've shared.</p>
                        <div class="card" id="vestaboard-card">
                            <div class="pl-item" id="vestaboard-edit-mode" style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <input class="pl-input" type="text" id="vestaboard-api-key" placeholder="Vestaboard API Key" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                                <button class="action-btn" id="vestaboard-test-btn">Save</button>
                            </div>
                            <div class="pl-item" id="vestaboard-display-mode" style="display: none; gap: 8px; align-items: center; justify-content: space-between;">
                                <span class="vestaboard-key-display" id="vestaboard-key-display"></span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="action-btn" id="vestaboard-edit-btn">Edit</button>
                                    <button class="action-btn" id="vestaboard-delete-btn">Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="share-output" id="vestaboard-output"></div>
                    </div>
                    
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Backup</div>
                        </div>
                        
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="card-label">GitHub Gist (Recommended)</div>
                            <div class="pl-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input class="pl-input" type="text" id="gist-url" placeholder="Paste your gist raw URL" style="flex: 1; margin-bottom: 0;">
                                    <button class="action-btn" id="save-gist-btn">Save</button>
                                </div>
                                <p class="card-hint">Don't have a gist? <a href="https://gist.github.com" target="_blank" style="color: var(--accent); text-decoration: none;">Create one here</a>, paste any text, save it, then click "Raw" and copy that URL.</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-label">Manual Backup</div>
                            <div class="pl-item">
                                <button class="action-btn full" id="backup-btn">Generate Backup Code</button>
                            </div>
                        </div>
                        <div class="share-output" id="backup-output"></div>
                    </div>
                    
                    <div class="section" style="margin-top: 32px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Restore</div>
                        </div>
                        
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="card-label">From GitHub Gist</div>
                            <div class="pl-item" style="flex-direction: column; align-items: stretch; gap: 8px;">
                                <button class="action-btn full" id="restore-gist-btn">Restore from Gist</button>
                                <p class="card-hint">Automatically fetches your latest backup from the gist URL saved above.</p>
                                <p class="card-hint" id="gist-status"></p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-label">From Backup Code</div>
                            <div class="pl-item" style="display: flex; gap: 8px; align-items: center;">
                                <input class="pl-input" type="text" id="recovery-string" placeholder="Paste your backup code" style="flex: 1; margin-bottom: 0;">
                                <button class="action-btn" id="recovery-btn">Restore</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-theme-picker" id="profile-theme-picker">
                        <button class="profile-theme-picker-btn" data-theme="light"><span class="material-symbols-outlined">format_paint</span></button>
                        <button class="profile-theme-picker-btn" data-theme="dark"><span class="material-symbols-outlined">format_paint</span></button>
                        <button class="profile-theme-picker-btn" data-theme="spotify"><span class="material-symbols-outlined">format_paint</span></button>
                    </div>
                </div>

                <!-- Widget View -->
                <div class="view" id="widget">
                    <div class="about-hero">
                        <img src="https://images.unsplash.com/photo-1592750475338-74b7b21085ab?q=80&w=1200&auto=format&fit=crop" alt="iPhone">
                        <div class="about-hero-overlay">
                            <h1 class="about-hero-title">iOS Widget for <span>MIXTAPED</span></h1>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="edit-toolbar">
                            <div class="section-hd">Widget Sizes</div>
                        </div>
                        <p class="section-desc">Put your mixtape on your iPhone home screen. Each playlist cover is tappable and opens directly in Spotify. Requires the free <a href="https://apps.apple.com/app/widgy/id1524540481" target="_blank" style="color: var(--text); text-decoration: none;">Widgy app</a> from the App Store.</p>
                        <div class="widget-sizes-grid">
                            <div class="widget-size-card">
                                <div class="widget-size-preview small-preview">
                                    <div class="preview-grid" style="grid-template-columns: repeat(2, 1fr);"><span></span><span></span><span></span><span></span></div>
                                </div>
                                <div class="widget-size-info">
                                    <div class="widget-size-name">Small</div>
                                    <div class="widget-size-desc">1-4 playlists</div>
                                </div>
                            </div>
                            <div class="widget-size-card">
                                <div class="widget-size-preview medium-preview">
                                    <div class="preview-grid" style="grid-template-columns: repeat(3, 1fr);"><span></span><span></span><span></span></div>
                                </div>
                                <div class="widget-size-info">
                                    <div class="widget-size-name">Medium</div>
                                    <div class="widget-size-desc">3-4 playlists</div>
                                </div>
                            </div>
                            <div class="widget-size-card">
                                <div class="widget-size-preview large-preview">
                                    <div class="preview-grid" style="grid-template-columns: repeat(3, 1fr);"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                                </div>
                                <div class="widget-size-info">
                                    <div class="widget-size-name">Large</div>
                                    <div class="widget-size-desc">6-9 playlists</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">How to Install</div>
                        </div>
                        <div class="help-section" style="margin-bottom: 0;">
                            <div class="help-q">Step 1: Download Widgy</div>
                            <p class="help-a">Install the free <a href="https://apps.apple.com/app/widgy/id1524540481" target="_blank" style="color: var(--text); text-decoration: none;">Widgy app</a> from the App Store if you haven't already.</p>
                            
                            <div class="help-q">Step 2: Generate Widget</div>
                            <p class="help-a">Choose your size, style, and density below, then tap Generate. You'll get a downloadable file.</p>
                            
                            <div class="help-q">Step 3: Import to Widgy</div>
                            <p class="help-a">Tap the downloaded .widgy file to open it directly in Widgy.</p>
                            
                            <div class="help-q">Step 4: Add to Home Screen</div>
                            <p class="help-a">In Widgy, go to the Manage tab and assign your widget to a slot. Then add the Widgy widget to your home screen through iOS's normal widget picker.</p>
                        </div>
                    </div>
                    
                    <div class="section" style="margin-top: 48px;">
                        <div class="edit-toolbar">
                            <div class="section-hd">Generate <span class="brand">Widget</span></div>
                        </div>
                        <div class="card has-dropdown widget-generate-card">
                            <div class="pl-item">
                                <div class="widget-select-group">
                                    <label class="widget-select-label">Source</label>
                                    <div class="custom-select inline" id="widget-source-wrap">
                                        <div class="custom-select-btn" id="widget-source-btn">
                                            <span id="widget-source-label">My Mixtape</span>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </div>
                                        <div class="custom-select-options" id="widget-source-options">
                                            <div class="custom-select-option selected" data-value="current">My Mixtape</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="widget-select-group">
                                    <label class="widget-select-label">Size</label>
                                    <div class="custom-select inline" id="widget-size-wrap">
                                        <div class="custom-select-btn" id="widget-size-btn">
                                            <span id="widget-size-label">Medium</span>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </div>
                                        <div class="custom-select-options" id="widget-size-options">
                                            <div class="custom-select-option" data-value="small">Small</div>
                                            <div class="custom-select-option selected" data-value="medium">Medium</div>
                                            <div class="custom-select-option" data-value="large">Large</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="widget-select-group">
                                    <label class="widget-select-label">Density</label>
                                    <div class="custom-select inline" id="widget-density-wrap">
                                        <div class="custom-select-btn" id="widget-density-btn">
                                            <span id="widget-density-label">Standard</span>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </div>
                                        <div class="custom-select-options" id="widget-density-options">
                                            <div class="custom-select-option selected" data-value="min">Standard</div>
                                            <div class="custom-select-option" data-value="max">Compact</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="widget-select-group">
                                    <label class="widget-select-label">Style</label>
                                    <div class="custom-select inline" id="widget-style-wrap">
                                        <div class="custom-select-btn" id="widget-style-btn">
                                            <span id="widget-style-label">Glass</span>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </div>
                                        <div class="custom-select-options" id="widget-style-options">
                                            <div class="custom-select-option selected" data-value="glass">Glass</div>
                                            <div class="custom-select-option" data-value="solid">Solid Dark</div>
                                            <div class="custom-select-option" data-value="spotify">Spotify Green</div>
                                        </div>
                                    </div>
                                </div>
                                <button class="action-btn" id="widget-generate-btn">Generate</button>
                            </div>
                        </div>
                        <div class="widget-info" id="widget-info">
                            <p class="section-desc" style="margin: 0;"><span style="font-weight: 600;">Medium Standard:</span> Shows 3 playlists in a row</p>
                        </div>
                        <div class="share-output" id="widget-output"></div>
                    </div>
                    
                    <div class="share-back">
                        <button class="txt-btn" id="widget-back-btn">Back</button>
                    </div>
                </div>

                <!-- About View -->
                <div class="view" id="about">
                    <div class="about-hero">
                        <img src="https://images.unsplash.com/photo-1487180144351-b8472da7d491?q=80&w=1200&auto=format&fit=crop" alt="Woman laying on bed near radio">
                        <div class="about-hero-overlay">
                            <h1 class="about-hero-title">About &nbsp;<span>MIXTAPED</span></h1>
                        </div>
                    </div>
                    
                    <div class="about-intro">
                        <p>Remember making mixtapes? Carefully selecting songs, writing out the tracklist, and handing it to someone who needed to hear what you'd been listening to. <span class="brand">Mixtaped</span> brings that feeling back for the streaming age thanks to the Spotify Web API.</p>
                    </div>
                    
                    <div class="about-grid">
                        <div class="about-card">
                            <div class="about-card-icon"><span class="material-symbols-outlined">grid_view</span></div>
                            <div class="about-card-title">Your Favorite Playlists</div>
                            <p class="about-card-desc">Spotify buries your carefully tuned playlists deep in menus. <span class="brand">Mixtaped</span> puts them front and center. One tap to open your favorite playlist. No digging, no searching. Just your music, ready to play.</p>
                        </div>
                        
                        <div class="about-card">
                            <div class="about-card-icon"><span class="material-symbols-outlined">heart_check</span></div>
                            <div class="about-card-title">Sharing Made Easy</div>
                            <p class="about-card-desc">Generate a single link that contains your entire collection. Send it to a friend, post it anywhere. They don't need an account or an app. Just click and discover what you've been listening to.</p>
                        </div>
                        
                        <div class="about-card">
                            <div class="about-card-icon"><span class="material-symbols-outlined">headphones</span></div>
                            <div class="about-card-title">Collect Good Vibes</div>
                            <p class="about-card-desc">Save mixtapes from friends with great taste, or create your own for road trips, dinner parties, and podcast deep dives. Build a library of collections that's always one tap away.</p>
                        </div>
                        
                        <div class="about-card">
                            <div class="about-card-icon"><span class="material-symbols-outlined">lock</span></div>
                            <div class="about-card-title">Privacy First</div>
                            <p class="about-card-desc">Your data stays on your device. No accounts, no tracking, no servers storing your listening habits. Share what you want, when you want, with who you want. That's it.</p>
                        </div>
                    </div>
                    
                    <div class="about-footer">
                        <p>For questions or help setting up your <span class="brand">Mixtaped</span> app, <a href="/cdn-cgi/l/email-protection#9bf8f4f7f2f5dbf8f4f7f2f5f6fae2f5fae9ffb5f5feefa4e8eef9f1fef8efa6d6d2c3cfdacbdedfbea9abcaeefee8eff2f4f5">email here</a>.</p>
                        <p>If you love using this tool, feel free to <a href="https://buymeacoffee.com/fromnineteen80" target="_blank">donate here</a>.</p>
                    </div>
                    
                    <div class="about-divider"></div>
                    
                    <div class="about-story">
                        <p>I built <span class="brand">Mixtaped</span> because I love music. Discovering new music and sharing it with friends is one of my favorite things to do when I have some downtime. I also love Spotify and it is always one of my most used apps. However, Spotify has become highly complex and buries playlists deep in menus, making it frustrating to access the collections I've spent time building. I can't tell you how frustrating it is to have to click "By You" after already diving levels deep to get to playlists.</p>
                        
                        <p>I think the design complexity discourages the old mixtape vibe, and that's a shame. With vinyl making a comeback among Gen Z, we shouldn't overlook the cassette mixtapes and burned CDs eras that meant so much to us music lovers. Those mixes were personal and took hours to create. They were expressive. They said something about who you were and what you wanted someone else to hear. If a relationship ended, the one thing I wanted back was my mixtapes. And I know I am not the only one who had that special attachment to music growing up.</p>
                        
                        <p>I am also in my car for work nearly every day, driving long distances. CarPlay helps, but sometimes I know exactly what vibe I want for a drive, or I've mapped out which podcasts to queue up. Why not have those specific collections at my fingertips? Or take some time to explore what friends have shared with me without digging through an interface that fights me every step?</p>
                        
                        <p>That's what <span class="brand">Mixtaped</span> solves. Quick access to your favorite playlists. Easy sharing with context. A library of collections from people whose taste you trust.</p>
                        
                        <p>We are just getting started. Future versions of <span class="brand">Mixtaped</span> will focus on deeper Spotify integration and more ways to discover and organize. And we are working on simplifying the saving and storage problem for a light HTML web app. But the core will always be simple: your music, your mixtapes, one tap away.</p>
                    </div>
                    
                    <div class="about-divider"></div>
                    
                    <div class="about-section-title">Ways to Use <span class="brand-header">Mixtaped</span></div>
                    
                    <div class="use-case-grid">
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">directions_car</span></div>
                            <div class="use-case-title">Road Trip Ready</div>
                            <div class="use-case-desc">Queue up the perfect drive. Morning coffee vibes, desert highway energy, late night wind-down. All one tap away.</div>
                        </div>
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">podcasts</span></div>
                            <div class="use-case-title">Podcast Queues</div>
                            <div class="use-case-desc">Map out your week's listening. Group episodes by topic, mood, or trip length. No more hunting through your library.</div>
                        </div>
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">dining</span></div>
                            <div class="use-case-title">Dinner Party Host</div>
                            <div class="use-case-desc">Curate the evening's soundtrack. Arrival drinks, dinner conversation, after-hours groove. Seamless transitions.</div>
                        </div>
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">directions_run</span></div>
                            <div class="use-case-title">Workout Blocks</div>
                            <div class="use-case-desc">Warm-up, push, cool-down. Build workout phases with playlists that match your intensity.</div>
                        </div>
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">person_heart</span></div>
                            <div class="use-case-title">Gift a Vibe</div>
                            <div class="use-case-desc">Better than a playlist. Share a whole collection that tells a story. Perfect for birthdays, holidays, or just because.</div>
                        </div>
                        <div class="use-case-card">
                            <div class="use-case-icon"><span class="material-symbols-outlined">radio</span></div>
                            <div class="use-case-title">Music Discovery</div>
                            <div class="use-case-desc">Collect mixtapes from friends with great taste. Their curation becomes your next favorite artist.</div>
                        </div>
                    </div>
                    
                    <div class="share-back">
                        <button class="txt-btn" id="about-back-btn">Back</button>
                    </div>
                </div>

                <!-- Help View -->
                <div class="view" id="help">
                    <div class="about-hero">
                        <img src="https://images.unsplash.com/photo-1508700115892-45ecd05ae2ad?q=80&w=2969&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Help">
                        <div class="about-hero-overlay">
                            <h1 class="about-hero-title">Help With &nbsp;<span>MIXTAPED</span></h1>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="help-section">
                            <div class="help-title">Getting Started</div>
                            <div class="help-q">What is <span class="brand">Mixtaped</span>?</div>
                            <p class="help-a"><span class="brand">Mixtaped</span> is a way to collect and share your favorite Spotify playlists. Think of it like making a mixtape for a friend, but with playlists instead of songs. Add your playlists, write descriptions for each one, and share the collection with anyone. It's also a quick way to access your favorite playlists on mobile since Spotify buries user-created playlists deep within the app interface.</p>
                            
                            <div class="help-q">How do I add a playlist?</div>
                            <p class="help-a">Go to Edit, paste a Spotify playlist URL into an empty slot, and the artwork and title will load automatically. Add an optional description to give context about the playlist. You must add at least three playlists to view on Grid Layout or Deep Dive.</p>
                            
                            <div class="help-q">Where do I get a playlist URL?</div>
                            <p class="help-a">In Spotify, open a playlist, tap the three dots menu, then "Share" and "Copy link". Paste that link into Mixtaped.</p>
                            
                            <div class="help-q">Save your share code</div>
                            <p class="help-a">Once you've added playlists, go to Share and generate a code. Save this code in your Notes app, on notepad.cc, or email it to yourself. This is your backup. If you ever lose your data, you can restore everything from this code.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Limitations</div>
                            <div class="help-q">Playlists must be public</div>
                            <p class="help-a"><span class="brand">Mixtaped</span> can only load artwork and titles for public playlists. If a playlist shows a music note placeholder, make sure it's set to Public in Spotify: open the playlist, tap the three dots, and select "Make public".</p>
                            
                            <div class="help-q">Comparing Spotify's APIs: oEmbed vs OAuth</div>
                            <p class="help-a"><span class="brand">Mixtaped</span> uses Spotify's oEmbed API, which is public and doesn't require you to log in. oEmbed provides basic info: playlist title, cover art, and an embed player. Spotify's full Web API uses OAuth authentication, which requires logging into your Spotify account. OAuth unlocks much more: your private playlists, playlist descriptions, track listings, playback control, and user data. A future version of <span class="brand">Mixtaped</span> may include OAuth login for deeper integration.</p>
                            
                            <div class="help-q">Ad blockers may interfere</div>
                            <p class="help-a">Privacy extensions and ad blockers can block requests to Spotify's servers, preventing playlist data from loading. If you're having trouble, try disabling your ad blocker for this site.</p>
                            
                            <div class="help-q">Data is stored locally</div>
                            <p class="help-a">All your data is stored on your device, not on a server. This keeps it private, but means clearing your browser data or switching devices will reset the app. Always keep a saved share code as backup. Our Recover page helps you generate a full backup of your data and also restore the entire app.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Tips</div>
                            <div class="help-q">Add descriptions to your playlists</div>
                            <p class="help-a">When someone views your mixtape in Deep Dive, they'll see your descriptions. Use them to explain why you love a playlist, what mood it's for, or any story behind it.</p>
                            
                            <div class="help-q">Install as an app</div>
                            <p class="help-a">On iPhone, tap the Share button in Safari and "Add to Home Screen". On Android, tap the menu and "Install app" or "Add to Home Screen". This gives you a full-screen experience and quick access from your home screen.</p>
                            
                            <div class="help-q">Reorder your playlists</div>
                            <p class="help-a">In Edit, use the arrow buttons next to each playlist to change the order. The order you set is how they'll appear in Grid Layout and Deep Dive.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Views</div>
                            <div class="help-q">What's the difference between Grid Layout and Deep Dive?</div>
                            <p class="help-a">Grid Layout shows your playlists as album art tiles. Tap any tile to open it in Spotify. Deep Dive shows each playlist with its full artwork and description, perfect for browsing or sharing with friends.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Sharing</div>
                            <div class="help-q">How do I share my mixtape?</div>
                            <p class="help-a">Go to Curate, enter your name and a title for your mixtape, then tap "Generate Share Code". You'll get a short URL and a backup code. Send either one to a friend.</p>
                            
                            <div class="help-q">What's the difference between the short URL and backup code?</div>
                            <p class="help-a">The short URL is easier to share and opens directly in a browser. The backup code is longer but works even if the URL shortener is unavailable. Both contain the same data.</p>
                            
                            <div class="help-q">How does my friend view my mixtape?</div>
                            <p class="help-a">They can open the short URL in a browser, or paste either the URL or backup code into the "Add a Friend's Mixtape" section on the Curate page.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Collecting Mixtapes</div>
                            <div class="help-q">How do I save a friend's mixtape?</div>
                            <p class="help-a">On the Curate page, scroll down to "Add a Friend's Mixtape" and paste their share code or URL. Their mixtape will appear in your sidebar and menu under Mixtapes.</p>
                            
                            <div class="help-q">What does starring a mixtape do?</div>
                            <p class="help-a">Starred mixtapes always appear in your menu, even if you collect more than five. Unstarred mixtapes rotate out as you add new ones, but they're always available in the full list on the Curate page.</p>
                            
                            <div class="help-q">How do I delete a collected mixtape?</div>
                            <p class="help-a">On the Curate page, scroll to "Collected Mixtapes" at the bottom. Tap the trash icon next to any mixtape to remove it.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Recovery</div>
                            <div class="help-q">I lost my playlists. How do I get them back?</div>
                            <p class="help-a">If you previously generated a share code, you can use it to restore your mixtape. Go to Recover and paste your code.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Troubleshooting</div>
                            <div class="help-q">My playlist artwork won't load</div>
                            <p class="help-a">Make sure the playlist is set to Public in Spotify. Private playlists can't be loaded by Mixtaped. Also check that ad blockers or privacy extensions aren't blocking requests to Spotify.</p>
                            
                            <div class="help-q">The app looks broken or isn't working</div>
                            <p class="help-a">Try refreshing the page. If problems persist, clear your browser cache and reload. You can restore your data afterward using a saved share code.</p>
                            
                            <div class="help-q">Playlists open in the browser instead of Spotify</div>
                            <p class="help-a">Make sure you have the Spotify app installed. On mobile, playlists should open directly in the app. On desktop, you may need to allow your browser to open Spotify links in the app.</p>
                        </div>
                        
                        <div class="help-section">
                            <div class="help-title">Known Issues</div>
                            <div class="help-q">Short URL not working</div>
                            <p class="help-a">The short URL feature uses a third-party service (is.gd) that may occasionally be unavailable or blocked by some networks. If the short URL doesn't work, use the full share code instead. The code contains all your data and will always work.</p>
                        </div>
                    </div>
                    <div class="share-back">
                        <button class="txt-btn" id="help-back-btn">Back</button>
                    </div>
                </div>

                <!-- Friend's Mixtape View -->
                <div class="view" id="friend">
                    <div class="mixtape-header" id="mixtape-header">
                        <div class="mixtape-title-info">
                            <span class="mixtape-title" id="friend-title">Mixtape Title</span>
                            <span class="mixtape-occasion" id="friend-occasion">
                                <span class="material-symbols-outlined" id="friend-occasion-icon">directions_car</span>
                                <span id="friend-occasion-label">Road Trip</span>
                            </span>
                        </div>
                        <div class="edit-actions" id="mixtape-actions">
                            <button class="action-btn" id="friend-edit-btn">Edit</button>
                            <button class="action-btn" id="friend-copy-btn">Copy</button>
                            <button class="action-btn" id="friend-delete-btn">Delete</button>
                        </div>
                    </div>
                    <div class="collab-header" id="collab-header" style="display: none;">
                        <div class="share-toolbar-header">
                            <span class="toggle-label" id="collab-title">Collaboration</span>
                            <button class="copy-btn" id="collab-copy-btn" title="Copy share code"><span class="material-symbols-outlined">content_copy</span></button>
                        </div>
                        <input type="text" class="share-toolbar-input" id="collab-name" placeholder="Add Your Name">
                    </div>
                    <div class="collab-instructions" id="collab-instructions" style="display: none;">
                        <p class="collab-text">Add your favorite playlists and share back. You can include up to 14 playlists total.</p>
                    </div>
                    <div class="dive-list" id="friend-list" style="display: none;"></div>
                    <div class="friend-grid" id="friend-grid"></div>
                    <div class="embed-section" id="friend-embed-section" style="display: none;">
                        <div class="embed-divider"></div>
                        <div class="embed-container">
                            <div class="embed-playlist-list" id="friend-embed-list"></div>
                            <div class="embed-player" id="friend-embed-player"></div>
                            <div class="embed-spacer"></div>
                        </div>
                    </div>
                    <div class="collab-add-form" id="collab-add-form" style="display: none;">
                        <div class="card">
                            <div class="pl-item">
                                <input class="pl-input" type="text" id="collab-url" placeholder="Paste Spotify playlist link">
                            </div>
                        </div>
                        <div class="collab-add-actions">
                            <button class="txt-btn" id="collab-add-cancel">Cancel</button>
                            <button class="action-btn" id="collab-add-save">Add</button>
                        </div>
                    </div>
                    <div class="dive-back">
                        <button class="txt-btn" id="friend-back-btn">Back</button>
                    </div>
                </div>

                <!-- Edit View -->
                <div class="view" id="edit">
                    <div class="section">
                        <div class="edit-header">
                            <div class="edit-header-row">
                                <div class="edit-header-col" style="flex: 1;">
                                    <label class="edit-header-label">Title</label>
                                    <input class="pl-input" type="text" id="edit-title" placeholder="Give it a name">
                                </div>
                                <div class="edit-header-col">
                                    <label class="edit-header-label">Occasion</label>
                                    <div class="custom-select edit-occasion-select" id="edit-occasion-wrap">
                                        <div class="custom-select-btn" id="edit-occasion-btn">
                                            <span id="edit-occasion-label">Select</span>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                                        </div>
                                        <div class="custom-select-options" id="edit-occasion-options">
                                            <div class="custom-select-option" data-value="favorites" data-icon="album">Favorites</div>
                                            <div class="custom-select-option" data-value="roadtrip" data-icon="directions_car">Road Trip</div>
                                            <div class="custom-select-option" data-value="dinner" data-icon="dining">Dinner Party</div>
                                            <div class="custom-select-option" data-value="workout" data-icon="directions_run">Workout</div>
                                            <div class="custom-select-option" data-value="podcast" data-icon="podcasts">Podcast</div>
                                            <div class="custom-select-option" data-value="focus" data-icon="mindfulness">Focus</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="edit-toolbar">
                            <div></div>
                            <div class="edit-actions">
                                <button class="action-btn" id="cancel-btn">Cancel</button>
                                <button class="action-btn" id="save-btn">Save</button>
                                <button class="action-btn square" id="add-btn">+</button>
                            </div>
                        </div>
                        <div class="card" id="form"></div>
                    </div>
                    <div class="footer">
                        Donate to the developer <a href="https://buymeacoffee.com/fromnineteen80" target="_blank" style="color: #1DB954; text-decoration: none;">here</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        /* ============================================
           JAVASCRIPT
           ============================================ */

        /* --------------------------------------------
           STATE & STORAGE
           -------------------------------------------- */
        const K = { i: 'mixtaped_items', s: 'mixtaped_settings', t: 'mixtaped_theme', m: 'mixtaped_mixtapes', p: 'mixtaped_profile', c: 'mixtaped_playlist_cache' };
        let items = [], cfg = { cols: 2, workingTitle: '', workingOccasion: '', workingOccasionIcon: '', workingMixtapeIdx: null }, work = [], mixtapes = [];
        let profile = { name: '', spotifyUsername: '', photo: '', photoSource: '', gistUrl: '' };
        let playlistCache = {};
        let sysDark = matchMedia('(prefers-color-scheme:dark)').matches;

        function load() {
            try { let d = localStorage.getItem(K.i); if (d) items = JSON.parse(d); } catch(e) {}
            try { 
                let d = localStorage.getItem(K.s); 
                if (d) {
                    const loaded = JSON.parse(d);
                    // Merge with defaults, but reset occasion to empty if it was 'favorites' from old default
                    cfg = { ...cfg, ...loaded };
                    // Ensure workingOccasion is empty string not undefined
                    if (!cfg.workingOccasion) cfg.workingOccasion = '';
                    if (!cfg.workingOccasionIcon) cfg.workingOccasionIcon = '';
                }
            } catch(e) {}
            try { let d = localStorage.getItem(K.m); if (d) mixtapes = JSON.parse(d); } catch(e) {}
            try { let d = localStorage.getItem(K.p); if (d) profile = { ...profile, ...JSON.parse(d) }; } catch(e) {}
            try { let d = localStorage.getItem(K.c); if (d) playlistCache = JSON.parse(d); } catch(e) {}
            try {
                let t = localStorage.getItem(K.t);
                if (t) {
                    if (sysDark && t === 'light') t = 'dark';
                    setTheme(t);
                } else {
                    setTheme(sysDark ? 'dark' : 'light');
                }
            } catch(e) { setTheme(sysDark ? 'dark' : 'light'); }
            fix();
            renderThemes();
            renderMixtapesList();
            renderSidebarAvatar();
        }
        
        function savePlaylistCache() {
            try { localStorage.setItem(K.c, JSON.stringify(playlistCache)); } catch(e) {}
        }

        // Save to localStorage
        function save() {
            try {
                localStorage.setItem(K.i, JSON.stringify(items));
                localStorage.setItem(K.s, JSON.stringify(cfg));
            } catch(e) {}
        }
        
        function saveMixtapes() {
            try {
                localStorage.setItem(K.m, JSON.stringify(mixtapes));
            } catch(e) {}
        }
        
        function saveProfile() {
            try {
                localStorage.setItem(K.p, JSON.stringify(profile));
            } catch(e) {}
        }
        
        // Fetch Spotify profile photo from public profile page via CORS proxy
        async function fetchSpotifyProfile(username) {
            if (!username) return null;
            try {
                const targetUrl = `https://open.spotify.com/user/${encodeURIComponent(username)}`;
                const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(targetUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) return null;
                
                const html = await response.text();
                if (!html || html.includes('error')) return null;
                
                const result = {};
                
                // Extract profile image from og:image meta tag
                const ogImageMatch = html.match(/<meta[^>]*property="og:image"[^>]*content="([^"]+)"/i);
                if (ogImageMatch && ogImageMatch[1]) {
                    result.photo = ogImageMatch[1];
                } else {
                    // Fallback to any Spotify CDN image
                    const imgMatch = html.match(/https:\/\/i\.scdn\.co\/image\/[a-zA-Z0-9]+/);
                    if (imgMatch) {
                        result.photo = imgMatch[0];
                    }
                }
                
                return Object.keys(result).length > 0 ? result : null;
            } catch(e) {
                console.log('Could not fetch Spotify profile:', e);
                return null;
            }
        }
        
        // Backwards compatibility alias
        async function fetchSpotifyProfilePhoto(username) {
            const result = await fetchSpotifyProfile(username);
            return result ? result.photo : null;
        }
        
        function renderProfileCard() {
            const hasData = profile.name || profile.spotifyUsername || profile.photo;
            const editCard = document.getElementById('profile-card-edit');
            const displayCard = document.getElementById('profile-card-display');
            
            if (!editCard || !displayCard) return;
            
            // Update edit card avatar always
            const avatarHtml = renderAvatarContent(profile.photo, profile.name);
            const avatar = document.getElementById('profile-card-avatar');
            if (avatar) avatar.innerHTML = avatarHtml;
            
            // Update photo button text (Add or Update)
            const photoBtn = document.getElementById('profile-photo-btn');
            if (photoBtn) {
                photoBtn.textContent = profile.photo ? 'Update' : 'Add';
            }
            
            // Show/hide delete button based on whether there's a photo
            const deleteBtn = document.getElementById('profile-avatar-delete-edit');
            if (deleteBtn) {
                deleteBtn.style.display = profile.photo ? 'flex' : 'none';
            }
            
            if (hasData && editCard.style.display === 'none') {
                // Already in display mode, just update content
                displayCard.style.display = 'flex';
                
                // Update display card content
                const avatarLarge = document.getElementById('profile-card-avatar-large');
                const nameEl = document.getElementById('profile-card-name');
                const usernameEl = document.getElementById('profile-card-username');
                
                if (avatarLarge) avatarLarge.innerHTML = avatarHtml;
                if (nameEl) nameEl.textContent = getShortName(profile.name) || 'No name';
                if (usernameEl) usernameEl.textContent = profile.spotifyUsername || '';
                
                // Update stats
                const savedCount = mixtapes.length;
                const collabCount = 0; // TODO: track collaborated mixtapes
                const friendsCount = mixtapes.filter(m => m.name && m.name !== profile.name).length;
                
                const statSaved = document.getElementById('profile-stat-saved');
                const statCollab = document.getElementById('profile-stat-collab');
                const statFriends = document.getElementById('profile-stat-friends');
                
                if (statSaved) statSaved.textContent = savedCount;
                if (statCollab) statCollab.textContent = collabCount;
                if (statFriends) statFriends.textContent = friendsCount;
            }
            // If no data or in edit mode, keep showing edit mode (don't switch automatically)
        }
        
        function switchToDisplayMode() {
            const hasData = profile.name || profile.spotifyUsername || profile.photo;
            if (!hasData) return;
            
            const editCard = document.getElementById('profile-card-edit');
            const displayCard = document.getElementById('profile-card-display');
            
            if (editCard) editCard.style.display = 'none';
            if (displayCard) displayCard.style.display = 'flex';
            
            renderProfileCard();
        }
        
        function showProfileEditMode() {
            const editCard = document.getElementById('profile-card-edit');
            const displayCard = document.getElementById('profile-card-display');
            if (editCard) editCard.style.display = 'flex';
            if (displayCard) displayCard.style.display = 'none';
            
            // Populate inputs with current profile data
            const nameInput = document.getElementById('profile-name');
            const usernameInput = document.getElementById('profile-spotify-username');
            if (nameInput) nameInput.value = profile.name || '';
            if (usernameInput) usernameInput.value = profile.spotifyUsername || '';
            
            // Update avatar in edit card
            const avatar = document.getElementById('profile-card-avatar');
            if (avatar) avatar.innerHTML = renderAvatarContent(profile.photo, profile.name);
            
            // Update photo button and delete button
            const photoBtn = document.getElementById('profile-photo-btn');
            if (photoBtn) photoBtn.textContent = profile.photo ? 'Update' : 'Add';
            
            const deleteBtn = document.getElementById('profile-avatar-delete-edit');
            if (deleteBtn) deleteBtn.style.display = profile.photo ? 'flex' : 'none';
            
            if (nameInput) nameInput.focus();
        }
        
        function renderProfilePhoto() {
            renderProfileCard();
        }
        
        function getFirstName(fullName) {
            if (!fullName || !fullName.trim()) return '';
            return fullName.trim().split(/\s+/)[0];
        }
        
        function getShortName(fullName) {
            if (!fullName || !fullName.trim()) return '';
            const parts = fullName.trim().split(/\s+/);
            if (parts.length === 1) return parts[0];
            const firstName = parts[0];
            const lastInitial = parts[parts.length - 1].charAt(0).toUpperCase();
            return `${firstName} ${lastInitial}.`;
        }
        
        function renderAvatarContent(photo, name) {
            if (photo) {
                return `<img src="${esc(photo)}" alt="Profile">`;
            } else if (name && name.trim()) {
                const firstLetter = name.trim().charAt(0);
                return `<span class="avatar-letter">${esc(firstLetter)}</span>`;
            } else {
                return '<span class="material-symbols-outlined">person</span>';
            }
        }
        
        function renderAllProfileSections() {
            const firstName = getFirstName(profile.name);
            const username = profile.spotifyUsername || '';
            const avatarHtml = renderAvatarContent(profile.photo, profile.name);
            const hasProfile = !!profile.name;
            
            // Sidebar
            const sidebarAvatar = document.getElementById('sidebar-profile-avatar');
            const sidebarName = document.getElementById('sidebar-profile-name');
            const sidebarUsername = document.getElementById('sidebar-profile-username');
            const sidebarLinks = document.getElementById('sidebar-profile-links');
            if (sidebarAvatar) sidebarAvatar.innerHTML = avatarHtml;
            if (sidebarName) sidebarName.textContent = firstName;
            if (sidebarUsername) sidebarUsername.textContent = username;
            if (sidebarLinks) sidebarLinks.style.display = hasProfile ? 'flex' : 'none';
            
            // Menu dropdown
            const menuAvatar = document.getElementById('menu-profile-avatar');
            const menuName = document.getElementById('menu-profile-name');
            const menuUsername = document.getElementById('menu-profile-username');
            const menuLinks = document.getElementById('menu-profile-links');
            if (menuAvatar) menuAvatar.innerHTML = avatarHtml;
            if (menuName) menuName.textContent = firstName;
            if (menuUsername) menuUsername.textContent = username;
            if (menuLinks) menuLinks.style.display = hasProfile ? 'flex' : 'none';
            
            // Mobile more menu
            const mobileAvatar = document.getElementById('mobile-profile-avatar');
            const mobileName = document.getElementById('mobile-profile-name');
            const mobileUsername = document.getElementById('mobile-profile-username');
            if (mobileAvatar) mobileAvatar.innerHTML = avatarHtml;
            if (mobileName) mobileName.textContent = firstName;
            if (mobileUsername) mobileUsername.textContent = username;
            
            // Mobile bottom tray avatar
            const mobileBottomAvatar = document.getElementById('mobile-bottom-avatar');
            if (mobileBottomAvatar) {
                mobileBottomAvatar.innerHTML = avatarHtml;
                mobileBottomAvatar.classList.toggle('has-photo', !!profile.photo);
            }
            
            // Pre-fill share name fields with profile name
            if (profile.name) {
                const mainShareName = document.getElementById('main-share-name');
                const diveShareName = document.getElementById('dive-share-name');
                const sharePageName = document.getElementById('share-name');
                const collabName = document.getElementById('collab-name');
                
                if (mainShareName && !mainShareName.value) mainShareName.value = profile.name;
                if (diveShareName && !diveShareName.value) diveShareName.value = profile.name;
                if (sharePageName && !sharePageName.value) sharePageName.value = profile.name;
                if (collabName && !collabName.value) collabName.value = profile.name;
            }
        }
        
        // Alias for backwards compatibility
        function renderSidebarAvatar() {
            renderAllProfileSections();
        }
        
        // Custom modal popup
        function showModal(message) {
            document.getElementById('modal-content').innerHTML = message;
            document.getElementById('modal-btn').textContent = 'OK';
            document.getElementById('modal-btn').onclick = closeModal;
            document.getElementById('modal-overlay').classList.add('open');
        }
        
        function showModalConfirm(message, onConfirm) {
            document.getElementById('modal-content').innerHTML = message + 
                `<div class="modal-confirm-btns">
                    <button class="action-btn" id="modal-cancel-btn">Cancel</button>
                    <button class="action-btn" id="modal-confirm-btn">Delete</button>
                </div>`;
            document.getElementById('modal-btn').style.display = 'none';
            document.getElementById('modal-overlay').classList.add('open');
            document.getElementById('modal-cancel-btn').onclick = () => {
                document.getElementById('modal-btn').style.display = '';
                closeModal();
            };
            document.getElementById('modal-confirm-btn').onclick = () => {
                document.getElementById('modal-btn').style.display = '';
                closeModal();
                onConfirm();
            };
        }
        
        function showModalChoice(message, btn1Text, btn1Action, btn2Text, btn2Action) {
            document.getElementById('modal-content').innerHTML = message + 
                `<div class="modal-confirm-btns">
                    <button class="action-btn" id="modal-choice-1">${btn1Text}</button>
                    <button class="action-btn" id="modal-choice-2">${btn2Text}</button>
                </div>`;
            document.getElementById('modal-btn').style.display = 'none';
            document.getElementById('modal-overlay').classList.add('open');
            document.getElementById('modal-choice-1').onclick = () => {
                document.getElementById('modal-btn').style.display = '';
                closeModal();
                btn1Action();
            };
            document.getElementById('modal-choice-2').onclick = () => {
                document.getElementById('modal-btn').style.display = '';
                closeModal();
                btn2Action();
            };
        }
        
        function showModalWithLink(message, linkText, linkAction) {
            document.getElementById('modal-content').innerHTML = message + 
                `<br><a href="#" class="modal-link" id="modal-action-link">${linkText}</a>`;
            document.getElementById('modal-btn').textContent = 'OK';
            document.getElementById('modal-btn').onclick = closeModal;
            document.getElementById('modal-overlay').classList.add('open');
            document.getElementById('modal-action-link').onclick = (e) => {
                e.preventDefault();
                closeModal();
                linkAction();
            };
        }
        
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('open');
        }
        
        // Setup modal close handlers
        document.getElementById('modal-overlay').onclick = (e) => {
            if (e.target === document.getElementById('modal-overlay')) closeModal();
        };

        // Ensure items array exists (min 3, max 14, start with 9)
        function fix() {
            if (!items.length) {
                for (let i = 0; i < 9; i++) items.push({ url: '', title: '', img: '', desc: '' });
            }
            // Enforce min 3
            while (items.length < 3) {
                items.push({ url: '', title: '', img: '', desc: '' });
            }
            // Enforce max 14
            if (items.length > 14) {
                items = items.slice(0, 14);
            }
            save();
        }

        /* --------------------------------------------
           THEME MANAGEMENT
           -------------------------------------------- */
        function renderThemes() {
            const cur = document.body.dataset.theme || 'light';
            
            // Update profile theme picker
            const picker = document.getElementById('profile-theme-picker');
            if (picker) {
                picker.querySelectorAll('.profile-theme-picker-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.theme === cur);
                });
            }
        }
        
        function initProfileThemePicker() {
            const picker = document.getElementById('profile-theme-picker');
            if (picker) {
                picker.querySelectorAll('.profile-theme-picker-btn').forEach(btn => {
                    btn.onclick = () => setTheme(btn.dataset.theme);
                });
            }
        }

        function setTheme(t) {
            document.body.dataset.theme = t;
            document.querySelectorAll('.theme-btn').forEach(b => {
                b.classList.toggle('on', b.dataset.t === t);
                b.classList.toggle('active', b.dataset.t === t);
            });
            document.getElementById('meta-theme').content = { light: '#F5F5F4', dark: '#161616', spotify: '#1DB954' }[t];
            try { localStorage.setItem(K.t, t); } catch(e) {}
            renderThemes();
        }

        /* --------------------------------------------
           SPOTIFY API (oEmbed)
           -------------------------------------------- */
        async function fetchSpotify(url) {
            // Check cache first
            const id = getID(url);
            if (id && playlistCache[id]) {
                return playlistCache[id];
            }
            
            const r = await fetch('https://open.spotify.com/oembed?url=' + encodeURIComponent(url));
            if (!r.ok) throw new Error();
            const data = await r.json();
            
            // Get highest res image available
            // Spotify CDN supports: 64, 300, 640 standard
            // Try removing size to get original, fallback to 640
            if (data.thumbnail_url) {
                // Replace any size with 640 (highest standard)
                data.thumbnail_url = data.thumbnail_url
                    .replace('/64/', '/640/')
                    .replace('/300/', '/640/');
            }
            
            // Cache the result
            if (id) {
                playlistCache[id] = data;
                savePlaylistCache();
            }
            
            return data;
        }

        function getID(url) {
            try {
                const u = new URL(url);
                if (!u.host.includes('spotify.com')) return null;
                const p = u.pathname.split('/').filter(Boolean);
                return p[0] === 'playlist' ? p[1] : null;
            } catch(e) { return null; }
        }

        // Escape HTML
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        // Calculate optimal grid layout
        function calcGrid(itemCount) {
            const gap = 16;
            const wrapper = document.querySelector('.wrapper');
            const wrapperW = wrapper.offsetWidth;
            const headerH = 44 + gap;
            const labelH = 24;
            
            const availW = wrapperW;
            const availH = window.innerHeight - headerH - (gap * 2);
            
            const n = itemCount;
            
            // Device-aware scroll thresholds based on viewport height
            let maxTilesNoScroll;
            if (availH < 600) {
                maxTilesNoScroll = 4;
            } else if (availH < 750) {
                maxTilesNoScroll = 6;
            } else if (availH < 900) {
                maxTilesNoScroll = 8;
            } else if (availH < 1100) {
                maxTilesNoScroll = 10;
            } else {
                maxTilesNoScroll = 12;
            }
            
            const allowScroll = n > maxTilesNoScroll;
            
            // Max tile size (prevents giant tiles on large screens)
            const maxTileSize = 200;
            
            // Columns based on item count AND screen size
            let cols;
            
            // Large screens (iPads, laptops, desktops) - over 600px
            if (availW > 600) {
                // Gradual breakpoints for larger screens
                // Stay at each column count longer before jumping
                // Max 5 columns
                let maxCols;
                if (availW < 800) {
                    maxCols = 3;
                } else if (availW < 1000) {
                    maxCols = 4;
                } else {
                    maxCols = 5;
                }
                
                if (n === 3) {
                    cols = 3;
                } else if (n === 4) {
                    cols = Math.min(4, maxCols);
                } else if (n >= 5 && n <= 6) {
                    cols = Math.min(n, maxCols);
                } else if (n >= 7 && n <= 9) {
                    cols = Math.min(n, maxCols);
                } else {
                    // 10-14: use maxCols
                    cols = maxCols;
                }
            } else if (availW < 500) {
                // Narrow screens - max 2 columns
                cols = n === 3 ? 3 : 2;
            } else {
                // Medium screens (phones) - original rules
                if (n === 3) {
                    cols = 3;
                } else if (n >= 4 && n <= 6) {
                    cols = 2;
                } else {
                    cols = 3;
                }
            }
            
            const rows = Math.ceil(n / cols);
            const tileW = (availW - (gap * (cols - 1))) / cols;
            
            let tileH;
            if (allowScroll) {
                tileH = tileW;
            } else {
                tileH = (availH - (gap * (rows - 1)) - (labelH * rows)) / rows;
            }
            
            const size = Math.min(tileW, tileH);
            
            return { cols: cols, size: Math.floor(size) };
        }

        /* --------------------------------------------
           GRID RENDERING
           -------------------------------------------- */
        function renderGrid() {
            // Only show items with URLs
            const filled = items.filter(it => it.url && getID(it.url));
            
            // Show/hide toolbar based on filled count
            const mainToolbar = document.getElementById('main-toolbar');
            const embedSection = document.getElementById('main-embed-section');
            const showToolbars = filled.length >= 3;
            
            if (mainToolbar) {
                mainToolbar.style.display = showToolbars ? 'flex' : 'none';
                // Populate title and occasion from cfg
                document.getElementById('main-title').textContent = cfg.workingTitle || '';
                const occasionLabels = {
                    'favorites': 'Favorites',
                    'roadtrip': 'Road Trip',
                    'dinner': 'Dinner Party',
                    'workout': 'Workout',
                    'podcast': 'Podcast',
                    'focus': 'Focus'
                };
                // Show occasion only if set
                const mainOccasion = document.getElementById('main-occasion');
                if (cfg.workingOccasion && occasionLabels[cfg.workingOccasion]) {
                    mainOccasion.style.display = '';
                    document.getElementById('main-occasion-icon').textContent = cfg.workingOccasionIcon || '';
                    document.getElementById('main-occasion-label').textContent = occasionLabels[cfg.workingOccasion];
                } else {
                    mainOccasion.style.display = 'none';
                }
            }
            
            // If less than 3 filled, show all slots (with placeholders)
            // If 3+ filled, only show the filled ones
            const displayItems = filled.length >= 3 ? filled : items;
            
            // Can add more playlists if under 14 (only show add tile in edit mode or when fewer than 3)
            const canAdd = isEditMode ? (filled.length < 14) : (filled.length >= 3 && filled.length < 14);
            
            // Calculate grid based on display items only, don't count add tile for size calculation
            const { cols, size } = calcGrid(displayItems.length);
            const g = document.getElementById('grid');
            
            document.documentElement.style.setProperty('--tile-size', size + 'px');
            g.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            g.innerHTML = displayItems.map((it, i) => {
                const actualIndex = filled.length >= 3 ? items.indexOf(it) : i;
                return `
                <div class="tile ${isEditMode ? 'edit-mode' : ''}" data-i="${actualIndex}">
                    ${isEditMode && it.url ? `<button class="tile-delete" data-i="${actualIndex}"><span class="material-symbols-outlined">close</span></button>` : ''}
                    <div class="tile-img">
                        ${it.img ? `<img src="${esc(it.img)}" alt="">` : `<div class="tile-ph"><span class="material-symbols-outlined">music_note_2</span></div>`}
                    </div>
                    <div class="tile-title">${esc(it.title) || 'Add playlist'}</div>
                </div>
            `}).join('') + (canAdd ? `
                <div class="tile ${isEditMode ? 'edit-mode' : ''}" id="main-add-tile">
                    <div class="tile-img">
                        <div class="tile-ph"><span class="material-symbols-outlined">add</span></div>
                    </div>
                    <div class="tile-title">Add playlist</div>
                </div>
            ` : '');
            
            // Delete button handlers (edit mode)
            g.querySelectorAll('.tile-delete').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.i);
                    items[idx] = { url: '', title: '', img: '', desc: '' };
                    items.sort((a, b) => (a.url ? 0 : 1) - (b.url ? 0 : 1));
                    save();
                    renderGrid();
                    renderDive();
                };
            });
            
            g.querySelectorAll('.tile:not(#main-add-tile)').forEach(t => {
                t.onclick = () => {
                    const idx = parseInt(t.dataset.i);
                    const it = items[idx];
                    
                    if (isEditMode) {
                        // Open playlist edit modal
                        openPlaylistEditModal(idx, it);
                    } else {
                        const id = getID(it.url);
                        if (id) {
                            // Try deep link first, fallback to web URL
                            window.location.href = 'spotify:playlist:' + id;
                        } else {
                            // No URL - open edit modal to add
                            openPlaylistEditModal(idx, it);
                        }
                    }
                };
            });
            
            // Add tile click handler
            const addTile = document.getElementById('main-add-tile');
            if (addTile) {
                addTile.onclick = () => {
                    // Find first empty slot or add new one
                    let emptyIndex = items.findIndex(it => !it.url);
                    if (emptyIndex === -1 && items.length < 14) {
                        items.push({ url: '', title: '', img: '', desc: '' });
                        emptyIndex = items.length - 1;
                    }
                    if (emptyIndex !== -1) {
                        openPlaylistEditModal(emptyIndex, items[emptyIndex]);
                    }
                };
            }
            
            // Render embed section (only show if 3+ playlists)
            if (embedSection) {
                if (filled.length >= 3) {
                    embedSection.style.display = 'block';
                    renderEmbedSection('main-embed-list', 'main-embed-player', filled);
                } else {
                    embedSection.style.display = 'none';
                }
            }
        }

        // Render embed section with playlist list and Spotify player
        function renderEmbedSection(listId, playerId, playlists) {
            const listEl = document.getElementById(listId);
            const playerEl = document.getElementById(playerId);
            
            if (!listEl || !playerEl || playlists.length === 0) return;
            
            // Determine embed theme based on app theme (0=dark, 1=light)
            const currentTheme = document.body.dataset.theme || 'light';
            const embedTheme = currentTheme === 'light' ? '1' : '0';
            
            // Build playlist list
            listEl.innerHTML = playlists.map((it, i) => `
                <button class="embed-playlist-item ${i === 0 ? 'active' : ''}" data-i="${i}" data-url="${esc(it.url)}">
                    ${esc(it.title) || 'Playlist'}
                </button>
            `).join('');
            
            // Set initial embed (first playlist)
            const firstId = getID(playlists[0].url);
            if (firstId) {
                playerEl.innerHTML = `<iframe src="https://open.spotify.com/embed/playlist/${firstId}?utm_source=generator&theme=${embedTheme}" allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
            }
            
            // Handle playlist selection
            listEl.querySelectorAll('.embed-playlist-item').forEach(btn => {
                btn.onclick = () => {
                    // Update active state
                    listEl.querySelectorAll('.embed-playlist-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Update embed with current theme
                    const currentTheme = document.body.dataset.theme || 'light';
                    const embedTheme = currentTheme === 'light' ? '1' : '0';
                    const idx = parseInt(btn.dataset.i);
                    const id = getID(playlists[idx].url);
                    if (id) {
                        playerEl.innerHTML = `<iframe src="https://open.spotify.com/embed/playlist/${id}?utm_source=generator&theme=${embedTheme}" allowfullscreen allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                    }
                };
            });
        }

        // Render form
        function renderForm() {
            const f = document.getElementById('form');
            const filledCount = work.filter(it => it.url && getID(it.url)).length;
            const showHandles = filledCount >= 2;
            
            f.innerHTML = work.map((it, i) => {
                const hasUrl = it.url && getID(it.url);
                const showHandle = showHandles && hasUrl;
                const imgSrc = it.img || '';
                return `
                <div class="pl-item" data-i="${i}">
                    ${hasUrl ? `<div class="pl-preview-wrap">
                        <div class="pl-preview ${imgSrc ? '' : 'empty'}">
                            ${imgSrc ? `<img src="${esc(imgSrc)}" alt="">` : '<span class="material-symbols-outlined">music_note_2</span>'}
                        </div>
                        <button class="pl-delete" data-i="${i}">Delete</button>
                    </div>` : ''}
                    <div class="pl-fields">
                        <div class="pl-url-row">
                            <input class="pl-input url" type="url" placeholder="Add Spotify playlist URL" value="${esc(it.url)}" data-i="${i}" data-f="url" autocapitalize="off" autocorrect="off">
                            ${showHandle ? `<div class="pl-reorder">
                                <button class="pl-move-up" data-i="${i}"><span class="material-symbols-outlined">keyboard_arrow_up</span></button>
                                <button class="pl-move-down" data-i="${i}"><span class="material-symbols-outlined">keyboard_arrow_down</span></button>
                            </div>` : ''}
                        </div>
                        <div class="pl-title">${esc(it.title) || 'Name will fill when you add playlist URL above'}</div>
                        <textarea class="pl-input pl-desc" placeholder="Add description" data-i="${i}" data-f="desc" rows="1">${esc(it.desc)}</textarea>
                    </div>
                </div>
            `}).join('');
            
            f.querySelectorAll('.pl-input').forEach(inp => {
                inp.oninput = async () => {
                    const idx = inp.dataset.i;
                    const field = inp.dataset.f;
                    work[idx][field] = inp.value;
                    
                    // Auto-expand textareas
                    if (inp.tagName === 'TEXTAREA') {
                        inp.style.height = 'auto';
                        inp.style.height = inp.scrollHeight + 'px';
                    }
                    
                    // If URL field and valid Spotify URL, fetch data
                    if (field === 'url' && getID(inp.value)) {
                        try {
                            const data = await fetchSpotify(inp.value);
                            work[idx].title = data.title || '';
                            work[idx].img = data.thumbnail_url || '';
                            renderForm();
                        } catch(e) {
                            // Invalid URL or fetch failed
                        }
                    }
                };
            });
            
            // Delete buttons
            f.querySelectorAll('.pl-delete').forEach(btn => {
                btn.onclick = () => {
                    const idx = parseInt(btn.dataset.i);
                    // Clear this item
                    work[idx] = { url: '', title: '', img: '', desc: '' };
                    // Sort: filled items first, empty items last
                    work.sort((a, b) => {
                        const aFilled = a.url.trim() ? 0 : 1;
                        const bFilled = b.url.trim() ? 0 : 1;
                        return aFilled - bFilled;
                    });
                    renderForm();
                };
            });
            
            // Auto-expand textareas on initial render
            f.querySelectorAll('textarea.pl-input').forEach(ta => {
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
            });
            
            // Reorder buttons (desktop)
            f.querySelectorAll('.pl-move-up').forEach(btn => {
                btn.onclick = () => {
                    const idx = parseInt(btn.dataset.i);
                    if (idx > 0) {
                        const temp = work[idx];
                        work[idx] = work[idx - 1];
                        work[idx - 1] = temp;
                        renderForm();
                    }
                };
            });
            
            f.querySelectorAll('.pl-move-down').forEach(btn => {
                btn.onclick = () => {
                    const idx = parseInt(btn.dataset.i);
                    if (idx < work.length - 1) {
                        const temp = work[idx];
                        work[idx] = work[idx + 1];
                        work[idx + 1] = temp;
                        renderForm();
                    }
                };
            });
            
            // Touch drag for mobile
            f.querySelectorAll('.pl-reorder').forEach(handle => {
                const item = handle.closest('.pl-item');
                let startY = 0;
                let currentY = 0;
                let isDragging = false;
                
                handle.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    startY = e.touches[0].clientY;
                    item.style.zIndex = '100';
                    item.style.opacity = '0.8';
                    item.style.background = 'var(--input)';
                }, { passive: true });
                
                handle.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    item.style.transform = `translateY(${diff}px)`;
                }, { passive: false });
                
                handle.addEventListener('touchend', () => {
                    if (!isDragging) return;
                    isDragging = false;
                    
                    const diff = currentY - startY;
                    const idx = parseInt(item.dataset.i);
                    
                    item.style.zIndex = '';
                    item.style.opacity = '';
                    item.style.background = '';
                    item.style.transform = '';
                    
                    // Threshold of 50px to swap
                    if (diff < -50 && idx > 0) {
                        const temp = work[idx];
                        work[idx] = work[idx - 1];
                        work[idx - 1] = temp;
                        renderForm();
                    } else if (diff > 50 && idx < work.length - 1) {
                        const temp = work[idx];
                        work[idx] = work[idx + 1];
                        work[idx + 1] = temp;
                        renderForm();
                    }
                });
            });
        }

        function updateCols() {
            document.querySelectorAll('#cols .seg-btn').forEach(b => {
                b.classList.toggle('on', +b.dataset.c === cfg.cols);
            });
        }

        /* --------------------------------------------
           VIEW NAVIGATION
           -------------------------------------------- */
        function updateMobileTopTray(context) {
            // context can be: 'home', 'home-related' (edit/share for your mixtape), 'other' (help/about/profile/widget), or 'friend'
            const homeBtn = document.getElementById('mobile-home-btn');
            const addBtn = document.getElementById('mobile-add-btn');
            const mixtapesBtn = document.getElementById('mobile-mixtapes-btn');
            const collabBtn = document.getElementById('mobile-collab-btn');
            
            if (!homeBtn) return;
            
            if (context === 'home' || context === 'home-related') {
                // Viewing your own mixtape content - home active, others inactive
                homeBtn.classList.add('active');
                addBtn.classList.remove('active');
                mixtapesBtn.classList.remove('active');
                collabBtn.classList.remove('active');
                // Clear the add input if it was open and reset mode to home
                if (mobileTopMode === 'add') {
                    mobileTopMode = 'home';
                    renderMobileTopScroll();
                } else if (mobileTopMode !== 'home') {
                    // If we were in mixtapes/collab mode, switch back to home mode
                    mobileTopMode = 'home';
                    renderMobileTopScroll();
                }
                // Clear current friend selection
                currentFriendIdx = null;
            } else if (context === 'other') {
                // Viewing help/about/profile/widget - deactivate home and add
                homeBtn.classList.remove('active');
                addBtn.classList.remove('active');
                // If add was active, clear it but keep mixtapes/collab state
                if (mobileTopMode === 'add') {
                    mobileTopMode = 'home';
                    renderMobileTopScroll();
                }
                // mixtapes/collab icons persist if they were set from tray
            } else if (context === 'friend') {
                // Viewing a friend/collected mixtape
                homeBtn.classList.remove('active');
                addBtn.classList.remove('active');
                // mixtapes or collab icon will be set by showFriend based on mixtape type
            }
        }
        
        // Legacy function for backward compatibility
        function updateMobileHomeActive(isHome) {
            if (isHome) {
                updateMobileTopTray('home');
            } else {
                updateMobileTopTray('other');
            }
        }
        
        function showMain() {
            isEditMode = false;
            document.getElementById('main-edit-btn').textContent = 'Edit';
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('main').classList.add('on');
            renderGrid();
            updateMobileHomeActive(true);
        }

        // Track if we're editing a saved mixtape
        let editingMixtapeIdx = null;
        let isEditMode = false;
        let currentEditIndex = null; // Index of playlist being edited in modal
        
        // Open playlist edit modal
        function openPlaylistEditModal(index, playlist) {
            currentEditIndex = index;
            
            const urlInput = document.getElementById('playlist-edit-url');
            const descInput = document.getElementById('playlist-edit-desc');
            const titleEl = document.getElementById('playlist-edit-title');
            const preview = document.getElementById('playlist-edit-preview');
            
            urlInput.value = playlist.url || '';
            urlInput.dataset.title = playlist.title || '';
            urlInput.dataset.img = playlist.img || '';
            descInput.value = playlist.desc || '';
            
            if (playlist.title) {
                titleEl.textContent = playlist.title;
            } else {
                titleEl.textContent = 'Name will fill when you add playlist URL above';
            }
            
            if (playlist.img) {
                preview.innerHTML = `<img src="${esc(playlist.img)}" alt="">`;
                preview.classList.remove('empty');
            } else {
                preview.innerHTML = '<span class="material-symbols-outlined">music_note_2</span>';
                preview.classList.add('empty');
            }
            
            document.getElementById('playlist-edit-modal').classList.add('open');
        }
        
        function showEdit(fromMixtape = false) {
            if (!fromMixtape) {
                // Normal edit from grid - copy items to work
                work = JSON.parse(JSON.stringify(items));
                // Clean up orphaned items (have title/img but no valid URL)
                work.forEach((it, i) => {
                    if (!it.url || !getID(it.url)) {
                        work[i] = { url: '', title: '', img: '', desc: '' };
                    }
                });
                // Sort filled items to top
                work.sort((a, b) => {
                    const aFilled = a.url.trim() ? 0 : 1;
                    const bFilled = b.url.trim() ? 0 : 1;
                    return aFilled - bFilled;
                });
                editingMixtapeIdx = null;
                // Load title/occasion from cfg (working state)
                document.getElementById('edit-title').value = cfg.workingTitle || '';
                // Note: empty string means user needs to select; don't pre-select anything
                const workingOccasion = cfg.workingOccasion || '';
                // Clear any previous selection first
                document.getElementById('edit-occasion-options').querySelectorAll('.custom-select-option').forEach(o => {
                    o.classList.remove('selected');
                });
                // Only select if there's a valid occasion set
                if (workingOccasion) {
                    document.getElementById('edit-occasion-options').querySelectorAll('.custom-select-option').forEach(o => {
                        if (o.dataset.value === workingOccasion) {
                            o.classList.add('selected');
                            document.getElementById('edit-occasion-label').textContent = o.textContent;
                        }
                    });
                } else {
                    document.getElementById('edit-occasion-label').textContent = 'Select';
                }
            } else {
                // Editing a mixtape - populate title and occasion
                if (editingMixtapeIdx !== null && mixtapes[editingMixtapeIdx]) {
                    const m = mixtapes[editingMixtapeIdx];
                    document.getElementById('edit-title').value = m.title || '';
                    const occasion = m.template || '';
                    // Clear any previous selection first
                    document.getElementById('edit-occasion-options').querySelectorAll('.custom-select-option').forEach(o => {
                        o.classList.remove('selected');
                    });
                    // Only select if there's a valid occasion set
                    if (occasion) {
                        document.getElementById('edit-occasion-options').querySelectorAll('.custom-select-option').forEach(o => {
                            if (o.dataset.value === occasion) {
                                o.classList.add('selected');
                                document.getElementById('edit-occasion-label').textContent = o.textContent;
                            }
                        });
                    } else {
                        document.getElementById('edit-occasion-label').textContent = 'Select';
                    }
                }
            }
            
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('edit').classList.add('on');
            renderForm();
            updateCols();
            updateMobileTopTray('home-related');
            updateSidebarActive('sidebar-edit-btn');
        }

        function showDive() {
            isEditMode = false;
            document.getElementById('dive-edit-btn').textContent = 'Edit';
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('dive').classList.add('on');
            renderDive();
            updateMobileHomeActive(true);
        }

        function renderDive() {
            const filled = items.filter(it => it.url && getID(it.url));
            
            // Show/hide toolbar based on filled count
            const diveToolbar = document.getElementById('dive-toolbar');
            const showToolbars = filled.length >= 3;
            
            if (diveToolbar) {
                diveToolbar.style.display = showToolbars ? 'flex' : 'none';
                // Populate title and occasion from cfg
                document.getElementById('dive-title').textContent = cfg.workingTitle || '';
                const occasionLabels = {
                    'favorites': 'Favorites',
                    'roadtrip': 'Road Trip',
                    'dinner': 'Dinner Party',
                    'workout': 'Workout',
                    'podcast': 'Podcast',
                    'focus': 'Focus'
                };
                // Show occasion only if set
                const diveOccasion = document.getElementById('dive-occasion');
                if (cfg.workingOccasion && occasionLabels[cfg.workingOccasion]) {
                    diveOccasion.style.display = '';
                    document.getElementById('dive-occasion-icon').textContent = cfg.workingOccasionIcon || '';
                    document.getElementById('dive-occasion-label').textContent = occasionLabels[cfg.workingOccasion];
                } else {
                    diveOccasion.style.display = 'none';
                }
            }
            
            const displayItems = filled.length >= 3 ? filled : items;
            
            const list = document.getElementById('dive-list');
            list.innerHTML = displayItems.map((it, i) => {
                const actualIndex = filled.length >= 3 ? items.indexOf(it) : i;
                return `
                <div class="dive-item ${isEditMode ? 'edit-mode' : ''}" data-i="${actualIndex}">
                    <div class="dive-img">
                        ${isEditMode && it.url ? `<button class="dive-delete" data-i="${actualIndex}"><span class="material-symbols-outlined">close</span></button>` : ''}
                        ${it.img ? `<img src="${esc(it.img)}" alt="">` : `<div class="dive-ph"><span class="material-symbols-outlined">music_note_2</span></div>`}
                    </div>
                    <div class="dive-info">
                        <div class="dive-title">${esc(it.title) || 'Add playlist'}</div>
                        ${it.desc ? `<div class="dive-desc">${esc(it.desc)}</div>` : ''}
                    </div>
                </div>
            `}).join('') + `<div class="dive-back"><button class="txt-btn" id="back-grid-btn">Back to Grid</button></div>`;
            
            // Delete button handlers (edit mode)
            list.querySelectorAll('.dive-delete').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.i);
                    items[idx] = { url: '', title: '', img: '', desc: '' };
                    items.sort((a, b) => (a.url ? 0 : 1) - (b.url ? 0 : 1));
                    save();
                    renderGrid();
                    renderDive();
                };
            });
            
            list.querySelectorAll('.dive-item').forEach(item => {
                item.onclick = () => {
                    const idx = parseInt(item.dataset.i);
                    const it = items[idx];
                    
                    if (isEditMode) {
                        // Open playlist edit modal
                        openPlaylistEditModal(idx, it);
                    } else {
                        const id = getID(it.url);
                        if (id) {
                            window.location.href = 'spotify:playlist:' + id;
                        } else {
                            // No URL - open edit modal to add
                            openPlaylistEditModal(idx, it);
                        }
                    }
                };
            });
            
            document.getElementById('back-grid-btn').onclick = showMain;
        }

        /* --------------------------------------------
           MIXTAPE SHARING & IMPORT
           -------------------------------------------- */
        function generateMixtapeString(name, title) {
            const filled = items.filter(it => it.url && getID(it.url));
            const data = {
                n: name,
                t: title || '',
                p: filled.map(it => ({
                    u: it.url,
                    t: it.title,
                    i: it.img,
                    d: it.desc
                }))
            };
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }
        
        function generateFullBackup(name, title) {
            const filled = items.filter(it => it.url && getID(it.url));
            const data = {
                v: 2, // version to identify full backup format
                n: name,
                t: title || '',
                p: filled.map(it => ({
                    u: it.url,
                    t: it.title,
                    i: it.img,
                    d: it.desc
                })),
                m: mixtapes.map(m => ({
                    n: m.name,
                    t: m.title,
                    p: m.playlists.map(p => ({
                        u: p.url,
                        t: p.title,
                        i: p.img,
                        d: p.desc
                    })),
                    a: m.added,
                    s: m.starred,
                    tp: m.template,
                    ti: m.templateIcon
                }))
            };
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }
        
        function parseMixtapeString(str) {
            try {
                const data = JSON.parse(decodeURIComponent(atob(str)));
                return {
                    name: data.n,
                    title: data.t || '',
                    playlists: data.p.map(p => ({
                        url: p.u,
                        title: p.t,
                        img: p.i,
                        desc: p.d
                    }))
                };
            } catch(e) {
                return null;
            }
        }
        
        function parseFullBackup(str) {
            try {
                const data = JSON.parse(decodeURIComponent(atob(str)));
                
                // Check if it's a full backup (v2) or old format
                if (data.v !== 2) {
                    return null; // Not a full backup
                }
                
                return {
                    name: data.n,
                    title: data.t || '',
                    playlists: data.p.map(p => ({
                        url: p.u,
                        title: p.t,
                        img: p.i,
                        desc: p.d
                    })),
                    mixtapes: (data.m || []).map(m => ({
                        name: m.n,
                        title: m.t,
                        playlists: m.p.map(p => ({
                            url: p.u,
                            title: p.t,
                            img: p.i,
                            desc: p.d
                        })),
                        added: m.a,
                        starred: m.s,
                        template: m.tp,
                        templateIcon: m.ti
                    }))
                };
            } catch(e) {
                return null;
            }
        }
        
        function renderMixtapesList() {
            const mixtapesEl = document.getElementById('mixtapes-list');
            const collabEl = document.getElementById('collab-list');
            
            // Split into curated (your own) vs friend mixtapes
            const curated = mixtapes.filter(m => m.template && !m.name);
            const friends = mixtapes.filter(m => !m.template || m.name);
            
            // Render Mixtapes section (curated only)
            if (mixtapesEl) {
                if (curated.length === 0) {
                    mixtapesEl.innerHTML = '<div class="no-mixtapes">Saved mixtapes here</div>';
                } else {
                    mixtapesEl.innerHTML = curated.map((m) => {
                        const idx = mixtapes.indexOf(m);
                        const label = m.title || 'My Mixtape';
                        return `<button class="mixtape-item" data-i="${idx}">${esc(label)}</button>`;
                    }).join('');
                    mixtapesEl.querySelectorAll('.mixtape-item').forEach(btn => {
                        btn.onclick = () => {
                            document.getElementById('menu').classList.remove('open');
                            showFriend(parseInt(btn.dataset.i));
                        };
                    });
                }
            }
            
            // Render Collaborate section (friend mixtapes)
            if (collabEl) {
                const starred = friends.filter(m => m.starred).sort((a, b) => new Date(b.added) - new Date(a.added));
                const unstarred = friends.filter(m => !m.starred).sort((a, b) => new Date(b.added) - new Date(a.added)).slice(0, 5);
                const toShow = [...starred, ...unstarred];
                
                if (toShow.length === 0) {
                    collabEl.innerHTML = '<div class="no-mixtapes">Ask a friend</div>';
                } else {
                    collabEl.innerHTML = toShow.map((m) => {
                        const idx = mixtapes.indexOf(m);
                        const label = m.title ? `${m.name}: ${m.title}` : m.name;
                        return `<button class="mixtape-item" data-i="${idx}">${esc(label)}</button>`;
                    }).join('');
                    collabEl.querySelectorAll('.mixtape-item').forEach(btn => {
                        btn.onclick = () => {
                            document.getElementById('menu').classList.remove('open');
                            showFriend(parseInt(btn.dataset.i));
                        };
                    });
                }
            }
            
            // Also update sidebar mixtapes
            renderSidebarMixtapes();
        }
        
        function updateSidebarActive(activeId) {
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.sidebar-mixtape-item').forEach(item => item.classList.remove('active'));
            if (activeId) {
                document.getElementById(activeId)?.classList.add('active');
            }
        }
        
        function renderSidebarThemes() {
            const el = document.getElementById('sidebar-themes');
            if (!el) return;
            
            const cur = document.body.dataset.theme || 'light';
            const opts = ['light', 'dark', 'spotify'];
            const tooltips = { light: 'Light', dark: 'Dark', spotify: 'Spotify' };
            
            el.innerHTML = opts.map(t => `<div class="theme-btn ${t===cur?'on':''}" data-t="${t}" data-tooltip="${tooltips[t]}"><span class="material-symbols-outlined">format_paint</span></div>`).join('') +
                `<a href="#" class="sidebar-footer-icon" id="sidebar-help-icon" data-tooltip="Help"><span class="material-symbols-outlined">tooltip_2</span></a>` +
                `<a href="/cdn-cgi/l/email-protection#92f1fdfef5d2f1fdfefbfcfff3ebfcf3e0f6bcfcf7e6" class="sidebar-footer-icon" data-tooltip="Email"><span class="material-symbols-outlined">mail</span></a>` +
                `<a href="https://buymeacoffee.com/fromnineteen80" target="_blank" class="sidebar-footer-icon" data-tooltip="Donate"><span class="material-symbols-outlined">local_cafe</span></a>`;
            
            el.querySelectorAll('.theme-btn').forEach(btn => {
                btn.onclick = () => {
                    setTheme(btn.dataset.t);
                    // Update both menu and sidebar theme buttons
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.toggle('on', b.dataset.t === btn.dataset.t);
                        b.classList.toggle('active', b.dataset.t === btn.dataset.t);
                    });
                };
            });
            
            // Help icon click handler
            document.getElementById('sidebar-help-icon').onclick = (e) => { 
                e.preventDefault();
                updateSidebarActive('sidebar-help-btn'); 
                showHelp(); 
            };
        }
        
        function renderSidebarMixtapes() {
            const mixtapesEl = document.getElementById('sidebar-mixtapes');
            const collaborateEl = document.getElementById('sidebar-collaborate');
            
            // Split into curated (your own) vs friend mixtapes
            const curated = mixtapes.filter(m => m.template && !m.name);
            const friends = mixtapes.filter(m => !m.template || m.name);
            
            // Render Mixtapes section (curated only)
            if (mixtapesEl) {
                if (curated.length === 0) {
                    mixtapesEl.innerHTML = '<div class="no-mixtapes">Saved mixtapes here</div>';
                } else {
                    mixtapesEl.innerHTML = curated.map((m) => {
                        const idx = mixtapes.indexOf(m);
                        const icon = m.templateIcon || 'album';
                        const label = m.title || 'My Mixtape';
                        return `<button class="sidebar-mixtape-item" data-i="${idx}"><span class="material-symbols-outlined">${icon}</span>${esc(label)}</button>`;
                    }).join('');
                    mixtapesEl.querySelectorAll('.sidebar-mixtape-item').forEach(btn => {
                        btn.onclick = () => {
                            showFriend(parseInt(btn.dataset.i));
                        };
                    });
                }
            }
            
            // Render Collaborate section (friend mixtapes)
            if (collaborateEl) {
                const starred = friends.filter(m => m.starred).sort((a, b) => new Date(b.added) - new Date(a.added));
                const unstarred = friends.filter(m => !m.starred).sort((a, b) => new Date(b.added) - new Date(a.added)).slice(0, 5);
                const toShow = [...starred, ...unstarred];
                
                if (toShow.length === 0) {
                    collaborateEl.innerHTML = '<div class="no-mixtapes">Ask a friend</div>';
                } else {
                    collaborateEl.innerHTML = toShow.map((m) => {
                        const idx = mixtapes.indexOf(m);
                        const icon = m.starred ? 'star' : 'play_arrow';
                        const label = m.title ? `${m.name}: ${m.title}` : m.name;
                        return `<button class="sidebar-mixtape-item" data-i="${idx}"><span class="material-symbols-outlined">${icon}</span>${esc(label)}</button>`;
                    }).join('');
                    collaborateEl.querySelectorAll('.sidebar-mixtape-item').forEach(btn => {
                        btn.onclick = () => {
                            showFriend(parseInt(btn.dataset.i));
                        };
                    });
                }
            }
        }
        
        /* --------------------------------------------
           COLLECTED MIXTAPES HANDLERS
           -------------------------------------------- */
        function toggleStar(idx) {
            mixtapes[idx].starred = !mixtapes[idx].starred;
            saveMixtapes();
            renderMixtapesList();
            renderCollectedList();
        }
        
        function removeItem(idx) {
            const m = mixtapes[idx];
            if (confirm(`Delete "${m.title}" from ${m.name}?`)) {
                mixtapes.splice(idx, 1);
                saveMixtapes();
                renderMixtapesList();
                renderCollectedList();
            }
        }
        
        function renderCollectedList() {
            const el = document.getElementById('collected-list');
            if (!el) return;
            
            if (mixtapes.length === 0) {
                el.innerHTML = '<div class="collected-empty">No mixtapes collected yet</div>';
                return;
            }
            
            const filterEl = document.querySelector('#mixtape-filter-options .selected');
            const filter = filterEl ? filterEl.dataset.value : 'newest';
            let sorted = [...mixtapes];
            
            // Starred always at top
            sorted.sort((a, b) => {
                if (a.starred && !b.starred) return -1;
                if (!a.starred && b.starred) return 1;
                
                if (filter === 'newest') {
                    return new Date(b.added) - new Date(a.added);
                } else if (filter === 'oldest') {
                    return new Date(a.added) - new Date(b.added);
                } else if (filter === 'friend') {
                    return a.name.localeCompare(b.name);
                }
                return 0;
            });
            
            el.innerHTML = sorted.map((m, sortedIdx) => {
                const idx = mixtapes.indexOf(m);
                const date = new Date(m.added).toLocaleDateString();
                return `
                    <div class="collected-item">
                        <div class="collected-star ${m.starred ? 'starred' : ''}" data-idx="${idx}"><span class="material-symbols-outlined">star</span></div>
                        <div class="collected-info" data-idx="${idx}">
                            <div class="collected-title">${esc(m.title)}</div>
                            <div class="collected-meta">Shared: ${date}</div>
                            <div class="collected-meta">From: ${esc(m.name)}</div>
                        </div>
                        <div class="collected-delete" data-idx="${idx}"><span class="material-symbols-outlined">close</span></div>
                    </div>
                `;
            }).join('');
            
            // Attach events after render
            const stars = el.querySelectorAll('.collected-star');
            const infos = el.querySelectorAll('.collected-info');
            const dels = el.querySelectorAll('.collected-delete');
            
            stars.forEach(star => {
                star.onclick = function() { toggleStar(parseInt(this.dataset.idx)); };
            });
            infos.forEach(info => {
                info.onclick = function() { showFriend(parseInt(this.dataset.idx)); };
            });
            dels.forEach(del => {
                del.onclick = function() { removeItem(parseInt(this.dataset.idx)); };
            });
        }
        
        function showShare() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('share').classList.add('on');
            const shareNameEl = document.getElementById('share-name');
            const shareTitleEl = document.getElementById('share-title');
            if (shareNameEl) shareNameEl.value = profile.name || '';
            if (shareTitleEl) shareTitleEl.value = '';
            document.getElementById('share-output').innerHTML = '';
            document.getElementById('import-string').value = '';
            renderCollectedList();
            updateMobileTopTray('home-related');
        }
        
        function showProfile() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('profile').classList.add('on');
            
            const hasData = profile.name || profile.spotifyUsername || profile.photo;
            const editCard = document.getElementById('profile-card-edit');
            const displayCard = document.getElementById('profile-card-display');
            
            // Load profile data into form
            document.getElementById('profile-name').value = profile.name || '';
            document.getElementById('profile-spotify-username').value = profile.spotifyUsername || '';
            
            // Show appropriate card based on whether user has data
            if (hasData) {
                if (editCard) editCard.style.display = 'none';
                if (displayCard) displayCard.style.display = 'flex';
            } else {
                if (editCard) editCard.style.display = 'flex';
                if (displayCard) displayCard.style.display = 'none';
            }
            
            renderProfileCard();
            renderThemes();
            
            // Reset backup/restore section
            document.getElementById('recovery-string').value = '';
            document.getElementById('recovery-btn').textContent = 'Restore';
            document.getElementById('recovery-btn').classList.remove('completed');
            document.getElementById('backup-output').innerHTML = '';
            
            updateMobileHomeActive(false);
        }
        
        function showAbout() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('about').classList.add('on');
            updateMobileHomeActive(false);
        }
        
        function showHelp() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('help').classList.add('on');
            updateMobileHomeActive(false);
        }
        
        let currentFriendMixtape = null;
        let currentFriendIdx = null;
        
        function showFriend(idx) {
            const mixtape = mixtapes[idx];
            if (!mixtape) return;
            
            isEditMode = false;
            
            currentFriendMixtape = mixtape;
            currentFriendIdx = idx;
            
            // Determine mixtape type
            const isCollab = mixtape.name && !mixtape.template && !mixtape.templateIcon;
            const isCurated = mixtape.template || mixtape.templateIcon;
            
            // Show/hide appropriate header
            document.getElementById('mixtape-header').style.display = isCurated ? 'flex' : 'none';
            document.getElementById('collab-header').style.display = isCollab ? 'block' : 'none';
            document.getElementById('collab-instructions').style.display = isCollab ? 'block' : 'none';
            
            if (isCurated) {
                // Set title
                document.getElementById('friend-title').textContent = mixtape.title || 'Untitled Mixtape';
                
                // Set occasion icon and label
                const occasionIcons = {
                    'favorites': 'album',
                    'roadtrip': 'directions_car',
                    'dinner': 'dining',
                    'workout': 'directions_run',
                    'podcast': 'podcasts',
                    'focus': 'mindfulness',
                    'mymix': 'music_note'
                };
                const occasionLabels = {
                    'favorites': 'Favorites',
                    'roadtrip': 'Road Trip',
                    'dinner': 'Dinner Party',
                    'workout': 'Workout',
                    'podcast': 'Podcast',
                    'focus': 'Focus',
                    'mymix': 'Mixtape'
                };
                const template = mixtape.template || 'roadtrip';
                document.getElementById('friend-occasion-icon').textContent = mixtape.templateIcon || occasionIcons[template] || 'music_note';
                document.getElementById('friend-occasion-label').textContent = occasionLabels[template] || 'Mixtape';
            } else if (isCollab) {
                // Set collab title
                document.getElementById('collab-title').textContent = mixtape.name ? 
                    `${mixtape.name} wants to collaborate on ${mixtape.title || 'Untitled'}` : 
                    mixtape.title || 'Collaboration';
            }
            
            // Update sidebar active state
            updateSidebarActive(null);
            document.querySelectorAll('.sidebar-mixtape-item').forEach(b => b.classList.remove('active'));
            const sidebarBtn = document.querySelector(`.sidebar-mixtape-item[data-i="${idx}"]`);
            if (sidebarBtn) sidebarBtn.classList.add('active');
            
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('friend').classList.add('on');
            
            // Update mobile top tray
            updateMobileTopTray('friend');
            const mixtapesBtn = document.getElementById('mobile-mixtapes-btn');
            const collabBtn = document.getElementById('mobile-collab-btn');
            if (mixtapesBtn && collabBtn) {
                mixtapesBtn.classList.toggle('active', isCurated);
                collabBtn.classList.toggle('active', isCollab);
            }
            
            renderFriendView();
        }
        
        function renderFriendView() {
            if (!currentFriendMixtape) return;
            const mixtape = currentFriendMixtape;
            
            const list = document.getElementById('friend-list');
            const grid = document.getElementById('friend-grid');
            const embedSection = document.getElementById('friend-embed-section');
            
            // Always show grid view
            list.style.display = 'none';
            grid.style.display = 'grid';
            
            const { cols } = calcGrid(mixtape.playlists.length);
            grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            // Check if this is a collab mixtape and can add more
            const isCollab = mixtape.name && !mixtape.template && !mixtape.templateIcon;
            const canAdd = (isCollab || isEditMode) && mixtape.playlists.length < 14;
            
            grid.innerHTML = mixtape.playlists.map((it, i) => `
                <div class="tile ${isEditMode ? 'edit-mode' : ''}" data-i="${i}">
                    ${isEditMode && it.url ? `<button class="tile-delete" data-i="${i}"><span class="material-symbols-outlined">close</span></button>` : ''}
                    <div class="tile-img">
                        ${it.img ? `<img src="${esc(it.img)}" alt="">` : `<div class="tile-ph"><span class="material-symbols-outlined">music_note_2</span></div>`}
                    </div>
                    <div class="tile-title">${esc(it.title) || 'Playlist'}</div>
                </div>
            `).join('') + (canAdd ? `
                <div class="tile ${isEditMode ? 'edit-mode' : ''} tile-add" id="collab-add-tile">
                    <div class="tile-img">
                        <div class="tile-ph tile-add-icon"><span class="material-symbols-outlined">add</span></div>
                    </div>
                    <div class="tile-title">Add playlist</div>
                </div>
            ` : '');
            
            // Delete button handlers (edit mode)
            grid.querySelectorAll('.tile-delete').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.i);
                    currentFriendMixtape.playlists.splice(idx, 1);
                    mixtapes[currentFriendIdx] = currentFriendMixtape;
                    saveMixtapes();
                    renderFriendView();
                    renderSidebarMixtapes();
                };
            });
            
            grid.querySelectorAll('.tile:not(.tile-add)').forEach(item => {
                item.onclick = () => {
                    const idx = parseInt(item.dataset.i);
                    const pl = mixtape.playlists[idx];
                    
                    if (isEditMode) {
                        // Open playlist edit modal
                        openPlaylistEditModal(idx, pl);
                    } else {
                        const id = getID(pl.url);
                        if (id) {
                            window.location.href = 'spotify:playlist:' + id;
                        }
                    }
                };
            });
            
            // Add tile click handler
            const addTile = document.getElementById('collab-add-tile');
                if (addTile) {
                    addTile.onclick = () => {
                        if (isEditMode) {
                            // Add empty playlist and open modal
                            const newIdx = currentFriendMixtape.playlists.length;
                            currentFriendMixtape.playlists.push({ url: '', title: '', img: '', desc: '' });
                            openPlaylistEditModal(newIdx, currentFriendMixtape.playlists[newIdx]);
                        } else {
                            showCollabAddForm();
                        }
                    };
                }
                
                // Show embed section for grid view
                if (embedSection && mixtape.playlists.length >= 1) {
                    embedSection.style.display = 'block';
                    renderEmbedSection('friend-embed-list', 'friend-embed-player', mixtape.playlists);
                }
        }
        
        function showCollabAddForm() {
            document.getElementById('friend-grid').style.display = 'none';
            document.getElementById('collab-add-form').style.display = 'block';
            document.getElementById('collab-url').value = '';
            document.getElementById('collab-url').focus();
        }
        
        function hideCollabAddForm() {
            document.getElementById('collab-add-form').style.display = 'none';
            document.getElementById('friend-grid').style.display = 'grid';
        }
        
        async function addCollabPlaylist() {
            if (!currentFriendMixtape || currentFriendIdx === null) return;
            
            const url = document.getElementById('collab-url').value.trim();
            if (!url) {
                showModal('Please paste a Spotify playlist link');
                return;
            }
            
            const id = getID(url);
            if (!id) {
                showModal('Invalid Spotify playlist link');
                return;
            }
            
            // Fetch playlist info
            try {
                const embedUrl = `https://open.spotify.com/embed/playlist/${id}`;
                const res = await fetch(embedUrl);
                const html = await res.text();
                
                const titleMatch = html.match(/<title>([^<]+)<\/title>/);
                const title = titleMatch ? titleMatch[1].replace(' | Spotify', '').replace(' - playlist by ', ' by ') : 'Playlist';
                
                const imgMatch = html.match(/content="(https:\/\/image-cdn-[^"]+)"/);
                const img = imgMatch ? imgMatch[1] : '';
                
                // Add to the mixtape
                currentFriendMixtape.playlists.push({
                    url: url,
                    title: title,
                    img: img,
                    desc: ''
                });
                
                saveMixtapes();
                hideCollabAddForm();
                renderFriendView();
            } catch (err) {
                showModal('Could not fetch playlist info. Please check the link.');
            }
        }

        /* --------------------------------------------
           EVENT HANDLERS & SETUP
           -------------------------------------------- */
        function setup() {
            const menu = document.getElementById('menu');
            const menuBtn = document.getElementById('menu-btn');
            
            // Title click goes home
            document.getElementById('title-btn').onclick = showMain;
            
            // Toggle menu
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                menu.classList.toggle('open');
            };
            
            // Close menu when clicking outside
            document.addEventListener('click', () => menu.classList.remove('open'));
            menu.onclick = (e) => e.stopPropagation();
            
            // Menu items
            document.getElementById('grid-btn').onclick = () => { menu.classList.remove('open'); showMain(); };
            document.getElementById('edit-btn').onclick = () => { menu.classList.remove('open'); showEdit(); };
            document.getElementById('share-btn').onclick = () => { menu.classList.remove('open'); showShare(); };
            document.getElementById('dive-btn').onclick = () => { menu.classList.remove('open'); showDive(); };
            document.getElementById('widget-btn').onclick = () => { menu.classList.remove('open'); showWidget(); };
            document.getElementById('about-btn').onclick = () => { menu.classList.remove('open'); showAbout(); };
            document.getElementById('menu-help-btn').onclick = () => { menu.classList.remove('open'); showHelp(); };
            document.getElementById('menu-profile-section').onclick = () => { menu.classList.remove('open'); showProfile(); };
            
            // Menu collapsible sections - sync with sidebar
            document.getElementById('menu-mixtapes-toggle').onclick = (e) => {
                e.stopPropagation();
                const toggle = e.currentTarget;
                toggle.classList.toggle('open');
                document.getElementById('mixtapes-list').classList.toggle('open');
                // Sync with sidebar
                const sidebarToggle = document.getElementById('sidebar-mixtapes-toggle');
                const sidebarContent = document.getElementById('sidebar-mixtapes');
                if (toggle.classList.contains('open')) {
                    sidebarToggle.classList.add('open');
                    sidebarContent.classList.add('open');
                } else {
                    sidebarToggle.classList.remove('open');
                    sidebarContent.classList.remove('open');
                }
            };
            document.getElementById('menu-collab-toggle').onclick = (e) => {
                e.stopPropagation();
                const toggle = e.currentTarget;
                toggle.classList.toggle('open');
                document.getElementById('collab-list').classList.toggle('open');
                // Sync with sidebar
                const sidebarToggle = document.getElementById('sidebar-collaborate-toggle');
                const sidebarContent = document.getElementById('sidebar-collaborate');
                if (toggle.classList.contains('open')) {
                    sidebarToggle.classList.add('open');
                    sidebarContent.classList.add('open');
                } else {
                    sidebarToggle.classList.remove('open');
                    sidebarContent.classList.remove('open');
                }
            };
            
            // Sidebar items (for larger screens)
            document.getElementById('sidebar-title').onclick = () => { updateSidebarActive('sidebar-grid-btn'); showMain(); };
            document.getElementById('sidebar-grid-btn').onclick = () => { updateSidebarActive('sidebar-grid-btn'); showMain(); };
            document.getElementById('sidebar-dive-btn').onclick = () => { updateSidebarActive('sidebar-dive-btn'); showDive(); };
            document.getElementById('sidebar-edit-btn').onclick = () => { updateSidebarActive('sidebar-edit-btn'); showEdit(); };
            document.getElementById('sidebar-share-btn').onclick = () => { updateSidebarActive('sidebar-share-btn'); showShare(); };
            document.getElementById('sidebar-widget-btn').onclick = () => { updateSidebarActive('sidebar-widget-btn'); showWidget(); };
            document.getElementById('sidebar-about-btn').onclick = () => { updateSidebarActive('sidebar-about-btn'); showAbout(); };
            
            // Sidebar footer
            document.getElementById('sidebar-profile-section').onclick = () => { updateSidebarActive(null); showProfile(); };
            document.getElementById('sidebar-help-btn').onclick = () => { updateSidebarActive(null); showHelp(); };
            
            // Sidebar toggle (collapse/expand)
            document.getElementById('sidebar-toggle').onclick = () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            };
            
            // Sidebar dropdown toggles - sync with menu
            document.getElementById('sidebar-mixtapes-toggle').onclick = () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    return;
                }
                const toggle = document.getElementById('sidebar-mixtapes-toggle');
                toggle.classList.toggle('open');
                document.getElementById('sidebar-mixtapes').classList.toggle('open');
                // Sync with menu
                const menuToggle = document.getElementById('menu-mixtapes-toggle');
                const menuContent = document.getElementById('mixtapes-list');
                if (toggle.classList.contains('open')) {
                    menuToggle.classList.add('open');
                    menuContent.classList.add('open');
                } else {
                    menuToggle.classList.remove('open');
                    menuContent.classList.remove('open');
                }
            };
            
            document.getElementById('sidebar-collaborate-toggle').onclick = () => {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('collapsed')) {
                    sidebar.classList.remove('collapsed');
                    return;
                }
                const toggle = document.getElementById('sidebar-collaborate-toggle');
                toggle.classList.toggle('open');
                document.getElementById('sidebar-collaborate').classList.toggle('open');
                // Sync with menu
                const menuToggle = document.getElementById('menu-collab-toggle');
                const menuContent = document.getElementById('collab-list');
                if (toggle.classList.contains('open')) {
                    menuToggle.classList.add('open');
                    menuContent.classList.add('open');
                } else {
                    menuToggle.classList.remove('open');
                    menuContent.classList.remove('open');
                }
            };
            
            // Render sidebar themes
            renderSidebarThemes();
            
            // Initialize profile theme picker
            initProfileThemePicker();
            
            // Share view buttons
            document.getElementById('generate-btn').onclick = async () => {
                const name = document.getElementById('share-name').value.trim();
                if (!name) {
                    showModal('Please enter your name');
                    return;
                }
                const title = document.getElementById('share-title').value.trim();
                if (!title) {
                    showModal('Please enter a mixtape title');
                    return;
                }
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length < 3) {
                    showModal('You need at least 3 playlists to share');
                    return;
                }
                const str = generateMixtapeString(name, title);
                
                // Build full URL with mixtape data
                const fullUrl = window.location.origin + window.location.pathname + '?m=' + encodeURIComponent(str);
                
                // Show loading state
                document.getElementById('share-output').innerHTML = `
                    <div class="share-success">Generating short URL...</div>
                `;
                
                // Try to get short URL using JSONP
                const callbackName = 'tinyurlCallback' + Date.now();
                window[callbackName] = async (data) => {
                    delete window[callbackName];
                    
                    if (data && data.shorturl) {
                        // Success - show both short URL and backup code
                        document.getElementById('share-output').innerHTML = `
                            <div class="share-success">Short URL ready!</div>
                            <div class="share-label">Short URL</div>
                            <div class="card">
                                <div class="pl-item">
                                    <div class="share-code" id="short-link">${data.shorturl}</div>
                                    <button class="action-btn full" id="copy-short-btn">Copy Short URL</button>
                                </div>
                            </div>
                            <div class="share-label" style="margin-top: 16px;">Backup Code</div>
                            <div class="card">
                                <div class="pl-item">
                                    <div class="share-code">${str}</div>
                                    <button class="action-btn full" id="copy-btn">Copy Code</button>
                                </div>
                            </div>
                        `;
                        
                        // Auto-copy short URL
                        try {
                            await navigator.clipboard.writeText(data.shorturl);
                            document.querySelector('.share-success').textContent = 'Short URL copied to clipboard!';
                            document.getElementById('copy-short-btn').innerHTML = 'Copied!';
                            document.getElementById('copy-short-btn').classList.add('completed');
                        } catch(e) {}
                        
                        document.getElementById('copy-short-btn').onclick = () => {
                            navigator.clipboard.writeText(data.shorturl).then(() => {
                                document.getElementById('copy-short-btn').innerHTML = 'Copied!';
                                document.getElementById('copy-short-btn').classList.add('completed');
                            });
                        };
                        
                        document.getElementById('copy-btn').onclick = () => {
                            navigator.clipboard.writeText(str).then(() => {
                                document.getElementById('copy-btn').innerHTML = 'Copied!';
                                document.getElementById('copy-btn').classList.add('completed');
                            });
                        };
                    } else {
                        showBackupCodeOnly();
                    }
                };
                
                const showBackupCodeOnly = () => {
                    document.getElementById('share-output').innerHTML = `
                        <div class="share-success">Full URL ready (shortener unavailable)</div>
                        <div class="share-label">Backup Code</div>
                        <div class="card">
                            <div class="pl-item">
                                <div class="share-code">${str}</div>
                                <button class="action-btn full" id="copy-btn">Copy Code</button>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('copy-btn').onclick = () => {
                        navigator.clipboard.writeText(str).then(() => {
                            document.getElementById('copy-btn').innerHTML = 'Copied!';
                            document.getElementById('copy-btn').classList.add('completed');
                        });
                    };
                };
                
                // Try is.gd first
                const script = document.createElement('script');
                script.src = 'https://is.gd/create.php?format=json&callback=' + callbackName + '&url=' + encodeURIComponent(fullUrl);
                
                // Timeout fallback - if no response in 5 seconds, show backup only
                const timeout = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        showBackupCodeOnly();
                    }
                }, 5000);
                
                script.onerror = () => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    showBackupCodeOnly();
                };
                document.body.appendChild(script);
            };
            
            document.getElementById('import-btn').onclick = () => {
                const str = document.getElementById('import-string').value.trim();
                if (!str) {
                    showModal('Please paste a mixtape code');
                    return;
                }
                const data = parseMixtapeString(str);
                if (!data) {
                    showModal('Invalid mixtape code');
                    return;
                }
                
                // Check for duplicates by comparing playlists
                const isDuplicate = mixtapes.some(m => {
                    if (!m.playlists && m.template) {
                        const parsed = parseMixtapeString(m.template);
                        if (parsed && parsed.playlists) {
                            return JSON.stringify(parsed.playlists.sort()) === JSON.stringify(data.playlists.sort());
                        }
                    }
                    return m.playlists && JSON.stringify(m.playlists.sort()) === JSON.stringify(data.playlists.sort());
                });
                
                if (isDuplicate) {
                    showModal('This mixtape is already in your collection');
                    return;
                }
                
                // Add with metadata
                mixtapes.push({
                    name: data.name,
                    title: data.title || '',
                    playlists: data.playlists,
                    added: new Date().toISOString(),
                    starred: false
                });
                const newIdx = mixtapes.length - 1;
                saveMixtapes();
                renderMixtapesList();
                renderCollectedList();
                document.getElementById('import-string').value = '';
                const label = data.title ? `${data.name}: ${data.title}` : data.name;
                showModalWithLink('Added ' + label + '!', 'View in Collaborate', () => {
                    showFriend(newIdx);
                    setMobileTopMode('collab');
                });
            };
            
            // Custom dropdown for filter
            const filterBtn = document.getElementById('mixtape-filter-btn');
            const filterOptions = document.getElementById('mixtape-filter-options');
            
            filterBtn.onclick = (e) => {
                e.stopPropagation();
                filterOptions.classList.toggle('open');
            };
            
            filterOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    filterOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('mixtape-filter-label').textContent = opt.textContent;
                    filterOptions.classList.remove('open');
                    renderCollectedList();
                };
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                filterOptions.classList.remove('open');
                document.getElementById('template-select-options').classList.remove('open');
            });
            
            // Template select dropdown
            const templateBtn = document.getElementById('template-select-btn');
            const templateOptions = document.getElementById('template-select-options');
            
            templateBtn.onclick = (e) => {
                e.stopPropagation();
                templateOptions.classList.toggle('open');
            };
            
            templateOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    templateOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('template-select-label').textContent = opt.textContent;
                    templateOptions.classList.remove('open');
                };
            });
            
            // Curate button - save your own mixtape with template
            document.getElementById('curate-btn').onclick = () => {
                const str = document.getElementById('curate-string').value.trim();
                if (!str) {
                    showModal('Please paste your share code');
                    return;
                }
                const data = parseMixtapeString(str);
                if (!data) {
                    showModal('Invalid share code');
                    return;
                }
                
                // Get selected template
                const selectedOpt = templateOptions.querySelector('.custom-select-option.selected');
                if (!selectedOpt) {
                    showModal('Please select an occasion for your mixtape');
                    return;
                }
                
                // Check for duplicates by comparing playlist URLs
                const newPlaylistUrls = data.playlists.map(p => getID(p.url)).sort().join(',');
                const isDuplicate = mixtapes.some(m => {
                    if (!m.playlists || m.playlists.length === 0) return false;
                    const existingUrls = m.playlists.map(p => getID(p.url)).sort().join(',');
                    return existingUrls === newPlaylistUrls;
                });
                
                if (isDuplicate) {
                    showModal('This mixtape is already in your collection');
                    return;
                }
                
                const template = selectedOpt.dataset.value;
                const templateIcon = selectedOpt.dataset.icon;
                
                // Add to mixtapes with template info (no name shown)
                mixtapes.unshift({
                    name: '', // Empty name means it's a curated mixtape
                    title: data.title || 'My Mixtape',
                    playlists: data.playlists,
                    starred: false,
                    addedAt: Date.now(),
                    template: template,
                    templateIcon: templateIcon
                });
                saveMixtapes();
                renderMixtapesList();
                renderCollectedList();
                renderSidebarMixtapes();
                document.getElementById('curate-string').value = '';
                // Reset template dropdown
                templateOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                document.getElementById('template-select-label').textContent = 'Select';
                showModal('Saved "' + (data.title || 'My Mixtape') + '" to your mixtapes!');
            };
            
            // Recovery
            document.getElementById('recovery-btn').onclick = () => {
                const str = document.getElementById('recovery-string').value.trim();
                if (!str) {
                    showModal('Please paste your backup code');
                    return;
                }
                
                // Try full backup format first
                const fullData = parseFullBackup(str);
                if (fullData) {
                    // Build confirmation message
                    let msg = `Restore "${fullData.title}" by ${fullData.name}?`;
                    const mixtapeCount = fullData.mixtapes.length;
                    if (mixtapeCount > 0) {
                        msg += ` This includes ${mixtapeCount} saved mixtape${mixtapeCount > 1 ? 's' : ''}.`;
                    }
                    msg += ' This will replace all your current data.';
                    
                    if (confirm(msg)) {
                        // Restore main mixtape
                        items = fullData.playlists.map(p => ({
                            url: p.url,
                            title: p.title,
                            img: p.img,
                            desc: p.desc
                        }));
                        save();
                        
                        // Restore all mixtapes (collected, curated, collaborated)
                        mixtapes = fullData.mixtapes;
                        saveMixtapes();
                        renderMixtapesList();
                        renderSidebarMixtapes();
                        
                        document.getElementById('recovery-string').value = '';
                        document.getElementById('recovery-btn').textContent = 'Restored!';
                        document.getElementById('recovery-btn').classList.add('completed');
                        setTimeout(() => showMain(), 2000);
                    }
                    return;
                }
                
                // Fall back to old format (just main mixtape)
                const data = parseMixtapeString(str);
                if (!data) {
                    showModal('Invalid backup code');
                    return;
                }
                if (confirm(`Restore "${data.title}" by ${data.name}? This will replace your current playlists.`)) {
                    items = data.playlists.map(p => ({
                        url: p.url,
                        title: p.title,
                        img: p.img,
                        desc: p.desc
                    }));
                    save();
                    document.getElementById('recovery-string').value = '';
                    document.getElementById('recovery-btn').textContent = 'Restored!';
                    document.getElementById('recovery-btn').classList.add('completed');
                    setTimeout(() => showMain(), 2000);
                }
            };
            
            // Backup generation button
            document.getElementById('backup-btn').onclick = () => {
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length < 3) {
                    showModal('You need at least 3 playlists in your mixtape to create a backup');
                    return;
                }
                
                // Use profile name or default
                const name = profile.name || 'Mixtaped User';
                // Generate title from name and date
                const date = new Date();
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const title = profile.spotifyUsername ? '@' + profile.spotifyUsername + ' - ' + dateStr : dateStr;
                
                const str = generateFullBackup(name, title);
                
                // Count what's being backed up
                const curatedCount = mixtapes.filter(m => m.template && !m.name).length;
                const friendCount = mixtapes.filter(m => !m.template || m.name).length;
                
                let summary = 'Backup includes: ' + filled.length + ' playlists in your mixtape';
                if (curatedCount > 0) summary += ', ' + curatedCount + ' curated mixtape' + (curatedCount > 1 ? 's' : '');
                if (friendCount > 0) summary += ', ' + friendCount + ' collected/collaborated mixtape' + (friendCount > 1 ? 's' : '');
                
                document.getElementById('backup-output').innerHTML = '<div class="share-success">Backup code generated!</div><p class="section-desc" style="margin-top: 8px;">' + summary + '</p><div class="share-label" style="margin-top: 12px;">Your Backup Code</div><div class="card"><div class="pl-item"><div class="share-code">' + str + '</div><button class="action-btn full" id="copy-backup-btn">Copy Code</button></div></div>';
                
                document.getElementById('copy-backup-btn').onclick = () => {
                    navigator.clipboard.writeText(str).then(() => {
                        document.getElementById('copy-backup-btn').textContent = 'Code Copied';
                        document.getElementById('copy-backup-btn').classList.add('completed');
                    });
                };
            };
            
            // GitHub Gist handlers
            // Load saved gist URL on page load
            if (profile.gistUrl) {
                document.getElementById('gist-url').value = profile.gistUrl;
                document.getElementById('gist-status').textContent = 'Gist URL saved. Click "Restore from Gist" to restore.';
            }
            
            // Save gist URL when input changes
            document.getElementById('gist-url').onchange = function() {
                profile.gistUrl = this.value.trim();
                saveProfile();
                if (profile.gistUrl) {
                    document.getElementById('gist-status').textContent = 'Gist URL saved.';
                } else {
                    document.getElementById('gist-status').textContent = '';
                }
            };
            
            document.getElementById('save-gist-btn').onclick = async () => {
                const gistUrl = document.getElementById('gist-url').value.trim();
                if (!gistUrl) {
                    showModal('Please enter your GitHub Gist raw URL first.');
                    return;
                }
                
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length < 3) {
                    showModal('You need at least 3 playlists in your mixtape to create a backup');
                    return;
                }
                
                // Generate backup code
                const name = profile.name || 'Mixtaped User';
                const date = new Date();
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const title = profile.spotifyUsername ? '@' + profile.spotifyUsername + ' - ' + dateStr : dateStr;
                const backupCode = generateFullBackup(name, title);
                
                // Copy to clipboard for manual paste
                await navigator.clipboard.writeText(backupCode);
                
                // Save the URL
                profile.gistUrl = gistUrl;
                saveProfile();
                
                showModal('Backup code copied! Now go to your gist, edit it, paste the code, and save. Your gist URL has been saved for easy restoring later.');
                document.getElementById('gist-status').textContent = 'Gist URL saved. Update your gist with the copied code.';
            };
            
            document.getElementById('restore-gist-btn').onclick = async () => {
                const gistUrl = profile.gistUrl || document.getElementById('gist-url').value.trim();
                if (!gistUrl) {
                    showModal('Please enter your GitHub Gist raw URL first, or paste your backup code in the manual restore section.');
                    return;
                }
                
                // Convert to raw URL if needed
                let rawUrl = gistUrl;
                if (gistUrl.includes('gist.github.com') && !gistUrl.includes('raw')) {
                    // Try to convert: https://gist.github.com/user/id -> https://gist.githubusercontent.com/user/id/raw
                    rawUrl = gistUrl.replace('gist.github.com', 'gist.githubusercontent.com') + '/raw';
                }
                
                try {
                    document.getElementById('restore-gist-btn').textContent = 'Loading...';
                    const response = await fetch(rawUrl);
                    if (!response.ok) throw new Error('Could not fetch gist');
                    const backupCode = await response.text();
                    
                    // Try to restore
                    document.getElementById('recovery-string').value = backupCode.trim();
                    document.getElementById('recovery-btn').click();
                    
                    document.getElementById('restore-gist-btn').textContent = 'Restore from Gist';
                    document.getElementById('gist-status').textContent = 'Restored successfully!';
                } catch (err) {
                    document.getElementById('restore-gist-btn').textContent = 'Restore from Gist';
                    showModal('Could not fetch from gist. Make sure you\'re using the raw URL (click "Raw" button on your gist page and copy that URL).');
                }
            };
            
            // Vestaboard handlers
            function renderVestaboardState() {
                const editMode = document.getElementById('vestaboard-edit-mode');
                const displayMode = document.getElementById('vestaboard-display-mode');
                const keyDisplay = document.getElementById('vestaboard-key-display');
                const keyInput = document.getElementById('vestaboard-api-key');
                
                if (profile.vestaboardKey) {
                    editMode.style.display = 'none';
                    displayMode.style.display = 'flex';
                    const key = profile.vestaboardKey;
                    const masked = key.length > 8 ? key.slice(0, 4) + '****' + key.slice(-4) : '********';
                    keyDisplay.textContent = masked;
                } else {
                    editMode.style.display = 'flex';
                    displayMode.style.display = 'none';
                    keyInput.value = '';
                }
            }
            
            document.getElementById('vestaboard-test-btn').onclick = async () => {
                const key = document.getElementById('vestaboard-api-key').value.trim();
                if (!key) {
                    showModal('Please enter your Vestaboard API key');
                    return;
                }
                
                const btn = document.getElementById('vestaboard-test-btn');
                btn.textContent = 'Testing...';
                btn.disabled = true;
                
                try {
                    const response = await fetch('https://rw.vestaboard.com/', {
                        method: 'POST',
                        headers: {
                            'X-Vestaboard-Read-Write-Key': key,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: 'MIXTAPED CONNECTED!' })
                    });
                    
                    if (response.ok) {
                        profile.vestaboardKey = key;
                        saveProfile();
                        renderVestaboardState();
                        document.getElementById('vestaboard-output').innerHTML = '<div class="share-success">Connected! Check your Vestaboard.</div>';
                    } else {
                        document.getElementById('vestaboard-output').innerHTML = '<div class="share-error">Invalid API key. Please check and try again.</div>';
                    }
                } catch (e) {
                    document.getElementById('vestaboard-output').innerHTML = '<div class="share-error">Connection failed. Please try again.</div>';
                }
                
                btn.textContent = 'Save';
                btn.disabled = false;
            };
            
            document.getElementById('vestaboard-edit-btn').onclick = () => {
                document.getElementById('vestaboard-edit-mode').style.display = 'flex';
                document.getElementById('vestaboard-display-mode').style.display = 'none';
                document.getElementById('vestaboard-api-key').value = profile.vestaboardKey || '';
                document.getElementById('vestaboard-output').innerHTML = '';
            };
            
            document.getElementById('vestaboard-delete-btn').onclick = () => {
                profile.vestaboardKey = '';
                saveProfile();
                renderVestaboardState();
                document.getElementById('vestaboard-output').innerHTML = '<div class="share-success">Vestaboard disconnected.</div>';
            };
            
            renderVestaboardState();
            
            // Profile input handlers
            document.getElementById('profile-name').oninput = (e) => {
                profile.name = e.target.value;
                saveProfile();
                renderSidebarAvatar();
                renderProfileCard();
            };
            
            let spotifyFetchTimeout = null;
            document.getElementById('profile-spotify-username').oninput = async (e) => {
                // Strip @ symbol if provided
                let username = e.target.value.trim();
                if (username.startsWith('@')) {
                    username = username.substring(1);
                    e.target.value = username; // Update input without @
                }
                profile.spotifyUsername = username;
                saveProfile();
                renderSidebarAvatar();
                renderProfileCard();
                
                // Debounce the fetch - wait 500ms after typing stops
                if (spotifyFetchTimeout) clearTimeout(spotifyFetchTimeout);
                
                if (username) {
                    spotifyFetchTimeout = setTimeout(async () => {
                        const spotifyData = await fetchSpotifyProfile(username);
                        if (spotifyData && profile.spotifyUsername === username) {
                            // Update photo if we don't have a manual upload
                            if (spotifyData.photo && profile.photoSource !== 'upload') {
                                profile.photo = spotifyData.photo;
                                profile.photoSource = 'spotify';
                                saveProfile();
                                renderProfilePhoto();
                                renderSidebarAvatar();
                                renderProfileCard();
                            }
                        }
                    }, 500);
                }
            };
            
            // Profile photo button (Add/Update)
            const photoBtn = document.getElementById('profile-photo-btn');
            if (photoBtn) {
                photoBtn.onclick = () => {
                    document.getElementById('profile-photo-input').click();
                };
            }
            
            // Profile avatar delete button (X in corner)
            const avatarDeleteEdit = document.getElementById('profile-avatar-delete-edit');
            if (avatarDeleteEdit) {
                avatarDeleteEdit.onclick = () => {
                    profile.photo = '';
                    profile.photoSource = '';
                    saveProfile();
                    renderProfileCard();
                    renderSidebarAvatar();
                };
            }
            
            // Profile photo input change
            document.getElementById('profile-photo-input').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    profile.photo = event.target.result;
                    profile.photoSource = 'upload';
                    saveProfile();
                    renderProfileCard();
                    renderSidebarAvatar();
                };
                reader.readAsDataURL(file);
            };
            
            // Profile edit button (switch to edit mode)
            const editBtn = document.getElementById('profile-card-edit-btn');
            if (editBtn) {
                editBtn.onclick = showProfileEditMode;
            }
            
            // Profile save button (switch to display mode)
            const saveBtn = document.getElementById('profile-save-btn');
            if (saveBtn) {
                saveBtn.onclick = () => {
                    const nameInput = document.getElementById('profile-name');
                    const name = nameInput.value.trim();
                    if (!name) {
                        showModal('Name is required');
                        nameInput.focus();
                        return;
                    }
                    profile.name = name;
                    profile.spotifyUsername = document.getElementById('profile-spotify-username').value.trim();
                    saveProfile();
                    renderSidebarAvatar();
                    switchToDisplayMode();
                };
            }
            
            document.getElementById('share-back-btn').onclick = showMain;
            document.getElementById('friend-back-btn').onclick = showMain;
            document.getElementById('about-back-btn').onclick = showMain;
            document.getElementById('help-back-btn').onclick = showMain;
            
            // Mixtape action buttons (Edit, Copy, Delete)
            document.getElementById('friend-edit-btn').onclick = function() {
                if (!currentFriendMixtape) return;
                isEditMode = !isEditMode;
                this.textContent = isEditMode ? 'Done' : 'Edit';
                renderFriendView();
            };
            
            document.getElementById('friend-copy-btn').onclick = async function() {
                if (!currentFriendMixtape) return;
                
                // Generate share code
                const data = {
                    n: '',
                    t: currentFriendMixtape.title || '',
                    p: currentFriendMixtape.playlists.map(it => ({
                        u: it.url,
                        t: it.title,
                        i: it.img,
                        d: it.desc
                    }))
                };
                const str = btoa(encodeURIComponent(JSON.stringify(data)));
                
                await navigator.clipboard.writeText(str);
                showModal('Share code copied to clipboard!');
            };
            
            document.getElementById('friend-delete-btn').onclick = function() {
                if (!currentFriendMixtape || currentFriendIdx === null) return;
                
                showModalChoice('Are you sure you want to delete this mixtape?', 
                    'Delete', 
                    'Cancel',
                    () => {
                        mixtapes.splice(currentFriendIdx, 1);
                        currentFriendMixtape = null;
                        currentFriendIdx = null;
                        saveMixtapes();
                        renderMixtapesList();
                        renderCollectedList();
                        renderSidebarMixtapes();
                        
                        // Return to home grid
                        updateSidebarActive('sidebar-grid-btn');
                        showMain();
                    },
                    () => {}
                );
            };
            
            // Collaboration copy handler
            document.getElementById('collab-copy-btn').onclick = async function() {
                if (!currentFriendMixtape) return;
                
                const yourName = document.getElementById('collab-name').value.trim();
                if (!yourName) {
                    showModal('Please add your name');
                    return;
                }
                
                // Build combined name: "OriginalName & YourName"
                const combinedName = currentFriendMixtape.name ? 
                    `${currentFriendMixtape.name} & ${yourName}` : yourName;
                
                // Generate code with the friend's playlists and combined name
                const data = {
                    n: combinedName,
                    t: currentFriendMixtape.title || '',
                    p: currentFriendMixtape.playlists.map(it => ({
                        u: it.url,
                        t: it.title,
                        i: it.img,
                        d: it.desc
                    }))
                };
                const str = btoa(encodeURIComponent(JSON.stringify(data)));
                
                try {
                    await navigator.clipboard.writeText(str);
                    const btn = this;
                    const originalBtnHTML = btn.innerHTML;
                    const label = document.getElementById('friend-title');
                    const originalLabelText = label.textContent;
                    
                    btn.innerHTML = '<span class="material-symbols-outlined">check</span>';
                    label.textContent = 'Copied';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.innerHTML = originalBtnHTML;
                        label.textContent = originalLabelText;
                        btn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    showModal('Could not copy to clipboard');
                }
            };
            
            // Collab add form handlers
            document.getElementById('collab-add-cancel').onclick = hideCollabAddForm;
            document.getElementById('collab-add-save').onclick = addCollabPlaylist;
            
            // Copy share code buttons on main/dive views
            async function copyShareCode(btn, nameInputId, titleInputId) {
                const name = document.getElementById(nameInputId).value.trim();
                if (!name) {
                    showModal('Please add your name');
                    return;
                }
                const title = document.getElementById(titleInputId).value.trim() || 'My Mixtape';
                const str = generateMixtapeString(name, title);
                
                try {
                    await navigator.clipboard.writeText(str);
                    const originalBtnHTML = btn.innerHTML;
                    const label = btn.parentElement.querySelector('.toggle-label');
                    const originalLabelText = label.textContent;
                    
                    // Show check icon and "Copied" text to left
                    btn.innerHTML = '<span class="material-symbols-outlined">check</span>';
                    label.textContent = 'Copied';
                    btn.classList.add('copied');
                    
                    // Also update Share page inputs
                    const shareNameEl = document.getElementById('share-name');
                    const shareTitleEl = document.getElementById('share-title');
                    if (shareNameEl) shareNameEl.value = name;
                    if (shareTitleEl) shareTitleEl.value = title;
                    
                    // Trigger short URL generation for Share page
                    const fullUrl = window.location.origin + window.location.pathname + '?m=' + encodeURIComponent(str);
                    
                    document.getElementById('share-output').innerHTML = `
                        <div class="share-success">Generating short URL...</div>
                    `;
                    
                    const callbackName = 'tinyurlCallback' + Date.now();
                    window[callbackName] = async (data) => {
                        delete window[callbackName];
                        
                        if (data && data.shorturl) {
                            document.getElementById('share-output').innerHTML = `
                                <div class="share-success">Short URL ready!</div>
                                <div class="share-label">Short URL</div>
                                <div class="card">
                                    <div class="pl-item">
                                        <div class="share-code" id="short-link">${data.shorturl}</div>
                                        <button class="action-btn full" id="copy-short-btn">Copy Short URL</button>
                                    </div>
                                </div>
                                <div class="share-label" style="margin-top: 16px;">Backup Code</div>
                                <div class="card">
                                    <div class="pl-item">
                                        <div class="share-code">${str}</div>
                                        <button class="action-btn full" id="copy-btn">Copy Code</button>
                                    </div>
                                </div>
                            `;
                            
                            document.getElementById('copy-short-btn').onclick = () => {
                                navigator.clipboard.writeText(data.shorturl).then(() => {
                                    document.getElementById('copy-short-btn').innerHTML = 'Copied!';
                                    document.getElementById('copy-short-btn').classList.add('completed');
                                });
                            };
                            
                            document.getElementById('copy-btn').onclick = () => {
                                navigator.clipboard.writeText(str).then(() => {
                                    document.getElementById('copy-btn').innerHTML = 'Copied!';
                                    document.getElementById('copy-btn').classList.add('completed');
                                });
                            };
                        } else {
                            document.getElementById('share-output').innerHTML = `
                                <div class="share-success">Code ready (shortener unavailable)</div>
                                <div class="share-label">Backup Code</div>
                                <div class="card">
                                    <div class="pl-item">
                                        <div class="share-code">${str}</div>
                                        <button class="action-btn full" id="copy-btn">Copy Code</button>
                                    </div>
                                </div>
                            `;
                            document.getElementById('copy-btn').onclick = () => {
                                navigator.clipboard.writeText(str).then(() => {
                                    document.getElementById('copy-btn').innerHTML = 'Copied!';
                                    document.getElementById('copy-btn').classList.add('completed');
                                });
                            };
                        }
                    };
                    
                    const script = document.createElement('script');
                    script.src = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(fullUrl)}&format=jsonp&callback=${callbackName}`;
                    script.onerror = () => {
                        delete window[callbackName];
                        document.getElementById('share-output').innerHTML = `
                            <div class="share-success">Code copied!</div>
                            <div class="share-label">Your Share Code</div>
                            <div class="share-code">${str}</div>
                            <p style="margin-top: 12px; font-size: var(--font-small); color: var(--text3);">Save this code in your Notes app or at notepad.cc in case you need to recover your mixtape later.</p>
                        `;
                    };
                    document.body.appendChild(script);
                    
                    setTimeout(() => {
                        btn.innerHTML = originalBtnHTML;
                        label.textContent = originalLabelText;
                        btn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    showModal('Could not copy to clipboard');
                }
            }
            
            // Grid Layout toolbar buttons
            document.getElementById('main-edit-btn').onclick = function() { 
                toggleEditMode('main');
            };
            document.getElementById('main-copy-btn').onclick = function() {
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length < 3) {
                    showModal('You need at least 3 playlists to copy');
                    return;
                }
                const str = generateMixtapeString(profile.name, '');
                navigator.clipboard.writeText(str).then(() => {
                    showModal('Share code copied to clipboard!');
                });
            };
            document.getElementById('main-save-btn').onclick = function() { openSaveShareModal(); };
            document.getElementById('main-new-btn').onclick = function() { checkUnsavedAndNew(); };
            
            // Deep Dive toolbar buttons
            document.getElementById('dive-edit-btn').onclick = function() { 
                toggleEditMode('dive');
            };
            document.getElementById('dive-copy-btn').onclick = function() {
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length < 3) {
                    showModal('You need at least 3 playlists to copy');
                    return;
                }
                const str = generateMixtapeString(profile.name, '');
                navigator.clipboard.writeText(str).then(() => {
                    showModal('Share code copied to clipboard!');
                });
            };
            document.getElementById('dive-save-btn').onclick = function() { openSaveShareModal(); };
            document.getElementById('dive-new-btn').onclick = function() { checkUnsavedAndNew(); };
            
            // Toggle edit mode for inline editing
            function toggleEditMode(view) {
                isEditMode = !isEditMode;
                const editBtn = document.getElementById(view + '-edit-btn');
                if (isEditMode) {
                    editBtn.textContent = 'Done';
                } else {
                    editBtn.textContent = 'Edit';
                }
                if (view === 'main') {
                    renderGrid();
                } else if (view === 'dive') {
                    renderDive();
                }
            }
            
            // Playlist Edit Modal handlers
            document.getElementById('playlist-edit-cancel').onclick = function() {
                document.getElementById('playlist-edit-modal').classList.remove('open');
                currentEditIndex = null;
            };
            
            document.getElementById('playlist-edit-modal').onclick = function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                    currentEditIndex = null;
                }
            };
            
            document.getElementById('playlist-edit-url').oninput = async function() {
                const url = this.value.trim();
                if (getID(url)) {
                    try {
                        const data = await fetchSpotify(url);
                        document.getElementById('playlist-edit-title').textContent = data.title || 'Unknown';
                        const preview = document.getElementById('playlist-edit-preview');
                        if (data.thumbnail_url) {
                            preview.innerHTML = `<img src="${esc(data.thumbnail_url)}" alt="">`;
                            preview.classList.remove('empty');
                        }
                        // Store fetched data temporarily
                        document.getElementById('playlist-edit-url').dataset.title = data.title || '';
                        document.getElementById('playlist-edit-url').dataset.img = data.thumbnail_url || '';
                    } catch(e) {
                        document.getElementById('playlist-edit-title').textContent = 'Could not fetch playlist info';
                    }
                }
            };
            
            document.getElementById('playlist-edit-delete').onclick = function() {
                // Clear the fields in the modal
                document.getElementById('playlist-edit-url').value = '';
                document.getElementById('playlist-edit-url').dataset.title = '';
                document.getElementById('playlist-edit-url').dataset.img = '';
                document.getElementById('playlist-edit-desc').value = '';
                document.getElementById('playlist-edit-title').textContent = 'Name will fill when you add playlist URL above';
                const preview = document.getElementById('playlist-edit-preview');
                preview.innerHTML = '<span class="material-symbols-outlined">music_note_2</span>';
                preview.classList.add('empty');
            };
            
            document.getElementById('playlist-edit-save').onclick = async function() {
                const url = document.getElementById('playlist-edit-url').value.trim();
                const desc = document.getElementById('playlist-edit-desc').value.trim();
                let title = document.getElementById('playlist-edit-url').dataset.title || '';
                let img = document.getElementById('playlist-edit-url').dataset.img || '';
                
                // If URL is valid but we don't have title/img, fetch it now
                if (url && getID(url) && !title) {
                    try {
                        const data = await fetchSpotify(url);
                        title = data.title || '';
                        img = data.thumbnail_url || '';
                    } catch(e) {
                        console.error('Could not fetch playlist:', e);
                    }
                }
                
                if (currentEditIndex !== null) {
                    // Determine which array to update
                    if (currentFriendMixtape && currentFriendIdx !== null) {
                        // Editing a saved mixtape
                        if (url && getID(url)) {
                            currentFriendMixtape.playlists[currentEditIndex] = { url, title, img, desc };
                        } else {
                            // Delete this playlist
                            currentFriendMixtape.playlists.splice(currentEditIndex, 1);
                        }
                        mixtapes[currentFriendIdx] = currentFriendMixtape;
                        saveMixtapes();
                        renderFriendView();
                    } else {
                        // Editing working items
                        if (url && getID(url)) {
                            items[currentEditIndex] = { url, title, img, desc };
                        } else {
                            items[currentEditIndex] = { url: '', title: '', img: '', desc: '' };
                            // Sort filled items to front
                            items.sort((a, b) => (a.url ? 0 : 1) - (b.url ? 0 : 1));
                        }
                        save();
                        renderGrid();
                        renderDive();
                    }
                }
                
                document.getElementById('playlist-edit-modal').classList.remove('open');
                currentEditIndex = null;
            };
            
            function renderFriendView() {
                if (currentFriendMixtape && currentFriendIdx !== null) {
                    showFriend(currentFriendIdx);
                }
            }
            
            // Check for unsaved work before starting new
            function checkUnsavedAndNew() {
                const filled = items.filter(it => it.url && getID(it.url));
                if (filled.length >= 3) {
                    // Check if this matches any saved mixtape
                    const currentIds = filled.map(it => getID(it.url)).sort().join(',');
                    const isSaved = mixtapes.some(m => {
                        if (!m.playlists) return false;
                        const savedIds = m.playlists.map(p => getID(p.url) || p.id).sort().join(',');
                        return savedIds === currentIds;
                    });
                    
                    if (!isSaved) {
                        // Unsaved work - prompt user
                        showModalChoice('You have unsaved work. Save it first?', 
                            'Save', () => { openSaveShareModal(); },
                            'Discard', () => { clearAndStartNew(); }
                        );
                        return;
                    }
                }
                clearAndStartNew();
            }
            
            function clearAndStartNew() {
                items = [];
                for (let i = 0; i < 9; i++) {
                    items.push({ url: '', title: '', img: '', desc: '' });
                }
                // Reset working title, occasion, and mixtape link
                cfg.workingTitle = '';
                cfg.workingOccasion = '';
                cfg.workingOccasionIcon = '';
                cfg.workingMixtapeIdx = null;
                save();
                renderGrid();
                updateSidebarActive('sidebar-grid-btn');
                showMain();
            }
            
            // Save & Share modal template dropdown
            const saveShareTemplateBtn = document.getElementById('save-share-template-btn');
            const saveShareTemplateOptions = document.getElementById('save-share-template-options');
            
            saveShareTemplateBtn.onclick = (e) => {
                e.stopPropagation();
                saveShareTemplateOptions.classList.toggle('open');
            };
            
            saveShareTemplateOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    saveShareTemplateOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('save-share-template-label').textContent = opt.textContent;
                    saveShareTemplateOptions.classList.remove('open');
                };
            });
            
            // Edit view occasion dropdown
            const editOccasionBtn = document.getElementById('edit-occasion-btn');
            const editOccasionOptions = document.getElementById('edit-occasion-options');
            
            editOccasionBtn.onclick = (e) => {
                e.stopPropagation();
                editOccasionOptions.classList.toggle('open');
            };
            
            editOccasionOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    editOccasionOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('edit-occasion-label').textContent = opt.textContent;
                    editOccasionOptions.classList.remove('open');
                };
            });
            
            // Save & Share modal handlers
            function openSaveShareModal() {
                const saveShareTitle = document.getElementById('save-share-title');
                const templateOpts = document.getElementById('save-share-template-options');
                
                // Pre-fill with existing title if set
                saveShareTitle.value = cfg.workingTitle || '';
                
                // Clear any previous selection first
                templateOpts.querySelectorAll('.custom-select-option').forEach(o => {
                    o.classList.remove('selected');
                });
                
                // Pre-select existing occasion if set, otherwise show Select
                const currentOccasion = cfg.workingOccasion || '';
                if (currentOccasion) {
                    templateOpts.querySelectorAll('.custom-select-option').forEach(o => {
                        if (o.dataset.value === currentOccasion) {
                            o.classList.add('selected');
                            document.getElementById('save-share-template-label').textContent = o.textContent;
                        }
                    });
                } else {
                    document.getElementById('save-share-template-label').textContent = 'Select';
                }
                
                // Reset feedback and button state
                document.getElementById('save-share-feedback').innerHTML = '';
                document.getElementById('save-share-feedback').classList.remove('success');
                document.getElementById('save-share-confirm').textContent = 'Save & Copy Link';
                document.getElementById('save-share-confirm').classList.remove('completed');
                
                // Reset modal description
                const modalDesc = document.querySelector('.save-share-modal-content .modal-desc');
                if (modalDesc) {
                    modalDesc.textContent = 'Save your mixtape to your collection and share it with friends.';
                }
                
                document.getElementById('save-share-modal').classList.add('open');
                
                // Only focus title if empty
                if (!saveShareTitle.value) {
                    saveShareTitle.focus();
                }
            }
            
            document.getElementById('save-share-cancel').onclick = function() {
                document.getElementById('save-share-modal').classList.remove('open');
            };
            
            document.getElementById('save-share-modal').onclick = function(e) {
                if (e.target === this) {
                    this.classList.remove('open');
                }
            };
            
            document.getElementById('save-share-confirm').onclick = async function() {
                try {
                    const title = document.getElementById('save-share-title').value.trim();
                    
                    if (!title) {
                        showModal('Please enter a title for your mixtape');
                        return;
                    }
                    
                    // Get selected template from modal dropdown
                    const modalTemplateOptions = document.getElementById('save-share-template-options');
                    const selectedOpt = modalTemplateOptions.querySelector('.custom-select-option.selected');
                    
                    if (!selectedOpt) {
                        showModal('Please select an occasion for your mixtape');
                        return;
                    }
                    
                    const templateValue = selectedOpt.dataset.value;
                    const templateIcon = selectedOpt.dataset.icon;
                    
                    // Use profile name
                    const name = profile.name || '';
                    
                    // Generate share code
                    const filled = items.filter(it => it.url && getID(it.url));
                    if (filled.length < 3) {
                        showModal('You need at least 3 playlists to share');
                        return;
                    }
                    
                    const str = generateMixtapeString(name, title);
                    const data = parseMixtapeString(str);
                    
                    if (!data || !data.playlists) {
                        showModal('Could not generate share code');
                        return;
                    }
                    
                    // Check if we're editing an existing mixtape
                    if (cfg.workingMixtapeIdx !== null && cfg.workingMixtapeIdx !== undefined && mixtapes[cfg.workingMixtapeIdx]) {
                        // Update existing mixtape
                        mixtapes[cfg.workingMixtapeIdx].title = title;
                        mixtapes[cfg.workingMixtapeIdx].playlists = data.playlists;
                        mixtapes[cfg.workingMixtapeIdx].template = templateValue;
                        mixtapes[cfg.workingMixtapeIdx].templateIcon = templateIcon;
                        saveMixtapes();
                        renderMixtapesList();
                        renderCollectedList();
                        renderSidebarMixtapes();
                        
                        // Update cfg with new values
                        cfg.workingTitle = title;
                        cfg.workingOccasion = templateValue;
                        cfg.workingOccasionIcon = templateIcon;
                        save();
                        
                        // Copy to clipboard
                        await navigator.clipboard.writeText(str);
                        
                        // Show success feedback
                        const feedback = document.getElementById('save-share-feedback');
                        feedback.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Updated & copied to clipboard!';
                        feedback.classList.add('success');
                        
                        // Update button to show success
                        this.textContent = 'Done!';
                        this.classList.add('completed');
                        
                        // Close modal after delay
                        setTimeout(() => {
                            document.getElementById('save-share-modal').classList.remove('open');
                        }, 2000);
                        
                        // Re-render views
                        renderGrid();
                        renderDive();
                        return;
                    }
                    
                    // Check for duplicates by comparing playlist URLs (only for new mixtapes)
                    const newPlaylistUrls = filled.map(p => getID(p.url)).sort().join(',');
                    const duplicateIdx = mixtapes.findIndex(m => {
                        if (!m.playlists || m.playlists.length === 0) return false;
                        const existingUrls = m.playlists.map(p => getID(p.url)).sort().join(',');
                        return existingUrls === newPlaylistUrls;
                    });
                    
                    if (duplicateIdx !== -1) {
                        // Found matching mixtape - update it instead of creating duplicate
                        mixtapes[duplicateIdx].title = title;
                        mixtapes[duplicateIdx].playlists = data.playlists;
                        mixtapes[duplicateIdx].template = templateValue;
                        mixtapes[duplicateIdx].templateIcon = templateIcon;
                        saveMixtapes();
                        renderMixtapesList();
                        renderCollectedList();
                        renderSidebarMixtapes();
                        
                        // Link working items to this mixtape
                        cfg.workingMixtapeIdx = duplicateIdx;
                        cfg.workingTitle = title;
                        cfg.workingOccasion = templateValue;
                        cfg.workingOccasionIcon = templateIcon;
                        save();
                        
                        // Copy to clipboard
                        await navigator.clipboard.writeText(str);
                        
                        // Update modal description
                        const modalDesc = document.querySelector('.save-share-modal-content .modal-desc');
                        if (modalDesc) {
                            modalDesc.textContent = 'Your mixtape has been updated and copied to your clipboard.';
                        }
                        
                        // Show success feedback
                        const feedback = document.getElementById('save-share-feedback');
                        feedback.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Updated & copied to clipboard!';
                        feedback.classList.add('success');
                        
                        // Update button to show success
                        this.textContent = 'Done!';
                        this.classList.add('completed');
                        
                        // Close modal after delay
                        setTimeout(() => {
                            document.getElementById('save-share-modal').classList.remove('open');
                        }, 2000);
                        
                        // Re-render views
                        renderGrid();
                        renderDive();
                        return;
                    }
                    
                    // Save NEW mixtape
                    mixtapes.unshift({
                        name: '',
                        title: title,
                        playlists: data.playlists,
                        starred: false,
                        addedAt: Date.now(),
                        template: templateValue,
                        templateIcon: templateIcon
                    });
                    saveMixtapes();
                    renderMixtapesList();
                    renderCollectedList();
                    renderSidebarMixtapes();
                    
                    // Link working items to this new mixtape (it's at index 0 since we unshifted)
                    cfg.workingMixtapeIdx = 0;
                    cfg.workingTitle = title;
                    cfg.workingOccasion = templateValue;
                    cfg.workingOccasionIcon = templateIcon;
                    save();
                    
                    // Pre-fill the Curate section on Share page
                    const curateInput = document.getElementById('curate-string');
                    if (curateInput) curateInput.value = str;
                    
                    // Select the same template in the Curate page dropdown
                    const templateOptions = document.getElementById('template-select-options');
                    if (templateOptions) {
                        templateOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                            opt.classList.remove('selected');
                            if (opt.dataset.value === templateValue) {
                                opt.classList.add('selected');
                                document.getElementById('template-select-label').textContent = opt.textContent;
                            }
                        });
                    }
                    
                    // Copy to clipboard
                    await navigator.clipboard.writeText(str);
                    
                    // Show success feedback
                    const feedback = document.getElementById('save-share-feedback');
                    feedback.innerHTML = '<span class="material-symbols-outlined">check_circle</span> Saved & copied to clipboard!';
                    feedback.classList.add('success');
                    
                    // Update button to show success
                    this.textContent = 'Done!';
                    this.classList.add('completed');
                    
                    // Close modal after delay
                    setTimeout(() => {
                        document.getElementById('save-share-modal').classList.remove('open');
                    }, 2000);
                } catch (err) {
                    console.error('Save & Share error:', err);
                    showModal('Something went wrong. Please try again.');
                }
            };

            // Edit view buttons
            document.getElementById('cancel-btn').onclick = () => {
                // If editing a mixtape, return to that mixtape view
                if (editingMixtapeIdx !== null) {
                    showFriend(editingMixtapeIdx);
                    editingMixtapeIdx = null;
                    return;
                }
                // Normal cancel - return to main
                const filledItems = work.filter(it => it.url && getID(it.url));
                if (filledItems.length < 3) {
                    showModal('You need at least 3 playlists to save. Your changes won\'t be saved.');
                }
                showMain();
            };
            
            document.getElementById('save-btn').onclick = () => {
                const filledItems = work.filter(it => it.url && getID(it.url));
                if (filledItems.length < 3) {
                    showModal('You need at least 3 playlists to save. Add more playlists or your changes won\'t be saved.');
                    return;
                }
                
                // Get title and occasion from edit inputs
                const editTitle = document.getElementById('edit-title').value.trim();
                const editOccasionOpt = document.getElementById('edit-occasion-options').querySelector('.custom-select-option.selected');
                
                // Validate title and occasion
                if (!editTitle) {
                    showModal('Please enter a name for your mixtape');
                    return;
                }
                if (!editOccasionOpt) {
                    showModal('Please select an occasion for your mixtape');
                    return;
                }
                
                const editOccasion = editOccasionOpt.dataset.value;
                const editOccasionIcon = editOccasionOpt.dataset.icon;
                
                // If editing a mixtape, save back to that mixtape
                if (editingMixtapeIdx !== null && mixtapes[editingMixtapeIdx]) {
                    mixtapes[editingMixtapeIdx].playlists = filledItems.map(it => ({
                        url: it.url,
                        title: it.title,
                        img: it.img,
                        desc: it.desc
                    }));
                    // Update title and occasion
                    mixtapes[editingMixtapeIdx].title = editTitle;
                    mixtapes[editingMixtapeIdx].template = editOccasion;
                    mixtapes[editingMixtapeIdx].templateIcon = editOccasionIcon;
                    saveMixtapes();
                    renderSidebarMixtapes();
                    showFriend(editingMixtapeIdx);
                    editingMixtapeIdx = null;
                    return;
                }
                
                // Normal save - update working grid and save title/occasion to cfg
                items = JSON.parse(JSON.stringify(work));
                cfg.workingTitle = editTitle;
                cfg.workingOccasion = editOccasion;
                cfg.workingOccasionIcon = editOccasionIcon;
                save();
                showMain();
            };
            
            document.getElementById('add-btn').onclick = () => {
                if (work.length < 14) {
                    work.push({ url: '', title: '', img: '', desc: '' });
                    renderForm();
                }
            };

            document.querySelectorAll('#cols .seg-btn').forEach(b => {
                b.onclick = () => {
                    cfg.cols = +b.dataset.c;
                    fix();
                    work = JSON.parse(JSON.stringify(items));
                    updateCols();
                    renderForm();
                };
            });

            // Recalculate on resize
            window.addEventListener('resize', () => {
                if (document.getElementById('main').classList.contains('on')) {
                    renderGrid();
                }
                if (document.getElementById('friend').classList.contains('on')) {
                    renderFriendView();
                }
            });
            
            // Mobile tray event handlers
            setupMobileTrays();
        }
        
        /* --------------------------------------------
           MOBILE TRAY HANDLERS
           -------------------------------------------- */
        let mobileTopMode = 'home'; // 'home', 'add', 'mixtapes', 'collab'
        
        function setupMobileTrays() {
            // Top tray icons - clicking toggles that mode, clicking different icon switches to that mode
            document.getElementById('mobile-add-btn').onclick = () => {
                if (mobileTopMode === 'add') {
                    setMobileTopMode('home');
                } else {
                    setMobileTopMode('add');
                }
            };
            
            document.getElementById('mobile-mixtapes-btn').onclick = () => {
                if (mobileTopMode === 'mixtapes') {
                    setMobileTopMode('home');
                } else {
                    setMobileTopMode('mixtapes');
                }
            };
            
            document.getElementById('mobile-collab-btn').onclick = () => {
                if (mobileTopMode === 'collab') {
                    setMobileTopMode('home');
                } else {
                    setMobileTopMode('collab');
                }
            };
            
            // Bottom tray buttons
            document.getElementById('mobile-grid-btn').onclick = () => {
                updateMobileBottomActive('mobile-grid-btn');
                showMain();
            };
            
            document.getElementById('mobile-edit-btn').onclick = () => {
                updateMobileBottomActive('mobile-edit-btn');
                showEdit();
            };
            
            document.getElementById('mobile-share-btn').onclick = () => {
                updateMobileBottomActive('mobile-share-btn');
                showShare();
            };
            
            document.getElementById('mobile-profile-btn').onclick = () => {
                updateMobileBottomActive('mobile-profile-btn');
                showProfile();
            };
            
            document.getElementById('mobile-more-btn').onclick = (e) => {
                e.stopPropagation();
                document.getElementById('mobile-more-menu').classList.toggle('open');
            };
            
            // More menu items
            document.getElementById('mobile-dive-btn').onclick = () => {
                closeMobileMoreMenu();
                updateMobileBottomActive(null);
                showDive();
            };
            
            document.getElementById('mobile-help-btn').onclick = () => {
                closeMobileMoreMenu();
                updateMobileBottomActive(null);
                showHelp();
            };
            
            document.getElementById('mobile-about-btn').onclick = () => {
                closeMobileMoreMenu();
                updateMobileBottomActive(null);
                showAbout();
            };
            
            document.getElementById('mobile-widget-btn').onclick = () => {
                closeMobileMoreMenu();
                updateMobileBottomActive(null);
                showWidget();
            };
            
            // Close more menu when clicking outside
            document.addEventListener('click', () => {
                closeMobileMoreMenu();
            });
            document.getElementById('mobile-more-menu').onclick = (e) => e.stopPropagation();
        }
        
        function renderMobileThemes() {
            const el = document.getElementById('mobile-themes');
            if (!el) return;
            const cur = document.body.dataset.theme || 'light';
            const opts = ['light', 'dark', 'spotify'];
            el.innerHTML = opts.map(t => `<div class="theme-btn ${t===cur?'on':''}" data-t="${t}"><span class="material-symbols-outlined">format_paint</span></div>`).join('');
            el.querySelectorAll('.theme-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    setTheme(btn.dataset.t);
                    // Update all theme buttons across the app
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.toggle('on', b.dataset.t === btn.dataset.t);
                        b.classList.toggle('active', b.dataset.t === btn.dataset.t);
                    });
                };
            });
        }
        
        function closeMobileMoreMenu() {
            document.getElementById('mobile-more-menu').classList.remove('open');
        }
        
        function setMobileTopMode(mode) {
            mobileTopMode = mode;
            
            // Update icon active states
            document.getElementById('mobile-add-btn').classList.toggle('active', mode === 'add');
            document.getElementById('mobile-mixtapes-btn').classList.toggle('active', mode === 'mixtapes');
            document.getElementById('mobile-collab-btn').classList.toggle('active', mode === 'collab');
            
            // Update scroll area content
            renderMobileTopScroll();
        }
        
        function renderMobileTopScroll() {
            const contentEl = document.getElementById('mobile-top-content');
            
            if (mobileTopMode === 'home') {
                contentEl.innerHTML = '';
            } else if (mobileTopMode === 'add') {
                contentEl.innerHTML = '<input type="text" class="mobile-top-paste" id="mobile-paste-input" placeholder="Paste your friends\' mixtapes">';
                const pasteInput = document.getElementById('mobile-paste-input');
                pasteInput.addEventListener('input', () => {
                    const str = pasteInput.value.trim();
                    if (!str) return;
                    
                    const data = parseMixtapeString(str);
                    if (data) {
                        // Add with metadata - routes to Collaborate since it has a name
                        mixtapes.push({
                            name: data.name,
                            title: data.title || '',
                            playlists: data.playlists,
                            added: new Date().toISOString(),
                            starred: false
                        });
                        saveMixtapes();
                        renderMixtapesList();
                        renderSidebarMixtapes();
                        pasteInput.value = '';
                        const label = data.title ? `${data.name}: ${data.title}` : data.name;
                        showModal('Added ' + label + '!');
                        // Switch to collab view to show the new mixtape
                        setMobileTopMode('collab');
                    }
                });
            } else if (mobileTopMode === 'mixtapes') {
                // Show curated mixtapes (ones with template, no name)
                const curated = mixtapes.filter(m => m.template && !m.name);
                if (curated.length === 0) {
                    contentEl.innerHTML = '<span class="mobile-top-placeholder">Saved mixtapes here</span>';
                } else {
                    contentEl.innerHTML = curated.map((m, i) => {
                        const idx = mixtapes.indexOf(m);
                        const label = m.title || 'My Mixtape';
                        const isActive = currentFriendIdx === idx ? ' active' : '';
                        return `<button class="mobile-top-item${isActive}" data-idx="${idx}">${esc(label)}</button>`;
                    }).join('');
                    contentEl.querySelectorAll('.mobile-top-item').forEach(btn => {
                        btn.onclick = () => {
                            showFriend(parseInt(btn.dataset.idx));
                            updateMobileBottomActive(null);
                            renderMobileTopScroll();
                        };
                    });
                }
            } else if (mobileTopMode === 'collab') {
                // Show friend mixtapes (ones with name, no template)
                const friends = mixtapes.filter(m => !m.template || m.name);
                if (friends.length === 0) {
                    contentEl.innerHTML = '<span class="mobile-top-placeholder">Ask a friend</span>';
                } else {
                    contentEl.innerHTML = friends.map((m, i) => {
                        const idx = mixtapes.indexOf(m);
                        const label = m.title ? `${m.name}: ${m.title}` : m.name;
                        const isActive = currentFriendIdx === idx ? ' active' : '';
                        return `<button class="mobile-top-item${isActive}" data-idx="${idx}">${esc(label)}</button>`;
                    }).join('');
                    contentEl.querySelectorAll('.mobile-top-item').forEach(btn => {
                        btn.onclick = () => {
                            showFriend(parseInt(btn.dataset.idx));
                            updateMobileBottomActive(null);
                            renderMobileTopScroll();
                        };
                    });
                }
            }
        }
        
        function updateMobileBottomActive(activeId) {
            document.querySelectorAll('.mobile-bottom-item').forEach(item => {
                item.classList.toggle('active', item.id === activeId);
            });
        }
        
        /* --------------------------------------------
           BROWSER CHECKS & URL IMPORT
           -------------------------------------------- */
        function checkBrowser() {
            const ua = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(ua);
            const isSafari = /Safari/.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(ua);
            const isStandalone = window.navigator.standalone === true;
            
            // Add extra bottom padding for Safari standalone PWA
            if (isStandalone) {
                document.body.classList.add('pwa-standalone');
            }
            
            if (isIOS && !isSafari && !isStandalone) {
                // Show Safari recommendation
                const banner = document.createElement('div');
                banner.className = 'safari-banner';
                banner.innerHTML = `
                    <span>For the best experience, open in Safari and add to your home screen.</span>
                    <button class="safari-close">&times;</button>
                `;
                document.body.prepend(banner);
                banner.querySelector('.safari-close').onclick = () => banner.remove();
            }
        }

        // Check for shared mixtape in URL
        function checkUrlImport() {
            const params = new URLSearchParams(window.location.search);
            const mixtapeData = params.get('m');
            if (mixtapeData) {
                const data = parseMixtapeString(decodeURIComponent(mixtapeData));
                if (data) {
                    // Clear the URL parameter
                    window.history.replaceState({}, '', window.location.pathname);
                    
                    // Show import dialog
                    const label = data.title ? `${data.name}: ${data.title}` : data.name;
                    if (confirm(`Add "${label}" to your mixtapes?`)) {
                        mixtapes.push({
                            name: data.name,
                            title: data.title || '',
                            playlists: data.playlists,
                            added: new Date().toISOString(),
                            starred: false
                        });
                        saveMixtapes();
                        renderMixtapesList();
                        showModal('Added ' + label + '!');
                    }
                }
            }
        }

        /* --------------------------------------------
           MOBILE PHONE DETECTION
           -------------------------------------------- */
        function isMobilePhone() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isPhone = /android.*mobile|iphone|ipod|blackberry|iemobile|opera mini/i.test(ua);
            const isSmallScreen = window.innerWidth <= 480;
            return isPhone || isSmallScreen;
        }
        
        function updateMobileClass() {
            if (isMobilePhone()) {
                document.body.classList.add('mobile-phone');
            } else {
                document.body.classList.remove('mobile-phone');
            }
        }

        /* --------------------------------------------
           WELCOME POPUP (First Visit)
           -------------------------------------------- */
        function checkFirstVisit() {
            const hasVisited = localStorage.getItem('mixtaped_visited');
            if (!hasVisited || !profile.name) {
                document.getElementById('welcome-overlay').classList.add('open');
            }
        }
        
        function dismissWelcome() {
            document.getElementById('welcome-overlay').classList.remove('open');
            localStorage.setItem('mixtaped_visited', 'true');
            // Take user to profile page to complete setup
            showProfile();
        }
        
        document.getElementById('welcome-btn').onclick = dismissWelcome;

        /* --------------------------------------------
           WIDGY WIDGET GENERATOR
           -------------------------------------------- */
        const WidgyGenerator = {
            // Widget size configurations (internal Widgy canvas sizes)
            SIZES: {
                small: { width: 1600, height: 1600, type: 0 },
                medium: { width: 1600, height: 1600, type: 1 },
                large: { width: 1600, height: 1600, type: 2 }
            },
            
            // Density configurations (rows x cols for each size)
            DENSITY: {
                small: {
                    min: { rows: 1, cols: 1, max: 1 },
                    max: { rows: 2, cols: 2, max: 4 }
                },
                medium: {
                    min: { rows: 1, cols: 3, max: 3 },
                    max: { rows: 1, cols: 4, max: 4 }
                },
                large: {
                    min: { rows: 2, cols: 3, max: 6 },
                    max: { rows: 3, cols: 3, max: 9 }
                }
            },
            
            // Style presets
            STYLES: {
                glass: {
                    bgColor: 'uicol_secondarySystemGroupedBackground-60',
                    strokeColor: 'uicol_white-100'
                },
                solid: {
                    bgColor: 'hex_1E1E1E-100',
                    strokeColor: null
                },
                spotify: {
                    bgColor: 'hex_1DB954-100',
                    strokeColor: null
                }
            },
            
            // Create animated value format used by Widgy
            animVal(value, time = 920) {
                return { a: [{ a: value, b: time }], b: 0 };
            },
            
            // Extract Spotify playlist ID from URL
            getSpotifyId(url) {
                if (!url) return null;
                const match = url.match(/playlist[\/:]([a-zA-Z0-9]+)/);
                return match ? match[1] : null;
            },
            
            // Create an image layer for a playlist cover with embedded image
            // Widgy format: z="5" is image layer, "1" is source (0=URL, 1=file), "2" is the reference
            createImageLayer(index, x, y, width, height, imageFilename, cornerRadius = 34) {
                return {
                    z: "5", 
                    s: `Playlist ${index + 1}`, 
                    d0: index,
                    "1": 1,  // 1 = local/embedded file
                    "2": `images/${imageFilename}.jpg`,  // path to image in archive
                    b: this.animVal(x), 
                    c: this.animVal(y),
                    d: this.animVal(width), 
                    e: this.animVal(height),
                    i: this.animVal(cornerRadius), 
                    w: this.animVal(2, 1000)
                };
            },
            
            // Create a widgy blob with embedded images as a ZIP archive (Widgy v1.5 format)
            async createWidgyBlobWithImages(options) {
                const { playlists, images, size = 'medium', density = 'min', style = 'glass', name = 'Mixtaped', author = 'Mixtaped' } = options;
                const sizeConfig = this.SIZES[size];
                const layout = this.calculateLayout(size, density, playlists.length);
                const imageLayers = [];
                const tapLayers = [];
                
                for (let i = 0; i < layout.itemCount; i++) {
                    const playlist = playlists[i];
                    if (!playlist) continue;
                    const row = Math.floor(i / layout.cols);
                    const col = i % layout.cols;
                    const x = layout.startX + (col * (layout.tileSizeW + layout.gapW));
                    const y = layout.startY + (row * (layout.tileSizeH + layout.gapH));
                    
                    if (playlist.imageRef) {
                        // Reference the image filename (without extension for Widgy)
                        imageLayers.push(this.createImageLayer(i, x, y, layout.tileSizeW, layout.tileSizeH, playlist.imageRef, layout.cornerRadius));
                    }
                    if (playlist.url) {
                        tapLayers.push(this.createTapAction(i, x, y, layout.tileSizeW, layout.tileSizeH, playlist.url));
                    }
                }
                
                const layers = [];
                if (tapLayers.length > 0) {
                    layers.push(this.createGroup("Tap Actions", tapLayers, 0, 0, layout.canvasW, layout.canvasH, 150));
                }
                layers.push(this.createGroup("Playlists", imageLayers, 0, 0, layout.canvasW, layout.canvasH, 50));
                layers.push(this.createBackground(layout.canvasW, layout.canvasH, style));
                
                const widgetJson = {
                    "0": 24,
                    "1": layers,
                    "3": name,
                    "5": author,
                    "6": sizeConfig.type,
                    "9": Date.now() % 10000,
                    "20": false,
                    "21": false,
                    "28": true,
                    "a2": 27,
                    "l2": "", "m2": "", "n2": "", "o2": "", "p2": "", "q2": "",
                    "zzz": `mtpd_${size[0]}${density[0]}_${Date.now().toString(36)}`
                };
                
                // Create ZIP archive with JSON and images
                const zip = new JSZip();
                
                // Add widget.json
                zip.file("widget.json", JSON.stringify(widgetJson));
                
                // Add images folder with actual image files (jpg format)
                const imagesFolder = zip.folder("images");
                for (const img of images) {
                    // Widgy expects images without extension in the JSON reference
                    // but the actual files need .jpg extension
                    imagesFolder.file(`${img.id}.jpg`, img.data);
                }
                
                // Generate ZIP blob
                return await zip.generateAsync({ type: "blob", compression: "DEFLATE" });
            },
            
            // Create a tap action layer
            createTapAction(index, x, y, width, height, spotifyUrl) {
                const playlistId = this.getSpotifyId(spotifyUrl);
                const tapUrl = playlistId 
                    ? `openURL_spotify:playlist:${playlistId}`
                    : `openURL_${spotifyUrl}`;
                return {
                    z: "11", s: `Tap ${index + 1}`, d0: 100 + index,
                    "4a": tapUrl,
                    b: this.animVal(x), c: this.animVal(y),
                    d: this.animVal(width), e: this.animVal(height)
                };
            },
            
            // Create a background shape layer
            createBackground(width, height, style = 'glass') {
                const styleConfig = this.STYLES[style] || this.STYLES.glass;
                const layer = {
                    z: "2", s: "Background", d0: -1,
                    d: this.animVal(width), e: this.animVal(height),
                    g: styleConfig.bgColor
                };
                if (styleConfig.strokeColor) layer.k = styleConfig.strokeColor;
                return layer;
            },
            
            // Create a group layer
            createGroup(name, layers, x, y, width, height, zOrder) {
                return {
                    z: "13", s: name, d0: zOrder, "1": layers,
                    b: this.animVal(x), c: this.animVal(y),
                    d: this.animVal(width), e: this.animVal(height),
                    q0: this.animVal(-1, 1019)
                };
            },
            
            // Calculate grid layout for playlists
            calculateLayout(size, density, playlistCount) {
                const sizeConfig = this.SIZES[size];
                const densityConfig = this.DENSITY[size][density];
                const { rows, cols, max } = densityConfig;
                const itemCount = Math.min(playlistCount, max);
                const canvasW = sizeConfig.width;
                const canvasH = sizeConfig.height;
                
                // For medium widgets, the 1600x1600 canvas displays as 2:1
                // So we need to account for horizontal squish by making tiles and gaps wider
                const aspectRatio = size === 'medium' ? 2 : 1;
                
                const padding = size === 'small' ? 20 : 40;
                const baseGap = size === 'small' ? 10 : 20;
                const gapH = baseGap; // Vertical gap stays normal
                const gapW = baseGap * aspectRatio; // Horizontal gap needs to be wider for medium
                
                const availW = canvasW - (padding * 2 * aspectRatio);
                const availH = canvasH - (padding * 2);
                
                // Calculate tile size based on available space
                const tileW = (availW - (gapW * (cols - 1))) / cols;
                const tileH = (availH - (gapH * (rows - 1))) / rows;
                
                // For medium, tiles are wider to appear square when squished
                let tileSizeW, tileSizeH;
                if (size === 'medium') {
                    tileSizeH = Math.min(tileH, tileW / aspectRatio);
                    tileSizeW = tileSizeH * aspectRatio;
                } else {
                    const tileSize = Math.min(tileW, tileH);
                    tileSizeW = tileSize;
                    tileSizeH = tileSize;
                }
                
                const gridW = (tileSizeW * cols) + (gapW * (cols - 1));
                const gridH = (tileSizeH * rows) + (gapH * (rows - 1));
                const startX = (canvasW - gridW) / 2;
                const startY = (canvasH - gridH) / 2;
                const cornerRadius = Math.round(tileSizeH * 0.15 * aspectRatio);
                return { canvasW, canvasH, tileSizeW, tileSizeH, rows, cols, gapW, gapH, startX, startY, cornerRadius, maxItems: max, itemCount };
            },
            
            // Generate the complete Widgy widget JSON
            generateWidget(options) {
                const { playlists, size = 'medium', density = 'min', style = 'glass', name = 'Mixtaped', author = 'Mixtaped' } = options;
                const sizeConfig = this.SIZES[size];
                const layout = this.calculateLayout(size, density, playlists.length);
                const imageLayers = [];
                const tapLayers = [];
                
                for (let i = 0; i < layout.itemCount; i++) {
                    const playlist = playlists[i];
                    if (!playlist) continue;
                    const row = Math.floor(i / layout.cols);
                    const col = i % layout.cols;
                    const x = layout.startX + (col * (layout.tileSizeW + layout.gapW));
                    const y = layout.startY + (row * (layout.tileSizeH + layout.gapH));
                    // Use embedded base64 image data
                    if (playlist.base64) {
                        imageLayers.push(this.createImageLayer(i, x, y, layout.tileSizeW, layout.tileSizeH, playlist.base64, layout.cornerRadius));
                    }
                    if (playlist.url) {
                        tapLayers.push(this.createTapAction(i, x, y, layout.tileSizeW, layout.tileSizeH, playlist.url));
                    }
                }
                
                const layers = [];
                if (tapLayers.length > 0) {
                    layers.push(this.createGroup("Tap Actions", tapLayers, 0, 0, layout.canvasW, layout.canvasH, 150));
                }
                layers.push(this.createGroup("Playlists", imageLayers, 0, 0, layout.canvasW, layout.canvasH, 50));
                layers.push(this.createBackground(layout.canvasW, layout.canvasH, style));
                
                return {
                    "0": 24, "1": layers, "3": name, "5": author, "6": sizeConfig.type,
                    "9": Date.now() % 10000, "20": false, "21": false, "28": true, "a2": 27,
                    "l2": "", "m2": "", "n2": "", "o2": "", "p2": "", "q2": "",
                    "zzz": `mtpd_${size[0]}${density[0]}_${Date.now().toString(36)}`
                };
            },
            
            // Compress and create downloadable blob
            async createWidgyBlob(options) {
                const widget = this.generateWidget(options);
                const jsonStr = JSON.stringify(widget);
                
                // Use pako for raw deflate compression
                if (typeof pako !== 'undefined') {
                    const compressed = pako.deflateRaw(jsonStr);
                    return new Blob([compressed], { type: 'application/octet-stream' });
                }
                
                // Fallback to CompressionStream if pako not available
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonStr);
                const cs = new CompressionStream('deflate-raw');
                const writer = cs.writable.getWriter();
                writer.write(data);
                writer.close();
                
                const chunks = [];
                const reader = cs.readable.getReader();
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                }
                
                const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
                const result = new Uint8Array(totalLength);
                let offset = 0;
                for (const chunk of chunks) {
                    result.set(chunk, offset);
                    offset += chunk.length;
                }
                
                return new Blob([result], { type: 'application/octet-stream' });
            },
            
            // Get layout description for UI
            getLayoutDescription(size, density) {
                const layout = this.DENSITY[size][density];
                const total = layout.rows * layout.cols;
                if (layout.rows === 1) {
                    return `Shows ${total} playlist${total > 1 ? 's' : ''} in a row`;
                }
                return `Shows ${total} playlists in a ${layout.cols}×${layout.rows} grid`;
            }
        };
        
        /* --------------------------------------------
           WIDGET VIEW HANDLERS
           -------------------------------------------- */
        function showWidget() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
            document.getElementById('widget').classList.add('on');
            populateWidgetSources();
            updateWidgetInfo();
            updateMobileHomeActive(false);
        }
        
        function getWidgetSettings() {
            const source = document.querySelector('#widget-source-options .selected')?.dataset.value || 'current';
            const size = document.querySelector('#widget-size-options .selected')?.dataset.value || 'medium';
            const style = document.querySelector('#widget-style-options .selected')?.dataset.value || 'glass';
            const density = document.querySelector('#widget-density-options .selected')?.dataset.value || 'min';
            return { source, size, style, density };
        }
        
        function getWidgetPlaylists(source) {
            if (source === 'current') {
                return items.filter(it => it.url && getID(it.url)).map(it => ({ url: it.url, title: it.title, img: it.img }));
            }
            // Check curated mixtapes
            const curated = JSON.parse(localStorage.getItem('mixtaped_curated') || '[]');
            const curatedMatch = curated.find(m => m.id === source);
            if (curatedMatch) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(curatedMatch.code)));
                    return data.p.map(p => ({ url: p.u, title: p.t, img: p.i }));
                } catch(e) { return []; }
            }
            // Check collected mixtapes
            const collected = JSON.parse(localStorage.getItem('mixtaped_collected') || '[]');
            const collectedMatch = collected.find(m => m.id === source);
            if (collectedMatch) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(collectedMatch.code)));
                    return data.p.map(p => ({ url: p.u, title: p.t, img: p.i }));
                } catch(e) { return []; }
            }
            // Check collaborated mixtapes
            const collabs = JSON.parse(localStorage.getItem('mixtaped_collabs') || '[]');
            const collabMatch = collabs.find(m => m.id === source);
            if (collabMatch) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(collabMatch.code)));
                    return data.p.map(p => ({ url: p.u, title: p.t, img: p.i }));
                } catch(e) { return []; }
            }
            return [];
        }
        
        function populateWidgetSources() {
            const optionsEl = document.getElementById('widget-source-options');
            let html = '<div class="custom-select-option selected" data-value="current">My Mixtape</div>';
            
            // Add curated mixtapes
            const curated = JSON.parse(localStorage.getItem('mixtaped_curated') || '[]');
            if (curated.length > 0) {
                curated.forEach(m => {
                    html += `<div class="custom-select-option" data-value="${m.id}">${m.title || 'Untitled'}</div>`;
                });
            }
            
            // Add collected mixtapes
            const collected = JSON.parse(localStorage.getItem('mixtaped_collected') || '[]');
            if (collected.length > 0) {
                collected.forEach(m => {
                    html += `<div class="custom-select-option" data-value="${m.id}">${m.title || m.name || 'Collected'}</div>`;
                });
            }
            
            // Add collaborated mixtapes
            const collabs = JSON.parse(localStorage.getItem('mixtaped_collabs') || '[]');
            if (collabs.length > 0) {
                collabs.forEach(m => {
                    html += `<div class="custom-select-option" data-value="${m.id}">${m.title || m.name || 'Collab'}</div>`;
                });
            }
            
            optionsEl.innerHTML = html;
            
            // Re-attach click handlers
            optionsEl.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    optionsEl.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('widget-source-label').textContent = opt.textContent;
                    optionsEl.classList.remove('open');
                };
            });
        }
        
        function updateWidgetInfo() {
            const { size, density } = getWidgetSettings();
            const desc = WidgyGenerator.getLayoutDescription(size, density);
            const sizeLabel = size.charAt(0).toUpperCase() + size.slice(1);
            const densityLabel = density === 'min' ? 'Standard' : 'Compact';
            document.getElementById('widget-info').innerHTML = 
                `<p class="section-desc" style="margin: 0;"><span style="font-weight: 600;">${sizeLabel} ${densityLabel}:</span> ${desc}</p>`;
        }
        
        function setupWidgetPage() {
            // Source dropdown
            const sourceBtn = document.getElementById('widget-source-btn');
            const sourceOptions = document.getElementById('widget-source-options');
            sourceBtn.onclick = (e) => { e.stopPropagation(); sourceOptions.classList.toggle('open'); };
            
            // Size dropdown
            const sizeBtn = document.getElementById('widget-size-btn');
            const sizeOptions = document.getElementById('widget-size-options');
            sizeBtn.onclick = (e) => { e.stopPropagation(); sizeOptions.classList.toggle('open'); };
            sizeOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    sizeOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('widget-size-label').textContent = opt.textContent;
                    sizeOptions.classList.remove('open');
                    updateWidgetInfo();
                };
            });
            
            // Style dropdown
            const styleBtn = document.getElementById('widget-style-btn');
            const styleOptions = document.getElementById('widget-style-options');
            styleBtn.onclick = (e) => { e.stopPropagation(); styleOptions.classList.toggle('open'); };
            styleOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    styleOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('widget-style-label').textContent = opt.textContent;
                    styleOptions.classList.remove('open');
                };
            });
            
            // Density dropdown
            const densityBtn = document.getElementById('widget-density-btn');
            const densityOptions = document.getElementById('widget-density-options');
            densityBtn.onclick = (e) => { e.stopPropagation(); densityOptions.classList.toggle('open'); };
            densityOptions.querySelectorAll('.custom-select-option').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    densityOptions.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    document.getElementById('widget-density-label').textContent = opt.textContent;
                    densityOptions.classList.remove('open');
                    updateWidgetInfo();
                };
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                sourceOptions.classList.remove('open');
                sizeOptions.classList.remove('open');
                styleOptions.classList.remove('open');
                densityOptions.classList.remove('open');
            });
            
            // Generate button
            document.getElementById('widget-generate-btn').onclick = async () => {
                const { source, size, style, density } = getWidgetSettings();
                console.log('Widget settings:', { source, size, style, density });
                const playlists = getWidgetPlaylists(source);
                console.log('Playlists:', playlists);
                
                if (playlists.length < 3) {
                    showModal('You need at least 3 playlists to create a widget. Add more playlists to your mixtape.');
                    return;
                }
                
                // Show loading state
                const btn = document.getElementById('widget-generate-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Fetching images...';
                btn.disabled = true;
                
                try {
                    // Fetch all images as binary data
                    const images = [];
                    const playlistsWithRefs = [];
                    
                    for (let i = 0; i < playlists.length; i++) {
                        const playlist = playlists[i];
                        if (!playlist.img) {
                            playlistsWithRefs.push({ ...playlist, imageRef: null });
                            continue;
                        }
                        
                        try {
                            console.log(`Fetching image ${i}: ${playlist.img}`);
                            const response = await fetch(playlist.img);
                            if (!response.ok) throw new Error(`HTTP ${response.status}`);
                            
                            const arrayBuffer = await response.arrayBuffer();
                            const imageData = new Uint8Array(arrayBuffer);
                            const imageId = `img_${i}`;
                            
                            images.push({ id: imageId, data: imageData });
                            playlistsWithRefs.push({ ...playlist, imageRef: imageId });
                            console.log(`Image ${i} fetched: ${imageData.length} bytes`);
                        } catch (e) {
                            console.error(`Failed to fetch image ${i}:`, e);
                            playlistsWithRefs.push({ ...playlist, imageRef: null });
                        }
                    }
                    
                    console.log(`Fetched ${images.length} images`);
                    btn.textContent = 'Building widget...';
                    
                    // Create widget blob with embedded images
                    const blob = await WidgyGenerator.createWidgyBlobWithImages({
                        playlists: playlistsWithRefs,
                        images: images,
                        size, style, density,
                        name: 'Mixtaped', author: 'Mixtaped'
                    });
                    
                    const url = URL.createObjectURL(blob);
                    const filename = `mixtaped_${size}_${density}.widgy`;
                    
                    // Show download in modal popup
                    showModal(`
                        <div style="text-align: center;">
                            <p style="margin-bottom: 16px;">Your widget is ready!</p>
                            <a href="${url}" download="${filename}" class="action-btn full" style="display: inline-block; margin-bottom: 12px;">Download ${filename}</a>
                            <p class="section-desc">Import the file into Widgy</p>
                        </div>
                    `);
                    
                } catch (err) {
                    showModal('Could not generate widget: ' + err.message);
                    console.error(err);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            };
            
            // Back button
            document.getElementById('widget-back-btn').onclick = showMain;
        }

        /* --------------------------------------------
           INITIALIZE APP
           -------------------------------------------- */
        updateMobileClass();
        window.addEventListener('resize', updateMobileClass);
        load();
        setup();
        setupWidgetPage();
        renderGrid();
        checkBrowser();
     </script>
</body>
</html>
